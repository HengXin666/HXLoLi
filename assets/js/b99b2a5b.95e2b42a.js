"use strict";(self.webpackChunkhx_loli=self.webpackChunkhx_loli||[]).push([[48847],{2164:(n,e,d)=>{d.d(e,{A:()=>s});const s=d.p+"assets/images/Clip_2024-07-12_16-03-19-8029a2a6d7e381878fd03cb0f023b0bf.png"},28453:(n,e,d)=>{d.d(e,{R:()=>r,x:()=>l});var s=d(96540);const t={},c=s.createContext(t);function r(n){const e=s.useContext(c);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:r(n.components),s.createElement(c.Provider,{value:e},n.children)}},63533:(n,e,d)=>{d.r(e),d.d(e,{assets:()=>i,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"\u7a0b\u5e8f\u8bed\u8a00/C++/\u73b0\u4ee3C++/\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b/index","title":"\u4e94\u3001C++11\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b","description":"| ##container## |","source":"@site/docs/002-\u7a0b\u5e8f\u8bed\u8a00/001-C++/003-\u73b0\u4ee3C++/002-\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/005-\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b/index.md","sourceDirName":"002-\u7a0b\u5e8f\u8bed\u8a00/001-C++/003-\u73b0\u4ee3C++/002-\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/005-\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b","slug":"/\u7a0b\u5e8f\u8bed\u8a00/C++/\u73b0\u4ee3C++/\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b/","permalink":"/HXLoLi/docs/\u7a0b\u5e8f\u8bed\u8a00/C++/\u73b0\u4ee3C++/\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b/","draft":false,"unlisted":false,"editUrl":"https://github.com/HengXin666/HXLoLi/edit/main/docs/002-\u7a0b\u5e8f\u8bed\u8a00/001-C++/003-\u73b0\u4ee3C++/002-\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/005-\u4e94\u3001C++\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b/index.md","tags":[],"version":"current","lastUpdatedBy":"Heng_Xin_666","lastUpdatedAt":1745851959000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u56db\u3001\u4ece\u6c47\u7f16\u89d2\u5ea6\u770b\u7f16\u8bd1\u5668\u4f18\u5316","permalink":"/HXLoLi/docs/\u7a0b\u5e8f\u8bed\u8a00/C++/\u73b0\u4ee3C++/\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/\u56db\u3001\u4ece\u6c47\u7f16\u89d2\u5ea6\u770b\u7f16\u8bd1\u5668\u4f18\u5316/"},"next":{"title":"\u516d\u3001\u7406\u89e3\u5e38\u7528\u5e76\u884c\u7b97\u6cd5\u53ca\u5176\u5b9e\u73b0\u539f\u7406","permalink":"/HXLoLi/docs/\u7a0b\u5e8f\u8bed\u8a00/C++/\u73b0\u4ee3C++/\u9ad8\u6027\u80fd\u5e76\u884c\u7f16\u7a0b\u4e0e\u4f18\u5316/\u516d\u3001\u7406\u89e3\u5e38\u7528\u5e76\u884c\u7b97\u6cd5\u53ca\u5176\u5b9e\u73b0\u539f\u7406/"}}');var t=d(74848),c=d(28453);const r={},l="\u4e94\u3001C++11\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b",i={},o=[{value:"5.0 \u7b2c0\u7ae0: \u65f6\u95f4",id:"50-\u7b2c0\u7ae0-\u65f6\u95f4",level:2},{value:"5.0.1 C \u8bed\u8a00\u5982\u4f55\u5904\u7406\u65f6\u95f4: time.h",id:"501-c-\u8bed\u8a00\u5982\u4f55\u5904\u7406\u65f6\u95f4-timeh",level:3},{value:"5.0.2 C++11 \u5f15\u5165\u7684\u65f6\u95f4\u6807\u51c6\u5e93: std::chrono",id:"502-c11-\u5f15\u5165\u7684\u65f6\u95f4\u6807\u51c6\u5e93-stdchrono",level:3},{value:"5.0.3 \u6848\u4f8b: \u8ba1\u7b97\u82b1\u8d39\u7684\u65f6\u95f4",id:"503-\u6848\u4f8b-\u8ba1\u7b97\u82b1\u8d39\u7684\u65f6\u95f4",level:3},{value:"5.0.4 \u65f6\u95f4\u6bb5: \u4f5c\u4e3a double \u7c7b\u578b",id:"504-\u65f6\u95f4\u6bb5-\u4f5c\u4e3a-double-\u7c7b\u578b",level:3},{value:"5.0.5 \u8de8\u5e73\u53f0\u7684 sleep: std::this_thread::sleep_for",id:"505-\u8de8\u5e73\u53f0\u7684-sleep-stdthis_threadsleep_for",level:3},{value:"5.0.6 \u7761\u5230\u65f6\u95f4\u70b9: std::this_thread::sleep_until",id:"506-\u7761\u5230\u65f6\u95f4\u70b9-stdthis_threadsleep_until",level:3},{value:"5.1 \u7b2c1\u7ae0: \u7ebf\u7a0b",id:"51-\u7b2c1\u7ae0-\u7ebf\u7a0b",level:2},{value:"5.1.1 \u8fdb\u7a0b\u4e0e\u7ebf\u7a0b",id:"511-\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b",level:3},{value:"5.1.2 \u4e3a\u4ec0\u4e48\u9700\u8981\u591a\u7ebf\u7a0b: \u65e0\u963b\u585e\u591a\u4efb\u52a1",id:"512-\u4e3a\u4ec0\u4e48\u9700\u8981\u591a\u7ebf\u7a0b-\u65e0\u963b\u585e\u591a\u4efb\u52a1",level:3},{value:"5.1.3 \u6ca1\u6709\u591a\u7ebf\u7a0b: \u7a0b\u5e8f\u672a\u54cd\u5e94",id:"513-\u6ca1\u6709\u591a\u7ebf\u7a0b-\u7a0b\u5e8f\u672a\u54cd\u5e94",level:3},{value:"5.1.4 \u73b0\u4ee3 C++ \u4e2d\u7684\u591a\u7ebf\u7a0b: std::thread",id:"514-\u73b0\u4ee3-c-\u4e2d\u7684\u591a\u7ebf\u7a0b-stdthread",level:3},{value:"5.1.5 \u9519\u8bef: \u627e\u4e0d\u5230\u7b26\u53f7 pthread_create",id:"515-\u9519\u8bef-\u627e\u4e0d\u5230\u7b26\u53f7-pthread_create",level:3},{value:"5.1.6 \u6709\u4e86\u591a\u7ebf\u7a0b: \u5f02\u6b65\u5904\u7406\u8bf7\u6c42",id:"516-\u6709\u4e86\u591a\u7ebf\u7a0b-\u5f02\u6b65\u5904\u7406\u8bf7\u6c42",level:3},{value:"5.1.7 \u4e3b\u7ebf\u7a0b\u7b49\u5f85\u5b50\u7ebf\u7a0b\u7ed3\u675f: t1.join()",id:"517-\u4e3b\u7ebf\u7a0b\u7b49\u5f85\u5b50\u7ebf\u7a0b\u7ed3\u675f-t1join",level:3},{value:"5.1.8 std::thread \u7684\u89e3\u6784\u51fd\u6570\u4f1a\u9500\u6bc1\u7ebf\u7a0b",id:"518-stdthread-\u7684\u89e3\u6784\u51fd\u6570\u4f1a\u9500\u6bc1\u7ebf\u7a0b",level:3},{value:"5.1.9 \u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b: t1.detach()",id:"519-\u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b-t1detach",level:3},{value:"5.1.10 \u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b: \u79fb\u52a8\u5230\u5168\u5c40\u7ebf\u7a0b\u6c60",id:"5110-\u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b-\u79fb\u52a8\u5230\u5168\u5c40\u7ebf\u7a0b\u6c60",level:3},{value:"5.1.11 main \u51fd\u6570\u9000\u51fa\u540e\u81ea\u52a8 join \u5168\u90e8\u7ebf\u7a0b (\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f)",id:"5111-main-\u51fd\u6570\u9000\u51fa\u540e\u81ea\u52a8-join-\u5168\u90e8\u7ebf\u7a0b-\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f",level:3},{value:"5.1.12 std::jthread: \u7b26\u5408 RAII \u601d\u60f3\uff0c\u89e3\u6784\u65f6\u81ea\u52a8 join()",id:"5112-stdjthread-\u7b26\u5408-raii-\u601d\u60f3\u89e3\u6784\u65f6\u81ea\u52a8-join",level:3},{value:"5.2 \u7b2c2\u7ae0: \u5f02\u6b65",id:"52-\u7b2c2\u7ae0-\u5f02\u6b65",level:2},{value:"5.2.1 \u5f02\u6b65\u597d\u5e2e\u624b: std::async",id:"521-\u5f02\u6b65\u597d\u5e2e\u624b-stdasync",level:3},{value:"5.2.2 \u663e\u793a\u5730\u7b49\u5f85: wait()",id:"522-\u663e\u793a\u5730\u7b49\u5f85-wait",level:3},{value:"5.2.3 \u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4: wait_for()",id:"523-\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4-wait_for",level:3},{value:"5.2.4 \u53e6\u4e00\u79cd\u7528\u6cd5: std::launch::deferred \u505a\u53c2\u6570",id:"524-\u53e6\u4e00\u79cd\u7528\u6cd5-stdlaunchdeferred-\u505a\u53c2\u6570",level:3},{value:"5.2.5 std::async \u7684\u5e95\u5c42\u5b9e\u73b0: std::promise",id:"525-stdasync-\u7684\u5e95\u5c42\u5b9e\u73b0-stdpromise",level:3},{value:"5.2.6 std::future \u5c0f\u8d34\u58eb",id:"526-stdfuture-\u5c0f\u8d34\u58eb",level:3},{value:"5.3 \u7b2c3\u7ae0: \u4e92\u65a5\u91cf",id:"53-\u7b2c3\u7ae0-\u4e92\u65a5\u91cf",level:2},{value:"5.3.1 \u591a\u7ebf\u7a0b\u6253\u67b6\u6848\u4f8b",id:"531-\u591a\u7ebf\u7a0b\u6253\u67b6\u6848\u4f8b",level:3},{value:"5.3.2 std::mutex: \u4e0a\u9501\uff0c\u9632\u6b62\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fdb\u5165\u67d0\u4e00\u4ee3\u7801\u6bb5",id:"532-stdmutex-\u4e0a\u9501\u9632\u6b62\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fdb\u5165\u67d0\u4e00\u4ee3\u7801\u6bb5",level:3},{value:"5.3.3 std::lock_guard: \u7b26\u5408 RAII \u601d\u60f3\u7684\u4e0a\u9501\u548c\u89e3\u9501",id:"533-stdlock_guard-\u7b26\u5408-raii-\u601d\u60f3\u7684\u4e0a\u9501\u548c\u89e3\u9501",level:3},{value:"5.3.4 std::unique_lock: \u4e5f\u7b26\u5408 RAII \u601d\u60f3\uff0c\u4f46\u81ea\u7531\u5ea6\u66f4\u9ad8",id:"534-stdunique_lock-\u4e5f\u7b26\u5408-raii-\u601d\u60f3\u4f46\u81ea\u7531\u5ea6\u66f4\u9ad8",level:3},{value:"5.3.5 std::unique_lock: \u7528 std::defer_lock \u4f5c\u4e3a\u53c2\u6570",id:"535-stdunique_lock-\u7528-stddefer_lock-\u4f5c\u4e3a\u53c2\u6570",level:3},{value:"5.3.6 \u591a\u4e2a\u5bf9\u8c61? \u6bcf\u4e2a\u5bf9\u8c61\u4e00\u4e2a mutex \u5373\u53ef",id:"536-\u591a\u4e2a\u5bf9\u8c61-\u6bcf\u4e2a\u5bf9\u8c61\u4e00\u4e2a-mutex-\u5373\u53ef",level:3},{value:"5.3.7 \u5982\u679c\u4e0a\u9501\u5931\u8d25\uff0c\u4e0d\u8981\u7b49\u5f85: try_lock()",id:"537-\u5982\u679c\u4e0a\u9501\u5931\u8d25\u4e0d\u8981\u7b49\u5f85-try_lock",level:3},{value:"5.3.8 \u53ea\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4: try_lock_for()",id:"538-\u53ea\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4-try_lock_for",level:3},{value:"5.3.9 std::unique_lock: \u7528 std::try_to_lock \u505a\u53c2\u6570",id:"539-stdunique_lock-\u7528-stdtry_to_lock-\u505a\u53c2\u6570",level:3},{value:"5.3.10 std::unique_lock: \u7528 std::adopt_lock \u505a\u53c2\u6570",id:"5310-stdunique_lock-\u7528-stdadopt_lock-\u505a\u53c2\u6570",level:3},{value:"5.3.11 std::unique_lock \u548c std::mutex \u5177\u6709\u540c\u6837\u7684\u63a5\u53e3",id:"5311-stdunique_lock-\u548c-stdmutex-\u5177\u6709\u540c\u6837\u7684\u63a5\u53e3",level:3},{value:"5.4 \u7b2c4\u7ae0: \u6b7b\u9501",id:"54-\u7b2c4\u7ae0-\u6b7b\u9501",level:2},{value:"5.4.1 \u540c\u65f6\u9501\u4f4f\u591a\u4e2a mutex: \u6b7b\u9501\u96be\u9898",id:"541-\u540c\u65f6\u9501\u4f4f\u591a\u4e2a-mutex-\u6b7b\u9501\u96be\u9898",level:3},{value:"5.4.2 \u89e3\u51b31: \u6c38\u8fdc\u4e0d\u8981\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501",id:"542-\u89e3\u51b31-\u6c38\u8fdc\u4e0d\u8981\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501",level:3},{value:"5.4.3 \u89e3\u51b32: \u4fdd\u8bc1\u53cc\u65b9\u4e0a\u9501\u987a\u5e8f\u4e00\u81f4",id:"543-\u89e3\u51b32-\u4fdd\u8bc1\u53cc\u65b9\u4e0a\u9501\u987a\u5e8f\u4e00\u81f4",level:3},{value:"5.4.4 \u89e3\u51b33: \u7528 std::lock \u540c\u65f6\u5bf9\u591a\u4e2a\u4e0a\u9501",id:"544-\u89e3\u51b33-\u7528-stdlock-\u540c\u65f6\u5bf9\u591a\u4e2a\u4e0a\u9501",level:3},{value:"5.4.5 std::lock \u7684 RAII \u7248\u672c: std::scoped_lock",id:"545-stdlock-\u7684-raii-\u7248\u672c-stdscoped_lock",level:3},{value:"5.4.6 \u540c\u4e00\u4e2a\u7ebf\u7a0b\u91cd\u590d\u8c03\u7528 lock() \u4e5f\u4f1a\u9020\u6210\u6b7b\u9501",id:"546-\u540c\u4e00\u4e2a\u7ebf\u7a0b\u91cd\u590d\u8c03\u7528-lock-\u4e5f\u4f1a\u9020\u6210\u6b7b\u9501",level:3},{value:"5.4.7 \u89e3\u51b31: other \u91cc\u4e0d\u8981\u518d\u4e0a\u9501",id:"547-\u89e3\u51b31-other-\u91cc\u4e0d\u8981\u518d\u4e0a\u9501",level:3},{value:"5.4.8 \u89e3\u51b32: \u6539\u7528 std::recursive_mutex",id:"548-\u89e3\u51b32-\u6539\u7528-stdrecursive_mutex",level:3},{value:"5.5 \u7b2c5\u7ae0: \u6570\u636e\u7ed3\u6784",id:"55-\u7b2c5\u7ae0-\u6570\u636e\u7ed3\u6784",level:2},{value:"5.5.1 \u6848\u4f8b: \u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u4f7f\u7528 std::vector",id:"551-\u6848\u4f8b-\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u4f7f\u7528-stdvector",level:3},{value:"5.5.2 \u903b\u8f91\u4e0a const \u800c\u90e8\u5206\u6210\u5458\u975e const: mutable",id:"552-\u903b\u8f91\u4e0a-const-\u800c\u90e8\u5206\u6210\u5458\u975e-const-mutable",level:3},{value:"5.5.3 \u4e3a\u4ec0\u4e48\u9700\u8981\u8bfb\u5199\u9501",id:"553-\u4e3a\u4ec0\u4e48\u9700\u8981\u8bfb\u5199\u9501",level:3},{value:"5.5.4 \u8bfb\u5199\u9501: shared_mutex",id:"554-\u8bfb\u5199\u9501-shared_mutex",level:3},{value:"5.5.5 std::shared_lock: \u7b26\u5408 RAII \u601d\u60f3\u7684 lock_shared()",id:"555-stdshared_lock-\u7b26\u5408-raii-\u601d\u60f3\u7684-lock_shared",level:3},{value:"5.5.6 \u53ea\u9700\u4e00\u6b21\u6027\u4e0a\u9501\uff0c\u4e14\u7b26\u5408 RAII \u601d\u60f3: \u8bbf\u95ee\u8005\u6a21\u5f0f",id:"556-\u53ea\u9700\u4e00\u6b21\u6027\u4e0a\u9501\u4e14\u7b26\u5408-raii-\u601d\u60f3-\u8bbf\u95ee\u8005\u6a21\u5f0f",level:3},{value:"5.6 \u7b2c6\u7ae0: \u6761\u4ef6\u53d8\u91cf",id:"56-\u7b2c6\u7ae0-\u6761\u4ef6\u53d8\u91cf",level:2},{value:"5.6.1 \u6761\u4ef6\u53d8\u91cf: \u7b49\u5f85\u88ab\u5524\u9192",id:"561-\u6761\u4ef6\u53d8\u91cf-\u7b49\u5f85\u88ab\u5524\u9192",level:3},{value:"5.6.2 \u6761\u4ef6\u53d8\u91cf: \u7b49\u5f85\u67d0\u4e00\u6761\u4ef6\u6210\u771f",id:"562-\u6761\u4ef6\u53d8\u91cf-\u7b49\u5f85\u67d0\u4e00\u6761\u4ef6\u6210\u771f",level:3},{value:"5.6.3 \u6761\u4ef6\u53d8\u91cf: \u591a\u4e2a\u7b49\u5f85\u8005",id:"563-\u6761\u4ef6\u53d8\u91cf-\u591a\u4e2a\u7b49\u5f85\u8005",level:3},{value:"5.6.4 \u6848\u4f8b: \u5b9e\u73b0\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u5f0f",id:"564-\u6848\u4f8b-\u5b9e\u73b0\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u5f0f",level:3},{value:"5.6.5 \u6761\u4ef6\u53d8\u91cf: \u5c06 foods \u961f\u5217\u5c01\u88c5\u6210\u7c7b",id:"565-\u6761\u4ef6\u53d8\u91cf-\u5c06-foods-\u961f\u5217\u5c01\u88c5\u6210\u7c7b",level:3},{value:"5.6.6 std::condition_variable \u5c0f\u8d34\u58eb",id:"566-stdcondition_variable-\u5c0f\u8d34\u58eb",level:3},{value:"5.7 \u7b2c7\u7ae0: \u539f\u5b50\u64cd\u4f5c",id:"57-\u7b2c7\u7ae0-\u539f\u5b50\u64cd\u4f5c",level:2},{value:"5.7.1 \u7ecf\u5178\u6848\u4f8b: \u591a\u4e2a\u7ebf\u7a0b\u4fee\u6539\u540c\u4e00\u4e2a\u8ba1\u6570\u5668",id:"571-\u7ecf\u5178\u6848\u4f8b-\u591a\u4e2a\u7ebf\u7a0b\u4fee\u6539\u540c\u4e00\u4e2a\u8ba1\u6570\u5668",level:3},{value:"5.7.2 \u66b4\u529b\u89e3\u51b3: \u7528 mutex \u4e0a\u9501",id:"572-\u66b4\u529b\u89e3\u51b3-\u7528-mutex-\u4e0a\u9501",level:3},{value:"5.7.3 \u5efa\u8bae\u7528 atomic: \u6709\u4e13\u95e8\u7684\u786c\u4ef6\u6307\u4ee4\u52a0\u6301",id:"573-\u5efa\u8bae\u7528-atomic-\u6709\u4e13\u95e8\u7684\u786c\u4ef6\u6307\u4ee4\u52a0\u6301",level:3},{value:"5.7.4 \u6ce8\u610f: \u8bf7\u7528 +=\uff0c\u4e0d\u8981\u8ba9 + \u548c = \u5206\u5f00",id:"574-\u6ce8\u610f-\u8bf7\u7528-\u4e0d\u8981\u8ba9--\u548c--\u5206\u5f00",level:3},{value:"5.7.5 fetch_add: \u548c += \u7b49\u4ef7",id:"575-fetch_add-\u548c--\u7b49\u4ef7",level:3},{value:"5.7.6 fetch_add: \u4f1a\u8fd4\u56de\u5176\u65e7\u503c",id:"576-fetch_add-\u4f1a\u8fd4\u56de\u5176\u65e7\u503c",level:3},{value:"5.7.7 exchange: \u8bfb\u53d6\u7684\u540c\u65f6\u5199\u5165",id:"577-exchange-\u8bfb\u53d6\u7684\u540c\u65f6\u5199\u5165",level:3},{value:"5.7.8 compare_exchange_strong: \u8bfb\u53d6\uff0c\u6bd4\u8f83\u662f\u5426\u76f8\u7b49\uff0c\u76f8\u7b49\u5219\u5199\u5165",id:"578-compare_exchange_strong-\u8bfb\u53d6\u6bd4\u8f83\u662f\u5426\u76f8\u7b49\u76f8\u7b49\u5219\u5199\u5165",level:3},{value:"5.7.9 \u65b9\u4fbf\u7406\u89e3\u7684\u4f2a\u4ee3\u7801",id:"579-\u65b9\u4fbf\u7406\u89e3\u7684\u4f2a\u4ee3\u7801",level:3},{value:"5.8 \u56de\u5bb6\u4f5c\u4e1a",id:"58-\u56de\u5bb6\u4f5c\u4e1a",level:2},{value:"\u4f5c\u4e1a\u8981\u6c42",id:"\u4f5c\u4e1a\u8981\u6c42",level:3},{value:"\u5173\u4e8e\u5185\u5377",id:"\u5173\u4e8e\u5185\u5377",level:3}];function a(n){const e={a:"a",code:"code",del:"del",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",span:"span",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"\u4e94c11\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b",children:"\u4e94\u3001C++11\u5f00\u59cb\u7684\u591a\u7ebf\u7a0b\u7f16\u7a0b"})}),"\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsx)(e.tr,{children:(0,t.jsx)(e.th,{style:{textAlign:"center"},children:"##container##"})})}),(0,t.jsx)(e.tbody,{children:(0,t.jsx)(e.tr,{children:(0,t.jsx)(e.td,{style:{textAlign:"center"},children:(0,t.jsx)(e.img,{alt:"Clip_2024-07-12_16-03-19.png ##w600##",src:d(2164).A+"",width:"1139",height:"1106"})})})})]}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.del,{children:"\u867d\u7136\u4e4b\u524d\u5df2\u7ecf\u5199\u8fc7\u90e8\u5206\u7684\u7b14\u8bb0\u4e86, \u4f46\u662f\u8fd9\u91cc\u7684\u66f4\u597d!\u751a\u81f3\u4f1a\u7efc\u5408\u8bbe\u8ba1\u6a21\u5f0f!\u601d\u7ef4\u66f4\u8fde\u8d2f!"})}),"\n",(0,t.jsx)(e.h2,{id:"50-\u7b2c0\u7ae0-\u65f6\u95f4",children:"5.0 \u7b2c0\u7ae0: \u65f6\u95f4"}),"\n",(0,t.jsx)(e.h3,{id:"501-c-\u8bed\u8a00\u5982\u4f55\u5904\u7406\u65f6\u95f4-timeh",children:"5.0.1 C \u8bed\u8a00\u5982\u4f55\u5904\u7406\u65f6\u95f4: time.h"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C",children:"// Linux\u4e0b sleep\u7684\u5355\u4f4d\u662f\u79d2!\nlong t0 = time(NULL); // \u83b7\u53d6\u4ece1970\u5e741\u67081\u65e5\u5230\u5f53\u524d\u65f6\u7ecf\u8fc7\u7684\u79d2\u6570\nsleep(3);             // \u8ba9\u7a0b\u5e8f\u4f11\u77203\u79d2\nlong t1 = t0 + 3;     // \u5f53\u524d\u65f6\u95f4\u7684\u4e09\u79d2\u540e\nusleep(3000000);      // \u8ba9\u7a0b\u5e8f\u4f11\u77203000000\u5fae\u79d2\uff0c\u4e5f\u5c31\u662f3\u79d2\n"})}),"\n",(0,t.jsx)(e.p,{children:"C \u8bed\u8a00\u539f\u59cb\u7684 API\uff0c\u6ca1\u6709\u7c7b\u578b\u533a\u5206\uff0c\u5bfc\u81f4\u5f88\u5bb9\u6613\u5f04\u9519\u5355\u4f4d\uff0c\u6df7\u6dc6\u65f6\u95f4\u70b9\u548c\u65f6\u95f4\u6bb5\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u6bd4\u5982",(0,t.jsx)(e.code,{children:"t0 * 3"}),"\uff0c\u4e58\u6cd5\u5bf9\u65f6\u95f4\u70b9\u800c\u8a00\u6839\u672c\u662f\u4e2a\u65e0\u610f\u4e49\u7684\u8ba1\u7b97\uff0c\u7136\u800c C \u8bed\u8a00\u628a\u4ed6\u4eec\u770b\u505a\u4e00\u6837\u7684 long \u7c7b\u578b\uff0c\u4ece\u800c\u5bb9\u6613\u8ba9\u7a0b\u5e8f\u5458\u72af\u9519\u3002"]}),"\n",(0,t.jsx)(e.h3,{id:"502-c11-\u5f15\u5165\u7684\u65f6\u95f4\u6807\u51c6\u5e93-stdchrono",children:"5.0.2 C++11 \u5f15\u5165\u7684\u65f6\u95f4\u6807\u51c6\u5e93: std::chrono"}),"\n",(0,t.jsx)(e.p,{children:"\u5229\u7528 C++ \u5f3a\u7c7b\u578b\u7684\u7279\u70b9\uff0c\u660e\u786e\u533a\u5206\u65f6\u95f4\u70b9\u4e0e\u65f6\u95f4\u6bb5\uff0c\u660e\u786e\u533a\u5206\u4e0d\u540c\u7684\u65f6\u95f4\u5355\u4f4d\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u65f6\u95f4\u70b9\u4f8b\u5b50: 2022\u5e741\u67088\u65e5 13\u70b907\u520610\u79d2"}),"\n",(0,t.jsx)(e.li,{children:"\u65f6\u95f4\u6bb5\u4f8b\u5b50: 1\u520630\u79d2"}),"\n",(0,t.jsxs)(e.li,{children:["\u65f6\u95f4\u70b9\u7c7b\u578b: ",(0,t.jsx)(e.code,{children:"chrono::steady_clock::time_point"}),"\u7b49"]}),"\n",(0,t.jsxs)(e.li,{children:["\u65f6\u95f4\u6bb5\u7c7b\u578b: ",(0,t.jsx)(e.code,{children:"chrono::milliseconds"}),"\uff0c",(0,t.jsx)(e.code,{children:"chrono::seconds"}),"\uff0c",(0,t.jsx)(e.code,{children:"chrono::minutes"}),"\u7b49"]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u65b9\u4fbf\u7684\u8fd0\u7b97\u7b26\u91cd\u8f7d\uff1a\u65f6\u95f4\u70b9+\u65f6\u95f4\u6bb5=\u65f6\u95f4\u70b9\uff0c\u65f6\u95f4\u70b9-\u65f6\u95f4\u70b9=\u65f6\u95f4\u6bb5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"auto t0 = chrono::steady_clock::now(); // \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\u70b9\nauto t1 = t0 + chrono::seconds(30);    // \u5f53\u524d\u65f6\u95f4\u70b9\u768430\u79d2\u540e\nauto dt = t1 - t0;                     // \u83b7\u53d6\u4e24\u4e2a\u65f6\u95f4\u70b9\u7684\u5dee\uff08\u65f6\u95f4\u6bb5\uff09\nint64_t sec = chrono::duration_cast<chrono::seconds>(dt).count(); // \u65f6\u95f4\u5dee\u7684\u79d2\u6570\n"})}),"\n",(0,t.jsx)(e.h3,{id:"503-\u6848\u4f8b-\u8ba1\u7b97\u82b1\u8d39\u7684\u65f6\u95f4",children:"5.0.3 \u6848\u4f8b: \u8ba1\u7b97\u82b1\u8d39\u7684\u65f6\u95f4"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <chrono>\n\nint main() {\n    auto t0 = std::chrono::steady_clock::now();\n    for (volatile int i = 0; i < 10000000; i++)\n        ;\n    auto t1 = std::chrono::steady_clock::now();\n    auto dt = t1 - t0;\n    int64_t ms = std::chrono::duration_cast<std::chrono::milliseconds>(dt).count();\n    std::cout << "time elapsed: " << ms << " ms" << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"504-\u65f6\u95f4\u6bb5-\u4f5c\u4e3a-double-\u7c7b\u578b",children:"5.0.4 \u65f6\u95f4\u6bb5: \u4f5c\u4e3a double \u7c7b\u578b"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"duration_cast"}),"\u53ef\u4ee5\u5728\u4efb\u610f\u7684",(0,t.jsx)(e.code,{children:"duration"}),"\u7c7b\u578b\u4e4b\u95f4\u8f6c\u6362"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"duration<T, R>"}),"\u8868\u793a\u7528 T \u7c7b\u578b\u8868\u793a\uff0c\u4e14\u65f6\u95f4\u5355\u4f4d\u662f R"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"R"}),"\u7701\u7565\u4e0d\u5199\u5c31\u662f\u79d2\uff0c",(0,t.jsx)(e.code,{children:"std::milli"}),"\u5c31\u662f\u6beb\u79d2\uff0c",(0,t.jsx)(e.code,{children:"std::micro"}),"\u5c31\u662f\u5fae\u79d2"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["seconds \u662f",(0,t.jsx)(e.code,{children:"duration<int64_t>"}),"\u7684\u7c7b\u578b\u522b\u540d"]}),"\n",(0,t.jsxs)(e.li,{children:["milliseconds \u662f",(0,t.jsx)(e.code,{children:"duration<int64_t, std::milli>"}),"\u7684\u7c7b\u578b\u522b\u540d"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86",(0,t.jsx)(e.code,{children:"double_ms"}),"\u4f5c\u4e3a",(0,t.jsx)(e.code,{children:"duration<double, std::milli>"}),"\u7684\u522b\u540d:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    auto t0 = std::chrono::steady_clock::now();\n    for (volatile int i = 0; i < 10000000; i++);\n    auto t1 = std::chrono::steady_clock::now();\n    auto dt = t1 - t0;\n    using double_ms = std::chrono::duration<double, std::milli>;\n    double ms = std::chrono::duration_cast<double_ms>(dt).count();\n    std::cout << "time elapsed: " << ms << " ms" << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"505-\u8de8\u5e73\u53f0\u7684-sleep-stdthis_threadsleep_for",children:"5.0.5 \u8de8\u5e73\u53f0\u7684 sleep: std::this_thread::sleep_for"}),"\n",(0,t.jsxs)(e.p,{children:["\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::this_thread::sleep_for"}),"\u66ff\u4ee3 Unix \u7c7b\u64cd\u4f5c\u7cfb\u7edf\u4e13\u6709\u7684\u7684 usleep\u3002\u4ed6\u53ef\u4ee5\u8ba9\u5f53\u524d\u7ebf\u7a0b\u4f11\u7720\u4e00\u6bb5\u65f6\u95f4\uff0c\u7136\u540e\u7ee7\u7eed\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u800c\u4e14\u5355\u4f4d\u4e5f\u53ef\u4ee5\u81ea\u5df1\u6307\u5b9a\uff0c\u6bd4\u5982\u8fd9\u91cc\u662f milliseconds \u8868\u793a\u6beb\u79d2\uff0c\u4e5f\u53ef\u4ee5\u6362\u6210 microseconds \u8868\u793a\u5fae\u79d2\uff0cseconds \u8868\u793a\u79d2\uff0cchrono \u7684\u5f3a\u7c7b\u578b\u8ba9\u5355\u4f4d\u9009\u62e9\u66f4\u81ea\u7531\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    std::this_thread::sleep_for(std::chrono::milliseconds(400));\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"506-\u7761\u5230\u65f6\u95f4\u70b9-stdthis_threadsleep_until",children:"5.0.6 \u7761\u5230\u65f6\u95f4\u70b9: std::this_thread::sleep_until"}),"\n",(0,t.jsxs)(e.p,{children:["\u9664\u4e86\u63a5\u53d7\u4e00\u4e2a\u65f6\u95f4\u6bb5\u7684",(0,t.jsx)(e.code,{children:"sleep_for"}),"\uff0c\u8fd8\u6709\u63a5\u53d7\u4e00\u4e2a\u65f6\u95f4\u70b9\u7684",(0,t.jsx)(e.code,{children:"sleep_until"}),"\uff0c\u8868\u793a",(0,t.jsx)(e.strong,{children:"\u8ba9\u5f53\u524d\u7ebf\u7a0b\u4f11\u7720\u76f4\u5230\u67d0\u4e2a\u65f6\u95f4\u70b9"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    auto t = std::chrono::steady_clock::now() + std::chrono::milliseconds(400);\n    std::this_thread::sleep_until(t);\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"51-\u7b2c1\u7ae0-\u7ebf\u7a0b",children:"5.1 \u7b2c1\u7ae0: \u7ebf\u7a0b"}),"\n",(0,t.jsx)(e.h3,{id:"511-\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b",children:"5.1.1 \u8fdb\u7a0b\u4e0e\u7ebf\u7a0b"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"\u8fdb\u7a0b"}),"\u662f\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u88ab\u64cd\u4f5c\u7cfb\u7edf\u62c9\u8d77\u6765\u52a0\u8f7d\u5230\u5185\u5b58\u4e4b\u540e\u4ece\u5f00\u59cb\u6267\u884c\u5230\u6267\u884c\u7ed3\u675f\u7684\u8fd9\u6837\u4e00\u4e2a\u8fc7\u7a0b\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u8fdb\u7a0b\u662f\u7a0b\u5e8f\uff08\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u6267\u884c\u6587\u4ef6\uff09\u7684\u4e00\u6b21\u6267\u884c\u3002\u6bd4\u5982\u53cc\u51fb\u6253\u5f00\u4e00\u4e2a\u684c\u9762\u5e94\u7528\u8f6f\u4ef6\u5c31\u662f\u5f00\u542f\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"\u7ebf\u7a0b"}),"\u662f\u8fdb\u7a0b\u4e2d\u7684\u4e00\u4e2a\u5b9e\u4f53\uff0c\u662f\u88ab\u7cfb\u7edf\u72ec\u7acb\u5206\u914d\u548c\u8c03\u5ea6\u7684\u57fa\u672c\u5355\u4f4d\u3002\u4e5f\u6709\u8bf4\uff0c\u7ebf\u7a0b\u662fCPU\u53ef\u6267\u884c\u8c03\u5ea6\u7684\u6700\u5c0f\u5355\u4f4d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fdb\u7a0b\u672c\u8eab\u5e76\u4e0d\u80fd\u83b7\u53d6CPU\u65f6\u95f4\uff0c\u53ea\u6709\u5b83\u7684\u7ebf\u7a0b\u624d\u53ef\u4ee5\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u4ece\u5c5e\u5173\u7cfb: ",(0,t.jsx)(e.code,{children:"\u8fdb\u7a0b > \u7ebf\u7a0b"}),"\u3002\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u62e5\u6709\u591a\u4e2a\u7ebf\u7a0b\u3002"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u6bcf\u4e2a\u7ebf\u7a0b\u5171\u4eab\u540c\u6837\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5f00\u9500\u6bd4\u8f83\u5c0f\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u6bcf\u4e2a\u8fdb\u7a0b\u62e5\u6709\u72ec\u7acb\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u56e0\u6b64\u5f00\u9500\u66f4\u5927\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u5bf9\u4e8e\u9ad8\u6027\u80fd\u5e76\u884c\u8ba1\u7b97\uff0c\u66f4\u597d\u7684\u662f\u591a\u7ebf\u7a0b\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"512-\u4e3a\u4ec0\u4e48\u9700\u8981\u591a\u7ebf\u7a0b-\u65e0\u963b\u585e\u591a\u4efb\u52a1",children:"5.1.2 \u4e3a\u4ec0\u4e48\u9700\u8981\u591a\u7ebf\u7a0b: \u65e0\u963b\u585e\u591a\u4efb\u52a1"}),"\n",(0,t.jsx)(e.p,{children:"\u6211\u4eec\u7684\u7a0b\u5e8f\u5e38\u5e38\u9700\u8981\u540c\u65f6\u5904\u7406\u591a\u4e2a\u4efb\u52a1\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4f8b\u5982: \u540e\u53f0\u5728\u6267\u884c\u4e00\u4e2a\u5f88\u8017\u65f6\u7684\u4efb\u52a1\uff0c\u6bd4\u5982\u4e0b\u8f7d\u4e00\u4e2a\u6587\u4ef6\uff0c\u540c\u65f6\u8fd8\u8981\u548c\u7528\u6237\u4ea4\u4e92\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u5728 GUI \u5e94\u7528\u7a0b\u5e8f\u4e2d\u5f88\u5e38\u89c1\uff0c\u6bd4\u5982\u6d4f\u89c8\u5668\u5728\u540e\u53f0\u4e0b\u8f7d\u6587\u4ef6\u7684\u540c\u65f6\uff0c\u7528\u6237\u4ecd\u7136\u53ef\u4ee5\u7528\u9f20\u6807\u64cd\u4f5c\u5176 UI \u754c\u9762\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <string>\n\nvoid download(std::string file) {\n    for (int i = 0; i < 10; i++) {\n        std::cout << "Downloading " << file\n                  << " (" << i * 10 << "%)..." << std::endl;\n        std::this_thread::sleep_for(std::chrono::milliseconds(400));\n    }\n    std::cout << "Download complete: " << file << std::endl;\n}\n\nvoid interact() {\n    std::string name;\n    std::cin >> name;\n    std::cout << "Hi, " << name << std::endl;\n}\n\nint main() {\n    download("hello.zip");\n    interact();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"513-\u6ca1\u6709\u591a\u7ebf\u7a0b-\u7a0b\u5e8f\u672a\u54cd\u5e94",children:"5.1.3 \u6ca1\u6709\u591a\u7ebf\u7a0b: \u7a0b\u5e8f\u672a\u54cd\u5e94"}),"\n",(0,t.jsxs)(e.p,{children:["\u6ca1\u6709\u591a\u7ebf\u7a0b\u7684\u8bdd\uff0c\u5c31",(0,t.jsx)(e.strong,{children:"\u5fc5\u987b"}),"\u7b49\u6587\u4ef6\u4e0b\u8f7d",(0,t.jsx)(e.strong,{children:"\u5b8c\u4e86"}),"\u624d\u80fd",(0,t.jsx)(e.strong,{children:"\u7ee7\u7eed"}),"\u548c\u7528\u6237\u4ea4\u4e92\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u4e0b\u8f7d\u5b8c\u6210\u524d\uff0c\u6574\u4e2a\u754c\u9762\u90fd\u4f1a\u5904\u4e8e\u201c\u672a\u54cd\u5e94\u201d\u72b6\u6001\uff0c\u7528\u6237\u60f3\u505a\u522b\u7684\u4e8b\u60c5\u5c31\u505a\u4e0d\u4e86\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"514-\u73b0\u4ee3-c-\u4e2d\u7684\u591a\u7ebf\u7a0b-stdthread",children:"5.1.4 \u73b0\u4ee3 C++ \u4e2d\u7684\u591a\u7ebf\u7a0b: std::thread"}),"\n",(0,t.jsxs)(e.p,{children:["C++11 \u5f00\u59cb\uff0c\u4e3a\u591a\u7ebf\u7a0b\u63d0\u4f9b\u4e86\u8bed\u8a00\u7ea7\u522b\u7684\u652f\u6301\u3002\u4ed6\u7528",(0,t.jsx)(e.code,{children:"std::thread"}),"\u8fd9\u4e2a\u7c7b\u6765\u8868\u793a\u7ebf\u7a0b\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::thread"}),"\u6784\u9020\u51fd\u6570\u7684\u53c2\u6570\u53ef\u4ee5\u662f\u4efb\u610f lambda \u8868\u8fbe\u5f0f\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u5f53\u90a3\u4e2a\u7ebf\u7a0b\u542f\u52a8\u65f6\uff0c\u5c31\u4f1a\u6267\u884c\u8fd9\u4e2a lambda \u91cc\u7684\u5185\u5bb9\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e00\u8fb9\u548c\u7528\u6237\u4ea4\u4e92\uff0c\u4e00\u8fb9\u5728\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u91cc\u6162\u541e\u541e\u4e0b\u8f7d\u6587\u4ef6\u4e86\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    interact();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"515-\u9519\u8bef-\u627e\u4e0d\u5230\u7b26\u53f7-pthread_create",children:"5.1.5 \u9519\u8bef: \u627e\u4e0d\u5230\u7b26\u53f7 pthread_create"}),"\n",(0,t.jsx)(e.p,{children:"\u4f46\u5f53\u6211\u4eec\u76f4\u63a5\u5c1d\u8bd5\u7f16\u8bd1\u521a\u624d\u7684\u4ee3\u7801\uff0c\u5374\u5728\u94fe\u63a5\u65f6\u53d1\u751f\u4e86\u9519\u8bef\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u539f\u6765",(0,t.jsx)(e.code,{children:"std::thread"}),"\u7684\u5b9e\u73b0\u80cc\u540e\u662f\u57fa\u4e8e pthread \u7684\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u89e3\u51b3: ",(0,t.jsx)(e.code,{children:"CMakeLists.txt"}),"\u91cc\u94fe\u63a5",(0,t.jsx)(e.code,{children:"Threads::Threads"}),"\u5373\u53ef:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-CMake",children:"cmake_minimum_required(VERSION 3.10)\n\nset(CMAKE_CXX_STANDARD 17)\n\nproject(cpptest LANGUAGES CXX)\n\nadd_executable(cpptest main.cpp)\n\n# \u8de8\u5e73\u53f0\u7684\u94fe\u63a5\u5e93, cmake\u5c06\u5176\u5c01\u88c5\u6210\u4e00\u4e2a\u5305\nfind_package(Threads REQUIRED)\ntarget_link_libraries(cpptest PUBLIC Threads::Threads)\n"})}),"\n",(0,t.jsx)(e.h3,{id:"516-\u6709\u4e86\u591a\u7ebf\u7a0b-\u5f02\u6b65\u5904\u7406\u8bf7\u6c42",children:"5.1.6 \u6709\u4e86\u591a\u7ebf\u7a0b: \u5f02\u6b65\u5904\u7406\u8bf7\u6c42"}),"\n",(0,t.jsx)(e.p,{children:"\u6709\u4e86\u591a\u7ebf\u7a0b\u7684\u8bdd\uff0c\u6587\u4ef6\u4e0b\u8f7d\u548c\u7528\u6237\u4ea4\u4e92\u5206\u522b\u5728\u4e24\u4e2a\u7ebf\u7a0b\uff0c\u540c\u65f6\u72ec\u7acb\u8fd0\u884c\u3002\u4ece\u800c\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u4e5f\u53ef\u4ee5\u54cd\u5e94\u7528\u6237\u8bf7\u6c42\uff0c\u63d0\u5347\u4e86\u4f53\u9a8c\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u53ef\u662f\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898: \u6211\u8f93\u5165\u5b8c pyb \u4ee5\u540e\uff0c\u4ed6\u7684\u786e\u53ca\u65f6\u5730\u548c\u6211\u4ea4\u4e92\u4e86\u3002\u4f46\u662f\u7528\u6237\u4ea4\u4e92\u6240\u5728\u7684\u4e3b\u7ebf\u7a0b\u9000\u51fa\u540e\uff0c\u6587\u4ef6\u4e0b\u8f7d\u6240\u5728\u7684\u5b50\u7ebf\u7a0b\uff0c\u56e0\u4e3a\u4ece\u5c5e\u4e8e\u8fd9\u4e2a\u4e3b\u7ebf\u7a0b\uff0c\u4e5f\u88ab\u8feb\u9000\u51fa\u4e86\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"517-\u4e3b\u7ebf\u7a0b\u7b49\u5f85\u5b50\u7ebf\u7a0b\u7ed3\u675f-t1join",children:"5.1.7 \u4e3b\u7ebf\u7a0b\u7b49\u5f85\u5b50\u7ebf\u7a0b\u7ed3\u675f: t1.join()"}),"\n",(0,t.jsx)(e.p,{children:"\u56e0\u6b64\uff0c\u6211\u4eec\u60f3\u8981\u8ba9\u4e3b\u7ebf\u7a0b\u4e0d\u8981\u6025\u7740\u9000\u51fa\uff0c\u7b49\u5b50\u7ebf\u7a0b\u4e5f\u7ed3\u675f\u4e86\u518d\u9000\u51fa\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::thread"}),"\u7c7b\u7684\u6210\u5458\u51fd\u6570",(0,t.jsx)(e.code,{children:"join()"}),"\u6765\u7b49\u5f85\u8be5\u8fdb\u7a0b\u7ed3\u675f\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    interact();\n    std::cout << "Waiting for child thread..." << std::endl;\n    t1.join();\n    std::cout << "Child thread exited!" << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"518-stdthread-\u7684\u89e3\u6784\u51fd\u6570\u4f1a\u9500\u6bc1\u7ebf\u7a0b",children:"5.1.8 std::thread \u7684\u89e3\u6784\u51fd\u6570\u4f1a\u9500\u6bc1\u7ebf\u7a0b"}),"\n",(0,t.jsxs)(e.p,{children:["\u4f5c\u4e3a\u4e00\u4e2a C++ \u7c7b\uff0c",(0,t.jsx)(e.code,{children:"std::thread"}),"\u540c\u6837\u9075\u5faa RAII \u601d\u60f3\u548c\u4e09\u4e94\u6cd5\u5219:"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.span,{style:{color:"yellow"},children:"\u56e0\u4e3a\u7ba1\u7406\u7740\u8d44\u6e90\uff0c\u4ed6\u81ea\u5b9a\u4e49\u4e86\u89e3\u6784\u51fd\u6570\uff0c\u5220\u9664\u4e86\u62f7\u8d1d\u6784\u9020/\u8d4b\u503c\u51fd\u6570\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u79fb\u52a8\u6784\u9020/\u8d4b\u503c\u51fd\u6570\u3002"})}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:["\u56e0\u6b64\uff0c\u5f53 t1 \u6240\u5728\u7684\u51fd\u6570\u9000\u51fa\u65f6\uff0c\u5c31\u4f1a\u8c03\u7528",(0,t.jsx)(e.code,{children:"std::thread"}),"\u7684\u89e3\u6784\u51fd\u6570\uff0c\u8fd9\u4f1a\u9500\u6bc1",(0,t.jsx)(e.code,{children:"t1"}),"\u7ebf\u7a0b\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u6240\u4ee5\uff0c",(0,t.jsx)(e.code,{children:"download"}),"\u51fd\u6570\u624d\u4f1a\u51fa\u5e08\u672a\u6377\u8eab\u5148\u6b7b\u2014\u2014\u8fd8\u6ca1\u5f00\u59cb\u6267\u884c\u4ed6\u7684\u7ebf\u7a0b\u5c31\u88ab\u9500\u6bc1\u4e86\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'void myfunc() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    // \u9000\u51fa\u51fd\u6570\u4f53\u65f6\uff0c\u4f1a\u9500\u6bc1 t1 \u7ebf\u7a0b\u7684\u53e5\u67c4\uff01\n}\n\nint main() {\n    myfunc();\n    interact();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"519-\u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b-t1detach",children:"5.1.9 \u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b: t1.detach()"}),"\n",(0,t.jsxs)(e.p,{children:["\u89e3\u51b3\u65b9\u6848: \u8c03\u7528\u6210\u5458\u51fd\u6570",(0,t.jsx)(e.code,{children:"detach()"}),"\u5206\u79bb\u8be5\u7ebf\u7a0b."]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u610f\u5473\u7740\u7ebf\u7a0b\u7684\u751f\u547d\u5468\u671f\u4e0d\u518d\u7531\u5f53\u524d",(0,t.jsx)(e.code,{children:"std::thread"}),"\u5bf9\u8c61\u7ba1\u7406\uff0c\u800c\u662f\u5728\u7ebf\u7a0b\u9000\u51fa\u4ee5\u540e\u81ea\u52a8\u9500\u6bc1\u81ea\u5df1\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u4e0d\u8fc7\u8fd9\u6837\u8fd8\u662f\u4f1a\u5728",(0,t.jsx)(e.strong,{children:"\u8fdb\u7a0b\u9000\u51fa\u65f6\u5019\u81ea\u52a8\u9000\u51fa"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'void myfunc() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    t1.detach();\n    // t1 \u6240\u4ee3\u8868\u7684\u7ebf\u7a0b\u88ab\u5206\u79bb\u4e86\uff0c\u4e0d\u518d\u968f t1 \u5bf9\u8c61\u9500\u6bc1\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"5110-\u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b-\u79fb\u52a8\u5230\u5168\u5c40\u7ebf\u7a0b\u6c60",children:"5.1.10 \u89e3\u6784\u51fd\u6570\u4e0d\u518d\u9500\u6bc1\u7ebf\u7a0b: \u79fb\u52a8\u5230\u5168\u5c40\u7ebf\u7a0b\u6c60"}),"\n",(0,t.jsx)(e.p,{children:"\u4f46\u662f detach \u7684\u95ee\u9898\u662f\u8fdb\u7a0b\u9000\u51fa\u65f6\u5019\u4e0d\u4f1a\u7b49\u5f85\u6240\u6709\u5b50\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5\u3002\u6240\u4ee5\u53e6\u4e00\u79cd\u89e3\u6cd5\u662f\u628a t1 \u5bf9\u8c61\u79fb\u52a8\u5230\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\u53bb\uff0c\u4ece\u800c\u5ef6\u957f\u5176\u751f\u547d\u5468\u671f\u5230 myfunc \u51fd\u6570\u4f53\u5916\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u6837\u5c31\u53ef\u4ee5\u7b49\u4e0b\u8f7d\u5b8c\u518d\u9000\u51fa\u4e86\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::vector<std::thread> pool;\n\nvoid myfunc() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    // \u79fb\u4ea4\u63a7\u5236\u6743\u5230\u5168\u5c40\u7684 pool \u5217\u8868\uff0c\u4ee5\u5ef6\u957f t1 \u7684\u751f\u547d\u5468\u671f\n    pool.push_back(std::move(t1));\n}\n\nint main() {\n    myfunc();\n    interact();\n    for (auto &t: pool) t.join();  // \u7b49\u5f85\u6c60\u91cc\u7684\u7ebf\u7a0b\u5168\u90e8\u6267\u884c\u5b8c\u6bd5\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"5111-main-\u51fd\u6570\u9000\u51fa\u540e\u81ea\u52a8-join-\u5168\u90e8\u7ebf\u7a0b-\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f",children:"5.1.11 main \u51fd\u6570\u9000\u51fa\u540e\u81ea\u52a8 join \u5168\u90e8\u7ebf\u7a0b (\u4f7f\u7528\u5355\u4f8b\u6a21\u5f0f)"}),"\n",(0,t.jsx)(e.p,{children:"\u4f46\u662f\u9700\u8981\u5728 main \u91cc\u9762\u624b\u52a8 join \u5168\u90e8\u7ebf\u7a0b\u8fd8\u662f\u6709\u70b9\u9ebb\u70e6\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4e00\u4e2a\u7c7b ThreadPool\uff0c\u5e76\u7528\u4ed6\u521b\u5efa\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\uff0c\u5176\u89e3\u6784\u51fd\u6570\u4f1a\u5728 main \u9000\u51fa\u540e\u81ea\u52a8\u8c03\u7528\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'class ThreadPool {\n    std::vector<std::thread> m_pool;\n\npublic:\n    void push_back(std::thread thr) {\n        m_pool.push_back(std::move(thr));\n    }\n\n    ~ThreadPool() {                      // main \u51fd\u6570\u9000\u51fa\u540e\u4f1a\u81ea\u52a8\u8c03\u7528\n        for (auto &t: m_pool) t.join();  // \u7b49\u5f85\u6c60\u91cc\u7684\u7ebf\u7a0b\u5168\u90e8\u6267\u884c\u5b8c\u6bd5\n    }\n};\n\nThreadPool tpool; // \u6784\u9020\u51fd\u6570\u5728main\u51fd\u6570\u524d\u6267\u884c, \u6790\u6784\u51fd\u6570\u5728main return 0\u540e\u6267\u884c, \u5c31\u662f\u997f\u6c49\u5355\u4f8b\u6a21\u5f0f!\n\nvoid myfunc() {\n    std::thread t1([&] {\n        download("hello.zip");\n    });\n    // \u79fb\u4ea4\u63a7\u5236\u6743\u5230\u5168\u5c40\u7684 pool \u5217\u8868\uff0c\u4ee5\u5ef6\u957f t1 \u7684\u751f\u547d\u5468\u671f\n    tpool.push_back(std::move(t1));\n}\n\nint main() {\n    myfunc();\n    interact();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"5112-stdjthread-\u7b26\u5408-raii-\u601d\u60f3\u89e3\u6784\u65f6\u81ea\u52a8-join",children:"5.1.12 std::jthread: \u7b26\u5408 RAII \u601d\u60f3\uff0c\u89e3\u6784\u65f6\u81ea\u52a8 join()"}),"\n",(0,t.jsxs)(e.p,{children:["C++20 \u5f15\u5165\u4e86",(0,t.jsx)(e.code,{children:"std::jthread"}),"\u7c7b\uff0c\u548c",(0,t.jsx)(e.code,{children:"std::thread"}),"\u4e0d\u540c\u5728\u4e8e: \u4ed6\u7684",(0,t.jsx)(e.code,{children:"\u89e3\u6784\u51fd\u6570"}),"\u91cc\u4f1a\u81ea\u52a8\u8c03\u7528",(0,t.jsx)(e.code,{children:"join()"}),"\u51fd\u6570\uff0c\u4ece\u800c\u4fdd\u8bc1 pool \u89e3\u6784\u65f6\u4f1a",(0,t.jsx)(e.strong,{children:"\u81ea\u52a8\u7b49\u5f85\u5168\u90e8\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'// ~jthread() \u89e3\u6784\u51fd\u6570\u91cc\u4f1a\u81ea\u52a8\u8c03\u7528 join()\uff0c\u5982\u679c joinable() \u7684\u8bdd\nstd::vector<std::jthread> pool;\n\nvoid myfunc() {\n    std::jthread t1([&] {\n        download("hello.zip");\n    });\n    // \u79fb\u4ea4\u63a7\u5236\u6743\u5230\u5168\u5c40\u7684 pool \u5217\u8868\uff0c\u4ee5\u5ef6\u957f t1 \u7684\u751f\u547d\u5468\u671f\n    pool.push_back(std::move(t1));\n}\n\nint main() {\n    myfunc();\n    interact();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-CMake",children:"set(CMAKE_CXX_STANDARD 20)\n"})}),"\n",(0,t.jsx)(e.hr,{}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.del,{children:"\u5c0f\u5f6d\u8001\u5e08\u5feb\u4e50\u5410\u69fd\u65f6\u95f4"})}),"\n",(0,t.jsx)(e.p,{children:"\u591a\u7ebf\u7a0b\u3001\u5f02\u6b65\u3001\u65e0\u963b\u585e\u3001\u5e76\u53d1\uff0c\u80fd\u63d0\u5347\u7a0b\u5e8f\u54cd\u5e94\u901f\u5ea6\uff0c\u5bf9\u73b0\u5b9e\u4e16\u754c\u4e2d\u7684\u8f6f\u4ef6\u5de5\u7a0b\u81f3\u5173\u91cd\u8981\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u53cd\u9762\u6559\u6750: blender \u5728\u8fd0\u884c\u7269\u7406\u89e3\u7b97\u7684\u65f6\u5019\uff0c\u754c\u9762\u4f1a\u5361\u4f4f\uff0c\u7b97\u5b8c\u4e00\u5e27\u540e\u7a97\u53e3\u624d\u80fd\u5237\u65b0\u4e00\u904d\uff0c\u5bfc\u81f4\u89e3\u7b97\u8fc7\u7a0b\u4e2d\u57fa\u672c\u522b\u60f3\u505a\u4e8b\uff0c\u8fd9\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u5f52\u529f\u4e8e opengl \u539f\u59cb\u7684\u5355\u7ebf\u7a0b\u8bbe\u8ba1\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u6b63\u9762\u6559\u6750: zeno \u53ef\u4ee5\u5728\u89e3\u7b97\u8fc7\u7a0b\u4e2d\uff0c\u968f\u65f6\u62d6\u52a8\u6ed1\u5757\u770b\u524d\u51e0\u5e27\u7684\u7ed3\u679c\uff0c\u7f16\u8f91\u573a\u666f\u56fe\uff0c\u4fee\u6539\u8282\u70b9\u95f4\u7684\u8fde\u63a5\uff0c\u4e3a\u4e0b\u4e00\u6b21\u89e3\u7b97\u505a\u51c6\u5907\uff0c\u540c\u65f6\u5f53\u524d\u5df2\u7ecf\u542f\u52a8\u7684\u7269\u7406\u89e3\u7b97\u8fd8\u80fd\u5728\u540e\u53f0\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\u3002\u867d\u7136 zeno \u4e5f\u7528\u4e86 opengl\uff0c\u4f46\u4ed6\u7528\u591a\u8fdb\u7a0b\u6210\u529f\u5728 opengl \u7684\u767e\u822c\u62d6\u540e\u817f\u4e0b\u5b9e\u73b0\u4e86\u5e76\u53d1\u3002"}),"\n",(0,t.jsx)(e.h2,{id:"52-\u7b2c2\u7ae0-\u5f02\u6b65",children:"5.2 \u7b2c2\u7ae0: \u5f02\u6b65"}),"\n",(0,t.jsx)(e.h3,{id:"521-\u5f02\u6b65\u597d\u5e2e\u624b-stdasync",children:"5.2.1 \u5f02\u6b65\u597d\u5e2e\u624b: std::async"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::async"}),"\u63a5\u53d7\u4e00\u4e2a",(0,t.jsx)(e.strong,{children:"\u5e26\u8fd4\u56de\u503c"}),"\u7684",(0,t.jsx)(e.code,{children:"lambda"}),"\uff0c\u81ea\u8eab\u8fd4\u56de\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"std::future"}),"\u5bf9\u8c61\u3002"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"lambda \u7684\u51fd\u6570\u4f53\u5c06\u5728\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u91cc\u6267\u884c\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u4f60\u53ef\u4ee5\u5728 main \u91cc\u9762\u505a\u4e00\u4e9b\u522b\u7684\u4e8b\u60c5\uff0cdownload \u4f1a\u6301\u7eed\u5728\u540e\u53f0\u6084\u6084\u8fd0\u884c\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u6700\u540e\u8c03\u7528",(0,t.jsx)(e.code,{children:"future"}),"\u7684",(0,t.jsx)(e.code,{children:"get()"}),"\u65b9\u6cd5\uff0c\u5982\u679c\u6b64\u65f6 download \u8fd8\u6ca1\u5b8c\u6210\uff0c\u4f1a",(0,t.jsx)(e.strong,{children:"\u7b49\u5f85"})," download \u5b8c\u6210\uff0c\u5e76\u83b7\u53d6 download \u7684\u8fd4\u56de\u503c\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <future> // \u9700\u8981\u7684\u5934\u6587\u4ef6\n\nint main() {\n    std::future<int> fret = std::async([&] {\n        return download("hello.zip"); // download \u8fd4\u56de 404\n    });\n    interact();\n    int ret = fret.get();\n    std::cout << "Download result: " << ret << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"522-\u663e\u793a\u5730\u7b49\u5f85-wait",children:"5.2.2 \u663e\u793a\u5730\u7b49\u5f85: wait()"}),"\n",(0,t.jsxs)(e.p,{children:["\u9664\u4e86",(0,t.jsx)(e.code,{children:"get()"}),"\u4f1a\u7b49\u5f85\u7ebf\u7a0b\u6267\u884c\u5b8c\u6bd5\u5916\uff0c",(0,t.jsx)(e.code,{children:"wait()"}),"\u4e5f\u53ef\u4ee5\u7b49\u5f85\u4ed6\u6267\u884c\u5b8c\uff0c\u4f46\u662f",(0,t.jsx)(e.strong,{children:"\u4e0d\u4f1a"}),"\u8fd4\u56de\u5176\u503c\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::future<int> fret = std::async([&] {\n        return download("hello.zip"); \n    });\n    interact();\n    std::cout << "Waiting for download complete..." << std::endl;\n    fret.wait();\n    std::cout << "Wait returned!" << std::endl;\n    int ret = fret.get();\n    std::cout << "Download result: " << ret << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"523-\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4-wait_for",children:"5.2.3 \u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4: wait_for()"}),"\n",(0,t.jsxs)(e.p,{children:["\u53ea\u8981\u7ebf\u7a0b\u6ca1\u6709\u6267\u884c\u5b8c\uff0c",(0,t.jsx)(e.code,{children:"wait()"}),"\u4f1a\u65e0\u9650\u7b49\u4e0b\u53bb\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u800c",(0,t.jsx)(e.code,{children:"wait_for()"}),"\u5219\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u6700\u957f\u7b49\u5f85\u65f6\u95f4\uff0c\u7528",(0,t.jsx)(e.code,{children:"chrono"}),"\u91cc\u7684\u7c7b\u8868\u793a\u5355\u4f4d\u3002\u4ed6\u4f1a\u8fd4\u56de\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"std::future_status"}),"\u8868\u793a\u7b49\u5f85\u662f\u5426\u6210\u529f\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\u7ebf\u7a0b\u8fd8\u6ca1\u6709\u6267\u884c\u5b8c\u6bd5\uff0c\u5219\u653e\u5f03\u7b49\u5f85\uff0c\u8fd4\u56de",(0,t.jsx)(e.code,{children:"future_status::timeout"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u7ebf\u7a0b\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u5185\u6267\u884c\u5b8c\u6bd5\uff0c\u5219\u8ba4\u4e3a\u7b49\u5f85\u6210\u529f\uff0c\u8fd4\u56de",(0,t.jsx)(e.code,{children:"future_status::ready"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u540c\u7406\u8fd8\u6709",(0,t.jsx)(e.code,{children:"wait_until()"}),"\u5176\u53c2\u6570\u662f\u4e00\u4e2a\u65f6\u95f4\u70b9\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::future<int> fret = std::async([&] {\n        return download("hello.zip"); \n    });\n    interact();\n    while (true) {\n        std::cout << "Waiting for download complete..." << std::endl;\n        auto stat = fret.wait_for(std::chrono::milliseconds(1000));\n        if (stat == std::future_status::ready) {\n            std::cout << "Future is ready!!" << std::endl;\n            break;\n        } else {\n            std::cout << "Future not ready!!" << std::endl;\n        }\n    }\n    int ret = fret.get();\n    std::cout << "Download result: " << ret << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"524-\u53e6\u4e00\u79cd\u7528\u6cd5-stdlaunchdeferred-\u505a\u53c2\u6570",children:"5.2.4 \u53e6\u4e00\u79cd\u7528\u6cd5: std::launch::deferred \u505a\u53c2\u6570"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::async"}),"\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u53ef\u4ee5\u8bbe\u4e3a",(0,t.jsx)(e.code,{children:"std::launch::deferred"}),"\uff0c\u8fd9\u65f6\u4e0d\u4f1a\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u6765\u6267\u884c\uff0c\u4ed6\u53ea\u4f1a\u628a",(0,t.jsx)(e.code,{children:"lambda"}),"\u51fd\u6570\u4f53\u5185\u7684\u8fd0\u7b97\u63a8\u8fdf\u5230",(0,t.jsx)(e.code,{children:"future"}),"\u7684",(0,t.jsx)(e.code,{children:"get()"}),"\u88ab\u8c03\u7528\u65f6\u3002\u4e5f\u5c31\u662f main \u4e2d\u7684 interact \u8ba1\u7b97\u5b8c\u6bd5\u540e\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u79cd\u5199\u6cd5\uff0cdownload \u7684\u6267\u884c\u4ecd\u5728\u4e3b\u7ebf\u7a0b\u4e2d\uff0c\u4ed6\u53ea\u662f\u51fd\u6570\u5f0f\u7f16\u7a0b\u8303\u5f0f\u610f\u4e49\u4e0a\u7684\u5f02\u6b65\uff0c\u800c",(0,t.jsx)(e.strong,{children:"\u4e0d\u6d89\u53ca\u5230\u771f\u6b63\u7684\u591a\u7ebf\u7a0b"}),"\u3002\u53ef\u4ee5\u7528\u8fd9\u4e2a\u5b9e\u73b0 ",(0,t.jsx)(e.strong,{children:"\u60f0\u6027\u6c42\u503c(lazy evaluation)"})," \u4e4b\u7c7b\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'void interact() {\n    std::string name;\n    std::cin >> name;\n    std::cout << "Hi, " << name << std::endl;\n}\n\nint main() {\n    std::future<int> fret = std::async(std::launch::deferred, [&] {\n        return download("hello.zip"); \n    });\n    interact(); // \u8f93\u5165\u540e\u624d\u5f00\u59cb\u4e0b\u8f7d (\u8f93\u5165\u662f\u963b\u585e\u7684)\n    int ret = fret.get();\n    std::cout << "Download result: " << ret << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"525-stdasync-\u7684\u5e95\u5c42\u5b9e\u73b0-stdpromise",children:"5.2.5 std::async \u7684\u5e95\u5c42\u5b9e\u73b0: std::promise"}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u4e0d\u60f3\u8ba9",(0,t.jsx)(e.code,{children:"std::async"}),"\u5e2e\u4f60\u81ea\u52a8\u521b\u5efa\u7ebf\u7a0b\uff0c\u60f3\u8981\u624b\u52a8\u521b\u5efa\u7ebf\u7a0b\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528",(0,t.jsx)(e.code,{children:"std::promise"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u7136\u540e\u5728\u7ebf\u7a0b\u8fd4\u56de\u7684\u65f6\u5019\uff0c\u7528",(0,t.jsx)(e.code,{children:"set_value()"}),"\u8bbe\u7f6e\u8fd4\u56de\u503c\u3002\u5728\u4e3b\u7ebf\u7a0b\u91cc\uff0c\u7528",(0,t.jsx)(e.code,{children:"get_future()"}),"\u83b7\u53d6\u5176",(0,t.jsx)(e.code,{children:"std::future"}),"\u5bf9\u8c61\uff0c\u8fdb\u4e00\u6b65",(0,t.jsx)(e.code,{children:"get()"}),"\u53ef\u4ee5\u7b49\u5f85\u5e76\u83b7\u53d6\u7ebf\u7a0b\u8fd4\u56de\u503c\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::promise<int> pret;\n    std::thread t1([&] {\n        auto ret = download("hello.zip");\n        pret.set_value(ret);\n    });\n    std::future<int> fret = pret.get_future();\n\n    interact();\n    int ret = fret.get();\n    std::cout << "Download result: " << ret << std::endl;\n\n    t1.join();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"526-stdfuture-\u5c0f\u8d34\u58eb",children:"5.2.6 std::future \u5c0f\u8d34\u58eb"}),"\n",(0,t.jsxs)(e.p,{children:["future \u4e3a\u4e86\u4e09\u4e94\u6cd5\u5219\uff0c",(0,t.jsx)(e.strong,{children:"\u5220\u9664\u4e86\u62f7\u8d1d\u6784\u9020/\u8d4b\u503c\u51fd\u6570"}),"\u3002\u5982\u679c\u9700\u8981",(0,t.jsx)(e.strong,{children:"\u6d45\u62f7\u8d1d"}),"\uff0c\u5b9e\u73b0",(0,t.jsxs)(e.strong,{children:["\u5171\u4eab\u540c\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"future"}),"\u5bf9\u8c61"]}),"\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::shared_future"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u4e0d\u9700\u8981\u8fd4\u56de\u503c\uff0c",(0,t.jsx)(e.code,{children:"std::async"}),"\u91cc lambda \u7684\u8fd4\u56de\u7c7b\u578b\u53ef\u4ee5\u4e3a",(0,t.jsx)(e.code,{children:"void"}),"\uff0c \u8fd9\u65f6",(0,t.jsx)(e.code,{children:"future"}),"\u5bf9\u8c61\u7684\u7c7b\u578b\u4e3a",(0,t.jsx)(e.code,{children:"std::future<void>"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u540c\u7406\u6709",(0,t.jsx)(e.code,{children:"std::promise<void>"}),"\uff0c\u4ed6\u7684",(0,t.jsx)(e.code,{children:"set_value()"}),"\u4e0d\u63a5\u53d7\u53c2\u6570\uff0c\u4ec5\u4ec5\u4f5c\u4e3a",(0,t.jsx)(e.strong,{children:"\u540c\u6b65\u7528"}),"\uff0c\u4e0d\u4f20\u9012\u4efb\u4f55\u5b9e\u9645\u7684\u503c\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::shared_future<void> fret = std::async([&] {\n        download("hello.zip"); \n    });\n    auto fret2 = fret;\n    auto fret3 = fret;\n    interact();\n    fret3.wait();\n    std::cout << "Download completed" << std::endl;\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"53-\u7b2c3\u7ae0-\u4e92\u65a5\u91cf",children:"5.3 \u7b2c3\u7ae0: \u4e92\u65a5\u91cf"}),"\n",(0,t.jsx)(e.h3,{id:"531-\u591a\u7ebf\u7a0b\u6253\u67b6\u6848\u4f8b",children:"5.3.1 \u591a\u7ebf\u7a0b\u6253\u67b6\u6848\u4f8b"}),"\n",(0,t.jsx)(e.p,{children:"\u4e24\u4e2a\u7ebf\u7a0b\u8bd5\u56fe\u5f80\u540c\u4e00\u4e2a\u6570\u7ec4\u91cc\u63a8\u6570\u636e\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5954\u6e83\u4e86\uff01\u4e3a\u4ec0\u4e48\uff1f"}),"\n"]}),"\n",(0,t.jsxs)(e.div,{className:"markdown-alert markdown-alert-tip",children:["\n",(0,t.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,t.jsx)(e.span,{className:"octicon octicon-tip",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-light-bulb mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Tip"]}),"\n",(0,t.jsxs)(e.p,{children:["vector \u4e0d\u662f ",(0,t.jsx)(e.strong,{children:"\u591a\u7ebf\u7a0b\u5b89\u5168(MT-safe)"})," \u7684\u5bb9\u5668\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8bbf\u95ee\u540c\u4e00\u4e2a vector \u4f1a\u51fa\u73b0 ",(0,t.jsx)(e.strong,{children:"\u6570\u636e\u7ade\u4e89(data-race)"})," \u73b0\u8c61\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    std::vector<int> arr;\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            arr.push_back(1);\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            arr.push_back(2);\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"532-stdmutex-\u4e0a\u9501\u9632\u6b62\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fdb\u5165\u67d0\u4e00\u4ee3\u7801\u6bb5",children:"5.3.2 std::mutex: \u4e0a\u9501\uff0c\u9632\u6b62\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fdb\u5165\u67d0\u4e00\u4ee3\u7801\u6bb5"}),"\n",(0,t.jsxs)(e.p,{children:["\u901a\u4fd7\u7684\u8bf4: ",(0,t.jsx)(e.code,{children:"mutex"}),"\u662f\u4e2a\u5395\u6240\uff0cA \u540c\u5b66\u5728\u7528\u4e86\uff0cB \u540c\u5b66\u5c31\u4e0d\u80fd\u8fdb\u53bb\uff0c\u8981\u7b49 A \u540c\u5b66\u7528\u5b8c\u4e86\u624d\u80fd\u8fdb\u53bb\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8c03\u7528",(0,t.jsx)(e.code,{children:"std::mutex"}),"\u7684",(0,t.jsx)(e.code,{children:"lock()"}),"\u65f6\uff0c\u4f1a\u68c0\u6d4b",(0,t.jsx)(e.code,{children:"mutex"}),"\u662f\u5426\u5df2\u7ecf\u4e0a\u9501\u3002"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u6ca1\u6709\u9501\u5b9a\uff0c\u5219\u5bf9",(0,t.jsx)(e.code,{children:"mutex"}),"\u8fdb\u884c\u4e0a\u9501\u3002"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u5df2\u7ecf\u9501\u5b9a\uff0c\u5219\u9677\u5165\u7b49\u5f85\uff0c\u76f4\u5230",(0,t.jsx)(e.code,{children:"mutex"}),"\u88ab\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u89e3\u9501\u540e\uff0c\u624d\u518d\u6b21\u4e0a\u9501\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u800c\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock()"}),"\u5219\u4f1a\u8fdb\u884c\u89e3\u9501\u64cd\u4f5c\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u4fdd\u8bc1",(0,t.jsx)(e.code,{children:"mtx.lock()"}),"\u548c",(0,t.jsx)(e.code,{children:"mtx.unlock()"}),"\u4e4b\u95f4\u7684\u4ee3\u7801\u6bb5\uff0c\u540c\u4e00\u65f6\u95f4\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5728\u6267\u884c\uff0c\u4ece\u800c\u907f\u514d\u6570\u636e\u7ade\u4e89\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <thread>\n#include <vector>\n#include <mutex>\n\nint main() {\n    std::vector<int> arr;\n    std::mutex mtx;\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            mtx.lock();\n            arr.push_back(1);\n            mtx.unlock();\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            mtx.lock();\n            arr.push_back(2);\n            mtx.unlock();\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"533-stdlock_guard-\u7b26\u5408-raii-\u601d\u60f3\u7684\u4e0a\u9501\u548c\u89e3\u9501",children:"5.3.3 std::lock_guard: \u7b26\u5408 RAII \u601d\u60f3\u7684\u4e0a\u9501\u548c\u89e3\u9501"}),"\n",(0,t.jsx)(e.p,{children:"\u6839\u636e RAII \u601d\u60f3\uff0c\u53ef\u5c06\u9501\u7684\u6301\u6709\u89c6\u4e3a\u8d44\u6e90\uff0c\u4e0a\u9501\u89c6\u4e3a\u9501\u7684\u83b7\u53d6\uff0c\u89e3\u9501\u89c6\u4e3a\u9501\u7684\u91ca\u653e\u3002"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u5c31\u662f\u8fd9\u6837\u4e00\u4e2a\u5de5\u5177\u7c7b\uff0c\u4ed6\u7684",(0,t.jsx)(e.code,{children:"\u6784\u9020\u51fd\u6570"}),"\u91cc\u4f1a\u8c03\u7528",(0,t.jsx)(e.code,{children:"mtx.lock()"}),"\uff0c",(0,t.jsx)(e.code,{children:"\u89e3\u6784\u51fd\u6570"}),"\u4f1a\u8c03\u7528",(0,t.jsx)(e.code,{children:"mtx.unlock()"}),"\u3002\u4ece\u800c",(0,t.jsx)(e.strong,{children:"\u9000\u51fa\u51fd\u6570\u4f5c\u7528\u57df\u65f6\u80fd\u591f\u81ea\u52a8\u89e3\u9501"}),"\uff0c\u907f\u514d\u7a0b\u5e8f\u5458\u7c97\u5fc3\u4e0d\u5c0f\u5fc3\u5fd8\u8bb0\u89e3\u9501(\u6216\u8005\u5f02\u5e38)\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <mutex>\n\nint main() {\n    std::vector<int> arr;\n    std::mutex mtx;\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            std::lock_guard grd(mtx);\n            arr.push_back(1);\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            std::lock_guard grd(mtx);\n            arr.push_back(2);\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"534-stdunique_lock-\u4e5f\u7b26\u5408-raii-\u601d\u60f3\u4f46\u81ea\u7531\u5ea6\u66f4\u9ad8",children:"5.3.4 std::unique_lock: \u4e5f\u7b26\u5408 RAII \u601d\u60f3\uff0c\u4f46\u81ea\u7531\u5ea6\u66f4\u9ad8"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u4e25\u683c\u5728\u89e3\u6784\u65f6",(0,t.jsx)(e.code,{children:"unlock()"}),"\uff0c\u4f46\u662f\u6709\u65f6\u5019\u6211\u4eec\u4f1a\u5e0c\u671b\u63d0\u524d",(0,t.jsx)(e.code,{children:"unlock()"}),"\u3002\u8fd9\u65f6\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\uff0c\u4ed6\u989d\u5916\u5b58\u50a8\u4e86\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"flag"}),"\u8868\u793a\u662f\u5426\u5df2\u7ecf\u88ab\u91ca\u653e\u3002\u4ed6\u4f1a\u5728\u89e3\u6784\u68c0\u6d4b\u8fd9\u4e2a",(0,t.jsx)(e.code,{children:"flag"}),"\uff0c\u5982\u679c\u6ca1\u6709\u91ca\u653e\uff0c\u5219\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock()"}),"\uff0c\u5426\u5219\u4e0d\u8c03\u7528\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u7136\u540e\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528",(0,t.jsx)(e.code,{children:"unique_lock"}),"\u7684",(0,t.jsx)(e.code,{children:"unlock()"}),"\u51fd\u6570\u6765\u63d0\u524d\u89e3\u9501\uff0c\u4f46\u662f\u5373\u4f7f\u5fd8\u8bb0\u89e3\u9501\u4e5f\u6ca1\u5173\u7cfb\uff0c\u9000\u51fa\u4f5c\u7528\u57df\u65f6\u5019\u4ed6\u8fd8\u4f1a\u81ea\u52a8\u68c0\u67e5\u4e00\u904d\u8981\u4e0d\u8981\u89e3\u9501\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::thread t2([&] {\n    for (int i = 0; i < 1000; i++) {\n        std::unique_lock grd(mtx);\n        arr.push_back(2);\n        grd.unlock();\n        printf("outside of lock\\n");\n        // grd.lock();  // \u5982\u679c\u9700\u8981\uff0c\u8fd8\u53ef\u4ee5\u91cd\u65b0\u4e0a\u9501\n    }\n});\n'})}),"\n",(0,t.jsx)(e.h3,{id:"535-stdunique_lock-\u7528-stddefer_lock-\u4f5c\u4e3a\u53c2\u6570",children:"5.3.5 std::unique_lock: \u7528 std::defer_lock \u4f5c\u4e3a\u53c2\u6570"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\u7684\u6784\u9020\u51fd\u6570\u8fd8\u53ef\u4ee5\u6709\u4e00\u4e2a\u989d\u5916\u53c2\u6570\uff0c\u90a3\u5c31\u662f",(0,t.jsx)(e.code,{children:"std::defer_lock"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u6307\u5b9a\u4e86\u8fd9\u4e2a\u53c2\u6570\u7684\u8bdd\uff0c",(0,t.jsx)(e.code,{children:"std::unique_lock"}),(0,t.jsx)(e.strong,{children:"\u4e0d\u4f1a\u5728\u6784\u9020\u51fd\u6570\u4e2d"}),"\u8c03\u7528",(0,t.jsx)(e.code,{children:"mtx.lock()"}),"\uff0c\u9700\u8981\u4e4b\u540e\u518d",(0,t.jsx)(e.strong,{children:"\u624b\u52a8\u8c03\u7528"}),(0,t.jsx)(e.code,{children:"grd.lock()"}),"\u624d\u80fd\u4e0a\u9501\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u597d\u5904\u4f9d\u7136\u662f\u5373\u4f7f\u5fd8\u8bb0",(0,t.jsx)(e.code,{children:"grd.unlock()"}),"\u4e5f\u80fd\u591f\u81ea\u52a8\u8c03\u7528",(0,t.jsx)(e.code,{children:"mtx.unlock()"}),"\u3002"]}),"\n",(0,t.jsxs)(e.div,{className:"markdown-alert markdown-alert-tip",children:["\n",(0,t.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,t.jsx)(e.span,{className:"octicon octicon-tip",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-light-bulb mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Tip"]}),"\n",(0,t.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u4e00\u4e0b",(0,t.jsx)(e.code,{children:"std::defer_lock_t"}),"\uff0c\u662f\u4e2a\u7a7a\u7684\u7c7b\uff0c\u5176\u5b9e\u8fd9\u79cd\u7528\u4e00\u4e2a\u7a7a",(0,t.jsx)(e.code,{children:"tag"}),"\u7c7b\u6765\u533a\u5206\u4e0d\u540c\u6784\u9020\u51fd\u6570\u7684\u601d\u60f3\u5728 C++ \u4e2d\u5f88\u5e38\u89c1\uff0c\u5305\u62ec",(0,t.jsx)(e.code,{children:"std::inplace"}),", ",(0,t.jsx)(e.code,{children:"std::piecewise_construct"}),"\u7b49\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"// Implementation details for std::condition_variable\nclass __condvar {\n  /// Do not acquire ownership of the mutex.\n  struct defer_lock_t { explicit defer_lock_t() = default; };\n\n  /// Tag used to prevent a scoped lock from acquiring ownership of a mutex.\n  _GLIBCXX17_INLINE constexpr defer_lock_t defer_lock { };\n};\n"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::thread t2([&] {\n    for (int i = 0; i < 1000; i++) {\n        std::unique_lock grd(mtx, std::defer_lock);\n        printf("before the lock\\n");\n        grd.lock();\n        arr.push_back(2);\n        grd.unlock();\n        printf("outside of lock\\n");\n    }\n})\n'})}),"\n",(0,t.jsx)(e.h3,{id:"536-\u591a\u4e2a\u5bf9\u8c61-\u6bcf\u4e2a\u5bf9\u8c61\u4e00\u4e2a-mutex-\u5373\u53ef",children:"5.3.6 \u591a\u4e2a\u5bf9\u8c61? \u6bcf\u4e2a\u5bf9\u8c61\u4e00\u4e2a mutex \u5373\u53ef"}),"\n",(0,t.jsx)(e.p,{children:"mtx1 \u7528\u6765\u9501\u5b9a arr1\uff0cmtx2 \u7528\u6765\u9501\u5b9a arr2\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u4e0d\u540c\u7684\u5bf9\u8c61\uff0c\u5404\u6709\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"mutex"}),"\uff0c\u72ec\u7acb\u5730\u4e0a\u9501\uff0c\u53ef\u4ee5\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u9501\u5b9a\uff0c\u63d0\u5347\u9ad8\u5e76\u53d1\u65f6\u7684\u6027\u80fd\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd8\u7528\u4e86\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"{}"}),"\u5305\u4f4f",(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\uff0c\u9650\u5236\u5176\u53d8\u91cf\u7684\u4f5c\u7528\u57df\uff0c\u4ece\u800c\u53ef\u4ee5\u8ba9\u4ed6\u5728",(0,t.jsx)(e.code,{children:"}"}),"\u4e4b\u524d\u89e3\u6784\u5e76\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock()"}),"\uff0c\u4e5f\u907f\u514d\u4e86\u548c\u4e0b\u9762\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"lock_guard"}),"\u53d8\u91cf\u540d\u51b2\u7a81\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    std::vector<int> arr1;\n    std::mutex mtx1;\n\n    std::vector<int> arr2;\n    std::mutex mtx2;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            {\n                std::lock_guard grd(mtx1);\n                arr1.push_back(1);\n            }\n\n            {\n                std::lock_guard grd(mtx2);\n                arr2.push_back(1);\n            }\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            {\n                std::lock_guard grd(mtx1);\n                arr1.push_back(2);\n            }\n\n            {\n                std::lock_guard grd(mtx2);\n                arr2.push_back(2);\n            }\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"537-\u5982\u679c\u4e0a\u9501\u5931\u8d25\u4e0d\u8981\u7b49\u5f85-try_lock",children:"5.3.7 \u5982\u679c\u4e0a\u9501\u5931\u8d25\uff0c\u4e0d\u8981\u7b49\u5f85: try_lock()"}),"\n",(0,t.jsxs)(e.p,{children:["\u6211\u4eec\u8bf4\u8fc7",(0,t.jsx)(e.code,{children:"lock()"}),"\u5982\u679c\u53d1\u73b0",(0,t.jsx)(e.code,{children:"mutex"}),"\u5df2\u7ecf\u4e0a\u9501\u7684\u8bdd\uff0c\u4f1a\u7b49\u5f85\u4ed6\u76f4\u5230\u4ed6\u89e3\u9501\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u4e5f\u53ef\u4ee5\u7528\u65e0\u963b\u585e\u7684",(0,t.jsx)(e.code,{children:"try_lock()"}),"\uff0c\u4ed6\u5728\u4e0a\u9501\u5931\u8d25\u65f6\u4e0d\u4f1a\u9677\u5165\u7b49\u5f85\uff0c\u800c\u662f\u76f4\u63a5\u8fd4\u56de",(0,t.jsx)(e.code,{children:"false"}),"\uff1b\u5982\u679c\u4e0a\u9501\u6210\u529f\uff0c\u5219\u4f1a\u8fd4\u56de",(0,t.jsx)(e.code,{children:"true"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u6bd4\u5982\u53f3\u8fb9\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u7b2c\u4e00\u6b21\u4e0a\u9501\uff0c\u56e0\u4e3a\u8fd8\u6ca1\u6709\u4eba\u4e0a\u9501\uff0c\u6240\u4ee5\u6210\u529f\u4e86\uff0c\u8fd4\u56de",(0,t.jsx)(e.code,{children:"true"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u7b2c\u4e8c\u6b21\u4e0a\u9501\uff0c\u7531\u4e8e\u81ea\u5df1\u5df2\u7ecf\u4e0a\u9501\uff0c\u6240\u4ee5\u5931\u8d25\u4e86\uff0c\u8fd4\u56de",(0,t.jsx)(e.code,{children:"false"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::mutex mtx1;\n\nint main() {\n    if (mtx1.try_lock())\n        printf("succeed\\n");\n    else\n        printf("failed\\n");\n\n    if (mtx1.try_lock())\n        printf("succeed\\n");\n    else\n        printf("failed\\n");\n\n    mtx1.unlock();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"538-\u53ea\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4-try_lock_for",children:"5.3.8 \u53ea\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4: try_lock_for()"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"try_lock()"}),"\u78b0\u5230\u5df2\u7ecf\u4e0a\u9501\u7684\u60c5\u51b5\uff0c\u4f1a\u7acb\u5373\u8fd4\u56de",(0,t.jsx)(e.code,{children:"false"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u9700\u8981\u7b49\u5f85\uff0c\u4f46\u4ec5\u9650\u4e00\u6bb5\u65f6\u95f4\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::timed_mutex"}),"\u7684",(0,t.jsx)(e.code,{children:"try_lock_for()"}),"\u51fd\u6570\uff0c\u4ed6\u7684\u53c2\u6570\u662f\u6700\u957f\u7b49\u5f85\u65f6\u95f4\uff0c\u540c\u6837\u662f\u7531",(0,t.jsx)(e.code,{children:"chrono"}),"\u6307\u5b9a\u65f6\u95f4\u5355\u4f4d\u3002\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\u8fd8\u6ca1\u6210\u529f\u5c31\u4f1a\u201c\u4e0d\u8010\u70e6\u5730\u201d\u5931\u8d25\u5e76\u8fd4\u56de",(0,t.jsx)(e.code,{children:"false"}),"\uff1b\u5982\u679c\u8fd9\u4e2a\u65f6\u95f4\u5185\u4e0a\u9501\u6210\u529f\u5219\u8fd4\u56de",(0,t.jsx)(e.code,{children:"true"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u540c\u7406\u8fd8\u6709\u63a5\u53d7\u65f6\u95f4\u70b9\u7684",(0,t.jsx)(e.code,{children:"try_lock_until()"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::timed_mutex mtx1;\n\nint main() {\n    if (mtx1.try_lock_for(std::chrono::milliseconds(500)))\n        printf("succeed\\n");\n    else\n        printf("failed\\n");\n\n    if (mtx1.try_lock_for(std::chrono::milliseconds(500)))\n        printf("succeed\\n");\n    else\n        printf("failed\\n");\n\n    mtx1.unlock();\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"539-stdunique_lock-\u7528-stdtry_to_lock-\u505a\u53c2\u6570",children:"5.3.9 std::unique_lock: \u7528 std::try_to_lock \u505a\u53c2\u6570"}),"\n",(0,t.jsxs)(e.p,{children:["\u548c\u65e0\u53c2\u6570\u76f8\u6bd4\uff0c\u4ed6\u4f1a\u8c03\u7528",(0,t.jsx)(e.code,{children:"mtx1.try_lock()"}),"\u800c\u4e0d\u662f",(0,t.jsx)(e.code,{children:"mtx1.lock()"}),"\u3002\u4e4b\u540e\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"grd.owns_lock()"}),"\u5224\u65ad\u662f\u5426\u4e0a\u9501\u6210\u529f\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::mutex mtx;\nstd::thread t1([&] {\n    std::unique_lock grd(mtx, std::try_to_lock);\n    if (grd.owns_lock())\n        printf("t1 success\\n");\n    else\n        printf("t1 failed\\n");\n    std::this_thread::sleep_for(std::chrono::milliseconds(1000));\n});\n'})}),"\n",(0,t.jsx)(e.h3,{id:"5310-stdunique_lock-\u7528-stdadopt_lock-\u505a\u53c2\u6570",children:"5.3.10 std::unique_lock: \u7528 std::adopt_lock \u505a\u53c2\u6570"}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u5f53\u524d",(0,t.jsx)(e.code,{children:"mutex"}),"\u5df2\u7ecf\u4e0a\u9501\u4e86\uff0c\u4f46\u662f\u4e4b\u540e\u4ecd\u7136\u5e0c\u671b\u7528 RAII \u601d\u60f3\u5728\u89e3\u6784\u65f6\u5019\u81ea\u52a8\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock()"}),"\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::adopt_lock"}),"\u4f5c\u4e3a",(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\u6216",(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\uff0c\u8fd9\u65f6\u4ed6\u4eec\u4f1a\u9ed8\u8ba4 mtx \u5df2\u7ecf\u4e0a\u9501\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::mutex mtx;\nstd::thread t2([&] {\n    mtx.lock();\n    std::unique_lock grd(mtx, std::adopt_lock);\n    printf("t2 owns the lock\\n");\n    std::this_thread::sleep_for(std::chrono::milliseconds(1000));\n});\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u5f53\u7136, \u4ece\u6e90\u7801\u4e0a\u770b, \u4e5f\u662f\u5f88\u6e05\u6670\u7684:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"unique_lock() noexcept\n: _M_device(0), _M_owns(false)\n{ }\n\nexplicit unique_lock(mutex_type& __m) // \u4f20\u5165\u9501\n: _M_device(std::__addressof(__m)), _M_owns(false) // \u521d\u59cb\u5316\n{\nlock(); // \u4e0a\u9501: \u5982\u679c\u5df2\u7ecf\u9501\u4e86\u4f1a\u62a5\u9519\n_M_owns = true; // \u9501\u4e0a\n}\n\nunique_lock(mutex_type& __m, defer_lock_t) noexcept\n: _M_device(std::__addressof(__m)), _M_owns(false) // \u521d\u59cb\u5316, \u6ca1\u6709\u4e0a\u9501\n{ } // \u4e0d\u6267\u884c, \u9700\u8981\u7528\u6237 \u624b\u52a8\u8c03\u7528grd.lock()\n\nunique_lock(mutex_type& __m, try_to_lock_t)\n: _M_device(std::__addressof(__m)), _M_owns(_M_device->try_lock()) // \u5c1d\u8bd5\u4e0a\u9501, \u8fd4\u56de\u503c\u5c31\u662f \u9501\u662f\u5426\u9501\u4e0a\u4e86\n{ }\n\nunique_lock(mutex_type& __m, adopt_lock_t) noexcept\n: _M_device(std::__addressof(__m)), _M_owns(true) // \u9ed8\u8ba4\u7528\u6237\u5df2\u7ecf\u4e0a\u9501, \u4e0d\u518d lock();\n{\n// XXX calling thread owns mutex\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"5311-stdunique_lock-\u548c-stdmutex-\u5177\u6709\u540c\u6837\u7684\u63a5\u53e3",children:"5.3.11 std::unique_lock \u548c std::mutex \u5177\u6709\u540c\u6837\u7684\u63a5\u53e3"}),"\n",(0,t.jsxs)(e.p,{children:["\u5176\u5b9e",(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\u5177\u6709",(0,t.jsx)(e.code,{children:"mutex"}),"\u7684\u6240\u6709\u6210\u5458\u51fd\u6570: ",(0,t.jsx)(e.code,{children:"lock()"}),",",(0,t.jsx)(e.code,{children:"unlock()"}),",",(0,t.jsx)(e.code,{children:"try_lock()"}),",",(0,t.jsx)(e.code,{children:"try_lock_for()"}),"\u7b49\u3002\u9664\u4e86\u4ed6\u4f1a\u5728\u89e3\u6784\u65f6\u6309\u9700\u81ea\u52a8\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock()"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u56e0\u4e3a",(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u65e0\u975e\u662f\u8c03\u7528\u5176\u6784\u9020\u53c2\u6570\u540d\u4e3a",(0,t.jsx)(e.code,{children:"lock()"}),"\u7684\u6210\u5458\u51fd\u6570\uff0c\u6240\u4ee5",(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\u4e5f\u53ef\u4ee5\u4f5c\u4e3a",(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u7684\u6784\u9020\u53c2\u6570\uff01"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u79cd\u53ea\u8981\u5177\u6709\u67d0\u4e9b\u6307\u5b9a\u540d\u5b57\u7684\u6210\u5458\u51fd\u6570\uff0c\u5c31\u5224\u65ad\u4e00\u4e2a\u7c7b\u662f\u5426\u6ee1\u8db3\u67d0\u4e9b\u529f\u80fd\u7684\u601d\u60f3\uff0c\u5728 Python \u79f0\u4e3a",(0,t.jsx)(e.code,{children:"\u9e2d\u5b50\u7c7b\u578b"}),"\uff0c\u800c C++ \u79f0\u4e3a ",(0,t.jsx)(e.strong,{children:"concept(\u6982\u5ff5)"}),"\u3002\u6bd4\u8d77\u865a\u51fd\u6570\u548c\u52a8\u6001\u591a\u6001\u7684\u63a5\u53e3\u62bd\u8c61\uff0cconcept \u4f7f\u5b9e\u73b0\u548c\u63a5\u53e3\u66f4\u52a0",(0,t.jsx)(e.code,{children:"\u89e3\u8026\u5408"}),"\u4e14",(0,t.jsx)(e.strong,{children:"\u6ca1\u6709\u6027\u80fd\u635f\u5931"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'std::mutex mtx;\nstd::thread t1([&] {\n    std::unique_lock grd(mtx, std::defer_lock);\n    std::lock_guard grd2(grd);\n    printf("t1 owns the lock\\n");\n    std::this_thread::sleep_for(std::chrono::milliseconds(1000));\n});\n'})}),"\n",(0,t.jsx)(e.h2,{id:"54-\u7b2c4\u7ae0-\u6b7b\u9501",children:"5.4 \u7b2c4\u7ae0: \u6b7b\u9501"}),"\n",(0,t.jsx)(e.h3,{id:"541-\u540c\u65f6\u9501\u4f4f\u591a\u4e2a-mutex-\u6b7b\u9501\u96be\u9898",children:"5.4.1 \u540c\u65f6\u9501\u4f4f\u591a\u4e2a mutex: \u6b7b\u9501\u96be\u9898"}),"\n",(0,t.jsx)(e.p,{children:"\u7531\u4e8e\u540c\u65f6\u6267\u884c\u7684\u4e24\u4e2a\u7ebf\u7a0b\uff0c\u4ed6\u4eec\u4e2d\u53d1\u751f\u7684\u6307\u4ee4\u4e0d\u4e00\u5b9a\u662f\u540c\u6b65\u7684\uff0c\u56e0\u6b64\u6709\u53ef\u80fd\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"t1 \u6267\u884c mtx1.lock()\u3002"}),"\n",(0,t.jsx)(e.li,{children:"t2 \u6267\u884c mtx2.lock()\u3002"}),"\n",(0,t.jsx)(e.li,{children:"t1 \u6267\u884c mtx2.lock(): \u5931\u8d25\uff0c\u9677\u5165\u7b49\u5f85"}),"\n",(0,t.jsx)(e.li,{children:"t2 \u6267\u884c mtx1.lock(): \u5931\u8d25\uff0c\u9677\u5165\u7b49\u5f85"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u53cc\u65b9\u90fd\u5728\u7b49\u7740\u5bf9\u65b9\u91ca\u653e\u9501\uff0c\u4f46\u662f\u56e0\u4e3a\u7b49\u5f85\u800c\u65e0\u6cd5\u91ca\u653e\u9501\uff0c\u4ece\u800c\u8981\u65e0\u9650\u5236\u7b49\u4e0b\u53bb\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u79cd\u73b0\u8c61\u79f0\u4e3a",(0,t.jsx)(e.strong,{children:"\u6b7b\u9501(dead-lock)"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    std::mutex mtx1;\n    std::mutex mtx2;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            mtx1.lock();\n            mtx2.lock();\n            mtx2.unlock();\n            mtx1.unlock();\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            mtx2.lock();\n            mtx1.lock();\n            mtx1.unlock();\n            mtx2.unlock();\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"542-\u89e3\u51b31-\u6c38\u8fdc\u4e0d\u8981\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501",children:"5.4.2 \u89e3\u51b31: \u6c38\u8fdc\u4e0d\u8981\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501"}),"\n",(0,t.jsxs)(e.p,{children:["\u6700\u4e3a\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u5c31\u662f",(0,t.jsx)(e.strong,{children:"\u4e00\u4e2a\u7ebf\u7a0b\u6c38\u8fdc\u4e0d\u8981\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501"}),"(\u4f46\u662f\u6709\u65f6\u5019\u53ef\u80fd\u4f1a\u6709\u8fd9\u4e2a\u9700\u6c42)\uff0c\u5206\u522b\u4e0a\u9501\uff0c\u8fd9\u6837\u4e5f\u53ef\u4ee5\u907f\u514d\u6b7b\u9501\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u56e0\u6b64\u8fd9\u91cc\u53cc\u65b9\u90fd\u5728",(0,t.jsx)(e.code,{children:"mtx1.unlock()"}),"\u4e4b\u540e\u624d",(0,t.jsx)(e.code,{children:"mtx2.lock()"}),"\uff0c\u4ece\u800c\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u4e00\u65b9\u7b49\u7740\u5bf9\u65b9\u7684\u540c\u65f6\u6301\u6709\u4e86\u5bf9\u65b9\u7b49\u7740\u7684\u9501\u7684\u60c5\u51b5\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::thread t1([&] {\n    for (int i = 0; i < 1000; i++) {\n        mtx1.lock();\n        mtx1.unlock();\n        mtx2.lock();\n        mtx2.unlock();\n    }\n});\nstd::thread t2([&] {\n    for (int i = 0; i < 1000; i++) {\n        mtx2.lock();\n        mtx2.unlock();\n        mtx1.lock();\n        mtx1.unlock();\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"543-\u89e3\u51b32-\u4fdd\u8bc1\u53cc\u65b9\u4e0a\u9501\u987a\u5e8f\u4e00\u81f4",children:"5.4.3 \u89e3\u51b32: \u4fdd\u8bc1\u53cc\u65b9\u4e0a\u9501\u987a\u5e8f\u4e00\u81f4"}),"\n",(0,t.jsx)(e.p,{children:"\u5176\u5b9e\uff0c\u53ea\u9700\u4fdd\u8bc1\u53cc\u65b9\u4e0a\u9501\u7684\u987a\u5e8f\u4e00\u81f4\uff0c\u5373\u53ef\u907f\u514d\u6b7b\u9501\u3002\u56e0\u6b64\u8fd9\u91cc\u8c03\u6574 t2 \u4e5f\u53d8\u4e3a\u5148\u9501 mtx1\uff0c\u518d\u9501 mtx2\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u65f6\uff0c\u65e0\u8bba\u5b9e\u9645\u6267\u884c\u987a\u5e8f\u662f\u600e\u6837\uff0c\u90fd\u4e0d\u4f1a\u51fa\u73b0\u4e00\u65b9\u7b49\u7740\u5bf9\u65b9\u7684\u540c\u65f6\u6301\u6709\u4e86\u5bf9\u65b9\u7b49\u7740\u7684\u9501\u7684\u60c5\u51b5\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::thread t1([&] {\n    for (int i = 0; i < 1000; i++) {\n        mtx1.lock();\n        mtx2.lock();\n        mtx2.unlock();\n        mtx1.unlock();\n    }\n});\nstd::thread t2([&] {\n    for (int i = 0; i < 1000; i++) {\n        mtx1.lock();\n        mtx2.lock();\n        mtx2.unlock();\n        mtx1.unlock();\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"544-\u89e3\u51b33-\u7528-stdlock-\u540c\u65f6\u5bf9\u591a\u4e2a\u4e0a\u9501",children:"5.4.4 \u89e3\u51b33: \u7528 std::lock \u540c\u65f6\u5bf9\u591a\u4e2a\u4e0a\u9501"}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u6ca1\u529e\u6cd5\u4fdd\u8bc1\u4e0a\u9501\u987a\u5e8f\u4e00\u81f4\uff0c\u53ef\u4ee5\u7528\u6807\u51c6\u5e93\u7684",(0,t.jsx)(e.code,{children:"std::lock(mtx1, mtx2, ...)"}),"\u51fd\u6570\uff0c\u4e00\u6b21\u6027\u5bf9\u591a\u4e2a mutex \u4e0a\u9501\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u4ed6\u63a5\u53d7\u4efb\u610f\u591a\u4e2a mutex \u4f5c\u4e3a\u53c2\u6570\uff0c\u5e76\u4e14\u4ed6\u4fdd\u8bc1\u5728\u65e0\u8bba\u4efb\u610f\u7ebf\u7a0b\u4e2d\u8c03\u7528\u7684\u987a\u5e8f\u662f\u5426\u76f8\u540c\uff0c\u90fd\u4e0d\u4f1a\u4ea7\u751f\u6b7b\u9501\u95ee\u9898\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::thread t1([&] {\n    for (int i = 0; i < 1000; i++) {\n        std::lock(mtx1, mtx2);\n        mtx1.unlock();\n        mtx2.unlock();\n    }\n});\nstd::thread t2([&] {\n    for (int i = 0; i < 1000; i++) {\n        std::lock(mtx2, mtx1);\n        mtx2.unlock();\n        mtx1.unlock();\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"545-stdlock-\u7684-raii-\u7248\u672c-stdscoped_lock",children:"5.4.5 std::lock \u7684 RAII \u7248\u672c: std::scoped_lock"}),"\n",(0,t.jsxs)(e.p,{children:["\u548c",(0,t.jsx)(e.code,{children:"std::lock_guard"}),"\u76f8\u5bf9\u5e94\uff0c",(0,t.jsx)(e.code,{children:"std::lock"}),"\u4e5f\u6709 RAII \u7684\u7248\u672c",(0,t.jsx)(e.code,{children:"std::scoped_lock"}),"\u3002\u53ea\u4e0d\u8fc7\u4ed6\u53ef\u4ee5\u540c\u65f6\u5bf9\u591a\u4e2a mutex \u4e0a\u9501\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    std::mutex mtx1;\n    std::mutex mtx2;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 1000; i++) {\n            std::scoped_lock grd(mtx1, mtx2);\n            // do something\n        }\n    });\n    std::thread t2([&] {\n        for (int i = 0; i < 1000; i++) {\n            std::scoped_lock grd(mtx2, mtx1);\n            // do something\n        }\n    });\n    t1.join();\n    t2.join();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"546-\u540c\u4e00\u4e2a\u7ebf\u7a0b\u91cd\u590d\u8c03\u7528-lock-\u4e5f\u4f1a\u9020\u6210\u6b7b\u9501",children:"5.4.6 \u540c\u4e00\u4e2a\u7ebf\u7a0b\u91cd\u590d\u8c03\u7528 lock() \u4e5f\u4f1a\u9020\u6210\u6b7b\u9501"}),"\n",(0,t.jsxs)(e.p,{children:["\u9664\u4e86\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u6301\u6709\u4e24\u4e2a\u9501\u4f1a\u9020\u6210\u6b7b\u9501\u5916\uff0c\u5373\u4f7f\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4e00\u4e2a\u9501\uff0c\u5982\u679c",(0,t.jsx)(e.code,{children:"lock()"}),"\u4ee5\u540e\u53c8\u8c03\u7528",(0,t.jsx)(e.code,{children:"lock()"}),"\uff0c\u4e5f\u4f1a\u9020\u6210\u6b7b\u9501\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u6bd4\u5982\u53f3\u8fb9\u7684",(0,t.jsx)(e.code,{children:"func"}),"\u51fd\u6570\uff0c\u4e0a\u4e86\u9501\u4e4b\u540e\uff0c\u53c8\u8c03\u7528\u4e86",(0,t.jsx)(e.code,{children:"other"}),"\u51fd\u6570\uff0c\u4ed6\u4e5f\u9700\u8981\u4e0a\u9501\u3002\u800c",(0,t.jsx)(e.code,{children:"other"}),"\u770b\u5230",(0,t.jsx)(e.code,{children:"mtx1"}),"\u5df2\u7ecf\u4e0a\u9501\uff0c\u8fd8\u4ee5\u4e3a\u662f\u522b\u7684\u7ebf\u7a0b\u4e0a\u7684\u9501\uff0c\u4e8e\u662f\u9677\u5165\u7b49\u5f85\u3002\u6b8a\u4e0d\u77e5\u662f\u8c03\u7528\u4ed6\u7684",(0,t.jsx)(e.code,{children:"func"}),"\u4e0a\u7684\u9501\uff0c",(0,t.jsx)(e.code,{children:"other"}),"\u9677\u5165\u7b49\u5f85\u540e",(0,t.jsx)(e.code,{children:"func"}),"\u91cc\u7684",(0,t.jsx)(e.code,{children:"unlock()"}),"\u6c38\u8fdc\u5f97\u4e0d\u5230\u8c03\u7528\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::mutex mtx1;\n\nvoid other() {\n    mtx1.lock();\n    // do something\n    mtx1.unlock();\n}\n\nvoid func() {\n    mtx1.lock();\n    other();\n    mtx1.unlock();\n}\n\nint main() {\n    func();\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"547-\u89e3\u51b31-other-\u91cc\u4e0d\u8981\u518d\u4e0a\u9501",children:"5.4.7 \u89e3\u51b31: other \u91cc\u4e0d\u8981\u518d\u4e0a\u9501"}),"\n",(0,t.jsxs)(e.p,{children:["\u9047\u5230\u8fd9\u79cd\u60c5\u51b5\u6700\u597d\u662f\u628a",(0,t.jsx)(e.code,{children:"other"}),"\u91cc\u7684",(0,t.jsx)(e.code,{children:"lock()"}),"\u53bb\u6389\uff0c\u5e76\u5728\u5176\u6587\u6863\u4e2d\u8bf4\u660e: \u201cother \u4e0d\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u8c03\u7528\u672c\u51fd\u6570\u4e4b\u524d\u9700\u8981\u4fdd\u8bc1\u67d0 mutex \u5df2\u7ecf\u4e0a\u9501\u3002\u201d"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::mutex mtx1;\n\n/// NOTE: please lock mtx1 before calling other()\nvoid other() {\n    // do something\n}\n\nvoid func() {\n    mtx1.lock();\n    other();\n    mtx1.unlock();\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"548-\u89e3\u51b32-\u6539\u7528-stdrecursive_mutex",children:"5.4.8 \u89e3\u51b32: \u6539\u7528 std::recursive_mutex"}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u5b9e\u5728\u4e0d\u80fd\u6539\u7684\u8bdd\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::recursive_mutex"}),"\u3002\u4ed6\u4f1a\u81ea\u52a8\u5224\u65ad\u662f\u4e0d\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b",(0,t.jsx)(e.code,{children:"lock()"}),"\u4e86\u591a\u6b21\u540c\u4e00\u4e2a\u9501\uff0c\u5982\u679c\u662f\u5219\u8ba9\u8ba1\u6570\u5668\u52a01\uff0c\u4e4b\u540e",(0,t.jsx)(e.code,{children:"unlock()"}),"\u4f1a\u8ba9\u8ba1\u6570\u5668\u51cf1\uff0c\u51cf\u52300\u65f6\u624d\u771f\u6b63\u89e3\u9501\u3002\u4f46\u662f\u76f8\u6bd4\u666e\u901a\u7684",(0,t.jsx)(e.code,{children:"std::mutex"}),(0,t.jsx)(e.strong,{children:"\u6709\u4e00\u5b9a\u6027\u80fd\u635f\u5931"}),"\u3002"]}),"\n",(0,t.jsxs)(e.div,{className:"markdown-alert markdown-alert-tip",children:["\n",(0,t.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,t.jsx)(e.span,{className:"octicon octicon-tip",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-light-bulb mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Tip"]}),"\n",(0,t.jsxs)(e.p,{children:["\u540c\u7406\u8fd8\u6709",(0,t.jsx)(e.code,{children:"std::recursive_timed_mutex"}),"\uff0c\u5982\u679c\u4f60\u540c\u65f6\u9700\u8981",(0,t.jsx)(e.code,{children:"try_lock_for()"}),"\u7684\u8bdd\u3002"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::recursive_mutex mtx1;\n\nvoid other() {\n    mtx1.lock();\n    // do something\n    mtx1.unlock();\n}\n\nvoid func() {\n    mtx1.lock();\n    other();\n    mtx1.unlock();\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"55-\u7b2c5\u7ae0-\u6570\u636e\u7ed3\u6784",children:"5.5 \u7b2c5\u7ae0: \u6570\u636e\u7ed3\u6784"}),"\n",(0,t.jsx)(e.h3,{id:"551-\u6848\u4f8b-\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u4f7f\u7528-stdvector",children:"5.5.1 \u6848\u4f8b: \u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u4f7f\u7528 std::vector"}),"\n",(0,t.jsx)(e.p,{children:"\u521a\u624d\u8bf4\u4e86\uff0cvector \u4e0d\u662f\u591a\u7ebf\u7a0b\u5b89\u5168\u7684\u5bb9\u5668\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8bbf\u95ee\u540c\u4e00\u4e2a vector \u4f1a\u51fa\u73b0\u6570\u636e\u7ade\u4e89\uff08data-race\uff09\u73b0\u8c61\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5c01\u88c5\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684 vector"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u56e0\u6b64\uff0c\u53ef\u4ee5\u7528\u4e00\u4e2a\u7c7b\u5c01\u88c5\u4e00\u4e0b\u5bf9 vector \u7684\u8bbf\u95ee\uff0c\u4f7f\u5176\u8bbf\u95ee\u90fd\u53d7\u5230\u4e00\u4e2a mutex \u7684\u4fdd\u62a4\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u7136\u800c\u5374\u51fa\u9519\u4e86: \u56e0\u4e3a size() \u662f const \u51fd\u6570\uff0c\u800c",(0,t.jsx)(e.code,{children:"mutex::lock()"}),"\u5374\u4e0d\u662f",(0,t.jsx)(e.code,{children:"const"}),"\u7684\u3002"]}),"\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsx)(e.tr,{children:(0,t.jsx)(e.th,{style:{textAlign:"center"},children:"##container##"})})}),(0,t.jsx)(e.tbody,{children:(0,t.jsx)(e.tr,{children:(0,t.jsx)(e.td,{style:{textAlign:"center"},children:(0,t.jsx)(e.img,{alt:"Clip_2024-07-12_19-33-50.png ##w700##",src:d(99301).A+"",width:"1526",height:"767"})})})})]}),"\n",(0,t.jsx)(e.h3,{id:"552-\u903b\u8f91\u4e0a-const-\u800c\u90e8\u5206\u6210\u5458\u975e-const-mutable",children:"5.5.2 \u903b\u8f91\u4e0a const \u800c\u90e8\u5206\u6210\u5458\u975e const: mutable"}),"\n",(0,t.jsx)(e.p,{children:"\u6211\u4eec\u8981\u4e3a\u4e86\u652f\u6301 mutex \u800c\u653e\u5f03\u58f0\u660e size() \u4e3a const \u5417\uff1f"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u4e0d\u5fc5\uff0csize() \u5728\u903b\u8f91\u4e0a\u4ecd\u662f const \u7684\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u8ba9 this \u4e3a const \u65f6\u4ec5\u4ec5\u7ed9 m_mtx \u5f00\u540e\u95e8\uff0c\u53ef\u4ee5\u7528 mutable \u5173\u952e\u5b57\u4fee\u9970\u4ed6\uff0c\u4ece\u800c\u6240\u6709\u6210\u5458\u91cc\u53ea\u6709\u4ed6\u4e0d\u662f const \u7684\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"class MTVector {\n    std::vector<int> m_arr;\n    mutable std::mutex m_mtx; // mutable: \u6613\u53d8\u7684, \u6027\u60c5\u4e0d\u5b9a\u7684\n\npublic:\n    void push_back(int val) {\n        m_mtx.lock();\n        m_arr.push_back(val);\n        m_mtx.unlock();\n    }\n\n    size_t size() const { // \u6ca1\u6709\u62a5\u9519\u4e86\n        m_mtx.lock();\n        size_t ret = m_arr.size();\n        m_mtx.unlock();\n        return ret;\n    }\n};\n"})}),"\n",(0,t.jsx)(e.h3,{id:"553-\u4e3a\u4ec0\u4e48\u9700\u8981\u8bfb\u5199\u9501",children:"5.5.3 \u4e3a\u4ec0\u4e48\u9700\u8981\u8bfb\u5199\u9501"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u521a\u624d\u8bf4\u8fc7 mutex \u5c31\u50cf\u5395\u6240\uff0c\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u4eba\u80fd\u4e0a\u3002\u4f46\u662f\u5982\u679c\u201c\u4e0a\u201d\u6709\u4e24\u79cd\u65b9\u5f0f\u5462\uff1f"}),"\n",(0,t.jsxs)(e.li,{children:["\u5047\u8bbe\u5728\u5e73\u884c\u4e16\u754c\uff0c\u5395\u6240\u4e0d\u4e00\u5b9a\u662f\u7528\u6765\u62c9\u7684\uff0c\u8fd8\u53ef\u80fd\u662f\u7528\u6765\u559d\u7684 ",(0,t.jsx)(e.del,{children:"\u8bf7\u52ff\u5c1d\u8bd5"})]}),"\n",(0,t.jsx)(e.li,{children:"\u559d\u5395\u6240\u91cc\u7684\u6c34\u65f6\uff0c\u53ef\u4ee5\u591a\u4e2a\u4eba\u63d2\u7740\u5438\u7ba1\u4e00\u8d77\u559d\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u800c\u62c9\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u4e00\u4e2a\u4eba\u72ec\u5360\u5395\u6240\uff0c\u4e0d\u80fd\u591a\u4e2a\u4eba\u4e00\u8d77\u5f80\u91cc\u9762\u62c9\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u559d\u6c34\u7684\u4eba\u5982\u679c\u53d1\u73b0\u5395\u6240\u91cc\u5df2\u7ecf\u6709\u4eba\u5728\u62c9\uff0c\u90a3\u4ed6\u4e5f\u4e0d\u80fd\u53bb\u559d\uff0c\u5426\u5219\u4f1a\u559d\u5230\u201c\u810f\u6570\u636e\u201d\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u7ed3\u8bba: ",(0,t.jsx)(e.code,{children:"\u8bfb"}),"\u53ef\u4ee5\u5171\u4eab\uff0c",(0,t.jsx)(e.code,{children:"\u5199"}),"\u5fc5\u987b\u72ec\u5360\uff0c\u4e14",(0,t.jsx)(e.code,{children:"\u5199"}),"\u548c",(0,t.jsx)(e.code,{children:"\u8bfb"}),(0,t.jsx)(e.strong,{children:"\u4e0d\u80fd\u5171\u5b58"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u9488\u5bf9\u8fd9\u79cd\u66f4\u5177\u4f53\u7684\u60c5\u51b5\uff0c\u53c8\u53d1\u660e\u4e86",(0,t.jsx)(e.strong,{children:"\u8bfb\u5199\u9501"}),"\uff0c\u4ed6\u5141\u8bb8\u7684\u72b6\u6001\u6709:"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"n\u4e2a\u4eba\u8bfb\u53d6\uff0c\u6ca1\u6709\u4eba\u5199\u5165\u3002"}),"\n",(0,t.jsx)(e.li,{children:"1\u4e2a\u4eba\u5199\u5165\uff0c\u6ca1\u6709\u4eba\u8bfb\u53d6\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u6ca1\u6709\u4eba\u8bfb\u53d6\uff0c\u4e5f\u6ca1\u6709\u4eba\u5199\u5165\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"554-\u8bfb\u5199\u9501-shared_mutex",children:"5.5.4 \u8bfb\u5199\u9501: shared_mutex"}),"\n",(0,t.jsxs)(e.p,{children:["\u4e3a\u6b64\uff0c\u6807\u51c6\u5e93\u63d0\u4f9b\u4e86",(0,t.jsx)(e.code,{children:"std::shared_mutex"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u4e0a\u9501\u65f6\uff0c\u8981",(0,t.jsx)(e.code,{children:"\u6307\u5b9a\u4f60\u7684\u9700\u6c42"}),"\u662f\u62c9\u8fd8\u662f\u559d\uff0c\u8d1f\u8d23\u8c03\u5ea6\u7684\u8bfb\u5199\u9501\u4f1a\u5e2e\u4f60",(0,t.jsx)(e.code,{children:"\u5224\u65ad\u8981\u4e0d\u8981\u7b49\u5f85"}),"\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u91cc",(0,t.jsx)(e.code,{children:"push_back()"}),"\u9700\u8981\u4fee\u6539\u6570\u636e\uff0c\u56e0\u9700\u6c42\u6b64\u4e3a\u62c9\uff0c\u4f7f\u7528",(0,t.jsx)(e.code,{children:"lock()"}),"\u548c",(0,t.jsx)(e.code,{children:"unlock()"}),"\u7684\u7ec4\u5408\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u800c",(0,t.jsx)(e.code,{children:"size()"}),"\u5219\u53ea\u8981\u8bfb\u53d6\u6570\u636e\uff0c\u4e0d\u4fee\u6539\u6570\u636e\uff0c\u56e0\u6b64\u53ef\u4ee5\u548c\u522b\u4eba\u5171\u4eab\u4e00\u8d77\u559d\uff0c\u4f7f\u7528",(0,t.jsx)(e.code,{children:"lock_shared()"}),"\u548c",(0,t.jsx)(e.code,{children:"unlock_shared()"}),"\u7684\u7ec4\u5408\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <iostream>\n#include <thread>\n#include <vector>\n#include <shared_mutex> // \u9700\u8981\u8fd9\u4e2a\u5934\u6587\u4ef6\n\nclass MTVector {\n    std::vector<int> m_arr;\n    mutable std::shared_mutex m_mtx;\n\npublic:\n    void push_back(int val) {\n        m_mtx.lock();\n        m_arr.push_back(val);\n        m_mtx.unlock();\n    }\n\n    size_t size() const {\n        m_mtx.lock_shared();\n        size_t ret = m_arr.size();\n        m_mtx.unlock_shared();\n        return ret;\n    }\n};\n\nint main() {\n    MTVector arr;\n\n    std::thread t1([&] () {\n        for (int i = 0; i < 1000; i++) {\n            arr.push_back(i);\n        }\n    });\n\n    std::thread t2([&] () {\n        for (int i = 0; i < 1000; i++) {\n            arr.push_back(1000 + i);\n        }\n    });\n\n    t1.join();\n    t2.join();\n\n    std::cout << arr.size() << std::endl;\n\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"555-stdshared_lock-\u7b26\u5408-raii-\u601d\u60f3\u7684-lock_shared",children:"5.5.5 std::shared_lock: \u7b26\u5408 RAII \u601d\u60f3\u7684 lock_shared()"}),"\n",(0,t.jsxs)(e.p,{children:["\u6b63\u5982",(0,t.jsx)(e.code,{children:"std::unique_lock"}),"\u9488\u5bf9",(0,t.jsx)(e.code,{children:"lock()"}),"\uff0c\u4e5f\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::shared_lock"}),"\u9488\u5bf9",(0,t.jsx)(e.code,{children:"lock_shared()"}),"\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u51fd\u6570\u4f53\u9000\u51fa\u65f6\u81ea\u52a8\u8c03\u7528",(0,t.jsx)(e.code,{children:"unlock_shared()"}),"\uff0c\u66f4\u52a0\u5b89\u5168\u4e86\u3002"]}),"\n",(0,t.jsxs)(e.div,{className:"markdown-alert markdown-alert-tip",children:["\n",(0,t.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,t.jsx)(e.span,{className:"octicon octicon-tip",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-light-bulb mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Tip"]}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"shared_lock"}),"\u540c\u6837\u652f\u6301",(0,t.jsx)(e.code,{children:"defer_lock"}),"\u505a\u53c2\u6570\uff0c",(0,t.jsx)(e.code,{children:"owns_lock()"}),"\u5224\u65ad\u7b49\uff0c\u8bf7\u81ea\u884c\u7814\u7a76..."]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <mutex> // unique_lock\n#include <shared_mutex>\n\nclass MTVector {\n    std::vector<int> m_arr;\n    mutable std::shared_mutex m_mtx;\n\npublic:\n    void push_back(int val) {\n        std::unique_lock grd(m_mtx);\n        m_arr.push_back(val);\n    }\n\n    size_t size() const {\n        std::shared_lock grd(m_mtx);\n        return m_arr.size();\n    }\n};\n"})}),"\n",(0,t.jsx)(e.h3,{id:"556-\u53ea\u9700\u4e00\u6b21\u6027\u4e0a\u9501\u4e14\u7b26\u5408-raii-\u601d\u60f3-\u8bbf\u95ee\u8005\u6a21\u5f0f",children:"5.5.6 \u53ea\u9700\u4e00\u6b21\u6027\u4e0a\u9501\uff0c\u4e14\u7b26\u5408 RAII \u601d\u60f3: \u8bbf\u95ee\u8005\u6a21\u5f0f"}),"\n",(0,t.jsx)(e.p,{children:"OpenVDB \u6570\u636e\u7ed3\u6784\u7684\u8bbf\u95ee\uff0c\u4e5f\u662f\u91c7\u7528\u4e86 Accessor \u7684\u8bbe\u8ba1, \u5e76\u4e14\u8fd8\u6709 ConstAccessor \u548c Accessor \u4e24\u79cd\uff0c\u5206\u522b\u5bf9\u5e94\u4e8e\u8bfb\u548c\u5199."}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <iostream>\n#include <thread>\n#include <vector>\n#include <mutex>\n\nclass MTVector {\n    std::vector<int> m_arr;\n    std::mutex m_mtx;\n\npublic:\n    class Accessor {\n        MTVector &m_that;\n        std::unique_lock<std::mutex> m_guard;\n\n    public:\n        Accessor(MTVector &that)\n            : m_that(that), m_guard(that.m_mtx)\n        {}\n\n        void push_back(int val) const {\n            return m_that.m_arr.push_back(val);\n        }\n\n        size_t size() const {\n            return m_that.m_arr.size();\n        }\n    };\n\n    Accessor access() {\n        return {*this};\n    }\n};\n\nint main() {\n    MTVector arr;\n\n    std::thread t1([&] () {\n        auto axr = arr.access(); // \u503c\u5f97\u6ce8\u610f\u7684\u662f, axr \u6790\u6784\u7684\u65f6\u5019\u624d\u4f1a\u89e3\u9501(\u6790\u6784 m_guard)\n        for (int i = 0; i < 1000; i++) {\n            axr.push_back(i);\n        }\n    });\n\n    std::thread t2([&] () {\n        auto axr = arr.access();\n        for (int i = 0; i < 1000; i++) {\n            axr.push_back(1000 + i);\n        }\n    });\n\n    t1.join();\n    t2.join();\n\n    std::cout << arr.access().size() << std::endl;\n\n    return 0;\n}\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u8fd9\u91cc\u7684",(0,t.jsx)(e.code,{children:"m_mtx"}),"\u6539\u6210\u8bfb\u5199\u9501\uff0c\u8981\u5982\u4f55\u5b9e\u73b0",(0,t.jsx)(e.code,{children:"ConstAccessor access() const"}),"?"]}),"\n",(0,t.jsx)(e.h2,{id:"56-\u7b2c6\u7ae0-\u6761\u4ef6\u53d8\u91cf",children:"5.6 \u7b2c6\u7ae0: \u6761\u4ef6\u53d8\u91cf"}),"\n",(0,t.jsx)(e.h3,{id:"561-\u6761\u4ef6\u53d8\u91cf-\u7b49\u5f85\u88ab\u5524\u9192",children:"5.6.1 \u6761\u4ef6\u53d8\u91cf: \u7b49\u5f85\u88ab\u5524\u9192"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"cv.wait(lck)"}),"\u5c06\u4f1a\u8ba9\u5f53\u524d\u7ebf\u7a0b\u9677\u5165\u7b49\u5f85\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5728\u5176\u4ed6\u7ebf\u7a0b\u4e2d\u8c03\u7528",(0,t.jsx)(e.code,{children:"cv.notify_one()"}),"\u5219\u4f1a\u5524\u9192\u90a3\u4e2a\u9677\u5165\u7b49\u5f85\u7684\u7ebf\u7a0b\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u53ef\u4ee5\u53d1\u73b0",(0,t.jsx)(e.code,{children:"std::condition_variable"}),"\u5fc5\u987b\u548c",(0,t.jsx)(e.code,{children:"std::unique_lock<std::mutex>"}),"\u4e00\u8d77\u7528\uff0c\u7a0d\u540e\u4f1a\u89e3\u91ca\u539f\u56e0\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <mutex>\n#include <condition_variable>\n\nint main() {\n    std::condition_variable cv;\n    std::mutex mtx;\n\n    std::thread t1([&] {\n        std::unique_lock lck(mtx);\n        cv.wait(lck);\n\n        std::cout << "t1 is awake" << std::endl;\n    });\n\n    std::this_thread::sleep_for(std::chrono::milliseconds(400));\n\n    std::cout << "notifying..." << std::endl;\n    cv.notify_one();  // will awake t1\n\n    t1.join();\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"562-\u6761\u4ef6\u53d8\u91cf-\u7b49\u5f85\u67d0\u4e00\u6761\u4ef6\u6210\u771f",children:"5.6.2 \u6761\u4ef6\u53d8\u91cf: \u7b49\u5f85\u67d0\u4e00\u6761\u4ef6\u6210\u771f"}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd8\u53ef\u4ee5\u989d\u5916\u6307\u5b9a\u4e00\u4e2a\u53c2\u6570\uff0c\u53d8\u6210",(0,t.jsx)(e.code,{children:"cv.wait(lck, expr)"}),"\u7684\u5f62\u5f0f\uff0c\u5176\u4e2d",(0,t.jsx)(e.code,{children:"expr"}),"\u662f\u4e2a",(0,t.jsx)(e.code,{children:"lambda"}),"\u8868\u8fbe\u5f0f\uff0c\u53ea\u6709\u5176\u8fd4\u56de\u503c\u4e3a",(0,t.jsx)(e.code,{children:"true"}),"\u65f6\u624d\u4f1a\u771f\u6b63\u5524\u9192\uff0c\u5426\u5219\u7ee7\u7eed\u7b49\u5f85\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::condition_variable cv;\n    std::mutex mtx;\n    bool ready = false;\n\n    std::thread t1([&] {\n        std::unique_lock lck(mtx);\n        cv.wait(lck, [&] { return ready; });\n\n        std::cout << "t1 is awake" << std::endl;\n    });\n\n    std::cout << "notifying not ready" << std::endl;\n    cv.notify_one();  // useless now, since ready = false\n\n    ready = true;\n    std::cout << "notifying ready" << std::endl;\n    cv.notify_one();  // awakening t1, since ready = true\n\n    t1.join();\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"563-\u6761\u4ef6\u53d8\u91cf-\u591a\u4e2a\u7b49\u5f85\u8005",children:"5.6.3 \u6761\u4ef6\u53d8\u91cf: \u591a\u4e2a\u7b49\u5f85\u8005"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"cv.notify_one()"}),"\u53ea\u4f1a\u5524\u9192\u5176\u4e2d\u4e00\u4e2a\u7b49\u5f85\u4e2d\u7684\u7ebf\u7a0b\uff0c\u800c",(0,t.jsx)(e.code,{children:"cv.notify_all()"}),"\u4f1a\u5524\u9192\u5168\u90e8\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48",(0,t.jsx)(e.code,{children:"wait()"}),"\u9700\u8981\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"unique_lock"}),"\u4f5c\u4e3a\u53c2\u6570\uff0c\u56e0\u4e3a\u8981\u4fdd\u8bc1\u591a\u4e2a\u7ebf\u7a0b\u88ab\u5524\u9192\u65f6\uff0c\u53ea\u6709\u4e00\u4e2a\u80fd\u591f\u88ab\u542f\u52a8\u3002\u5982\u679c\u4e0d\u9700\u8981\uff0c\u5728",(0,t.jsx)(e.code,{children:"wait()"}),"\u8fd4\u56de\u540e\u8c03\u7528",(0,t.jsx)(e.code,{children:"lck.unlock()"}),"\u5373\u53ef\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u987a\u4fbf\u4e00\u63d0\uff0c",(0,t.jsx)(e.code,{children:"wait()"}),"\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u6682\u65f6",(0,t.jsx)(e.code,{children:"unlock()"}),"\u8fd9\u4e2a\u9501\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <vector>\n#include <mutex>\n#include <condition_variable>\n\nint main() {\n    std::condition_variable cv;\n    std::mutex mtx;\n\n    std::thread t1([&] {\n        std::unique_lock lck(mtx);\n        cv.wait(lck);\n        std::cout << "t1 is awake" << std::endl;\n    });\n\n    std::thread t2([&] {\n        std::unique_lock lck(mtx);\n        cv.wait(lck);\n        std::cout << "t2 is awake" << std::endl;\n    });\n\n    std::thread t3([&] {\n        std::unique_lock lck(mtx);\n        cv.wait(lck);\n        std::cout << "t3 is awake" << std::endl;\n    });\n\n    std::this_thread::sleep_for(std::chrono::milliseconds(400));\n\n    std::cout << "notifying one" << std::endl;\n    cv.notify_one();  // awakening t1 only\n\n    std::this_thread::sleep_for(std::chrono::milliseconds(400));\n\n    std::cout << "notifying all" << std::endl;\n    cv.notify_all();  // awakening t1 and t2\n\n    t1.join();\n    t2.join();\n    t3.join();\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"564-\u6848\u4f8b-\u5b9e\u73b0\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u5f0f",children:"5.6.4 \u6848\u4f8b: \u5b9e\u73b0\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u5f0f"}),"\n",(0,t.jsx)(e.p,{children:"\u7c7b\u4f3c\u4e8e\u6d88\u606f\u961f\u5217..."}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u751f\u4ea7\u8005: \u53a8\u5e08\uff0c\u5f80 foods \u961f\u5217\u91cc\u63a8\u9001\u98df\u54c1\uff0c\u63a8\u9001\u540e\u4f1a\u901a\u77e5\u6d88\u8d39\u8005\u6765\u7528\u9910\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u6d88\u8d39\u8005: \u7b49\u5f85 foods \u961f\u5217\u91cc\u6709\u98df\u54c1\uff0c\u6ca1\u6709\u98df\u54c1\u5219\u9677\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u88ab\u901a\u77e5\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <vector>\n#include <mutex>\n#include <condition_variable>\n\nint main() {\n    std::condition_variable cv;\n    std::mutex mtx;\n\n    std::vector<int> foods;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 2; i++) {\n            std::unique_lock lck(mtx);\n            cv.wait(lck, [&] {\n                return foods.size() != 0;\n            });\n            auto food = foods.back();\n            foods.pop_back();\n            lck.unlock();\n\n            std::cout << "t1 got food:" << food << std::endl;\n        }\n    });\n\n    std::thread t2([&] {\n        for (int i = 0; i < 2; i++) {\n            std::unique_lock lck(mtx);\n            cv.wait(lck, [&] {\n                return foods.size() != 0;\n            });\n            auto food = foods.back();\n            foods.pop_back();\n            lck.unlock();\n\n            std::cout << "t2 got food:" << food << std::endl;\n        }\n    });\n\n    foods.push_back(42);\n    foods.push_back(233);\n    cv.notify_one();\n\n    foods.push_back(666);\n    foods.push_back(4399);\n    cv.notify_all();\n\n    t1.join();\n    t2.join();\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"565-\u6761\u4ef6\u53d8\u91cf-\u5c06-foods-\u961f\u5217\u5c01\u88c5\u6210\u7c7b",children:"5.6.5 \u6761\u4ef6\u53d8\u91cf: \u5c06 foods \u961f\u5217\u5c01\u88c5\u6210\u7c7b"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'#include <iostream>\n#include <thread>\n#include <vector>\n#include <mutex>\n#include <condition_variable>\n\ntemplate <class T>\nclass MTQueue {\n    std::condition_variable m_cv;\n    std::mutex m_mtx;\n    std::vector<T> m_arr;\n\npublic:\n    T pop() {\n        std::unique_lock lck(m_mtx);\n        m_cv.wait(lck, [this] { return !m_arr.empty(); });\n        T ret = std::move(m_arr.back());\n        m_arr.pop_back();\n        return ret;\n    }\n\n    auto pop_hold() {\n        std::unique_lock lck(m_mtx);\n        m_cv.wait(lck, [this] { return !m_arr.empty(); });\n        T ret = std::move(m_arr.back());\n        m_arr.pop_back();\n        return std::pair(std::move(ret), std::move(lck));\n    }\n\n    void push(T val) {\n        std::unique_lock lck(m_mtx);\n        m_arr.push_back(std::move(val));\n        m_cv.notify_one();\n    }\n\n    void push_many(std::initializer_list<T> vals) {\n        std::unique_lock lck(m_mtx);\n        std::copy(\n                 std::move_iterator(vals.begin()),\n                 std::move_iterator(vals.end()),\n                 std::back_insert_iterator(m_arr));\n        m_cv.notify_all();\n    }\n};\n\nint main() {\n    MTQueue<int> foods;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 2; i++) {\n            auto food = foods.pop();\n            std::cout << "t1 got food:" << food << std::endl;\n        }\n    });\n\n    std::thread t2([&] {\n        for (int i = 0; i < 2; i++) {\n            auto food = foods.pop();\n            std::cout << "t2 got food:" << food << std::endl;\n        }\n    });\n\n    foods.push(42);\n    foods.push(233);\n    foods.push_many({666, 4399});\n\n    t1.join();\n    t2.join();\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"566-stdcondition_variable-\u5c0f\u8d34\u58eb",children:"5.6.6 std::condition_variable \u5c0f\u8d34\u58eb"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"std::condition_variable"}),"\u4ec5\u4ec5\u652f\u6301",(0,t.jsx)(e.code,{children:"std::unique_lock<std::mutex>"}),"\u4f5c\u4e3a",(0,t.jsx)(e.code,{children:"wait"}),"\u7684\u53c2\u6570\uff0c\u5982\u679c\u9700\u8981\u7528\u5176\u4ed6\u7c7b\u578b\u7684",(0,t.jsx)(e.code,{children:"mutex"}),"\u9501\uff0c\u53ef\u4ee5\u7528",(0,t.jsx)(e.code,{children:"std::condition_variable_any"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:["\u4ed6\u8fd8\u6709",(0,t.jsx)(e.code,{children:"wait_for()"}),"\u548c",(0,t.jsx)(e.code,{children:"wait_until()"}),"\u51fd\u6570\uff0c\u5206\u522b\u63a5\u53d7",(0,t.jsx)(e.code,{children:"chrono"}),"\u65f6\u95f4\u6bb5\u548c\u65f6\u95f4\u70b9\u4f5c\u4e3a\u53c2\u6570\u3002\u8be6\u89c1: ",(0,t.jsx)(e.a,{href:"https://zh.cppreference.com/w/cpp/thread/condition_variable/wait_for",children:"std::condition_variable::wait_for | cppreference.com"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"57-\u7b2c7\u7ae0-\u539f\u5b50\u64cd\u4f5c",children:"5.7 \u7b2c7\u7ae0: \u539f\u5b50\u64cd\u4f5c"}),"\n",(0,t.jsx)(e.h3,{id:"571-\u7ecf\u5178\u6848\u4f8b-\u591a\u4e2a\u7ebf\u7a0b\u4fee\u6539\u540c\u4e00\u4e2a\u8ba1\u6570\u5668",children:"5.7.1 \u7ecf\u5178\u6848\u4f8b: \u591a\u4e2a\u7ebf\u7a0b\u4fee\u6539\u540c\u4e00\u4e2a\u8ba1\u6570\u5668"}),"\n",(0,t.jsxs)(e.p,{children:["\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5f80\u4e00\u4e2a int \u53d8\u91cf\u91cc\u7d2f\u52a0\uff0c\u8fd9\u6837\u80af\u5b9a\u4f1a\u51fa\u9519\uff0c\u56e0\u4e3a",(0,t.jsx)(e.code,{children:"counter += i"}),"\u5728 CPU \u770b\u6765\u4f1a\u53d8\u6210\u4e09\u4e2a\u6307\u4ee4:"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u8bfb\u53d6 counter \u53d8\u91cf\u5230 rax \u5bc4\u5b58\u5668"}),"\n",(0,t.jsx)(e.li,{children:"rax \u5bc4\u5b58\u5668\u7684\u503c\u52a0\u4e0a 1"}),"\n",(0,t.jsx)(e.li,{children:"\u628a rax \u5199\u5165\u5230 counter \u53d8\u91cf"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5373\u4f7f\u7f16\u8bd1\u5668\u4f18\u5316\u6210",(0,t.jsx)(e.code,{children:"add [counter], 1"}),"\u4e5f\u6ca1\u7528\uff0c\u56e0\u4e3a\u73b0\u4ee3 CPU \u4e3a\u4e86\u9ad8\u6548\uff0c\u4f7f\u7528\u4e86\u5927\u91cf\u5947\u6280\u6deb\u5de7\uff0c\u6bd4\u5982\u4ed6\u4f1a\u628a\u4e00\u6761\u6c47\u7f16\u6307\u4ee4\u62c6\u5206\u6210\u5f88\u591a",(0,t.jsx)(e.strong,{children:"\u5fae\u6307\u4ee4 (micro-ops)"}),"\uff0c\u4e09\u4e2a\u751a\u81f3\u6709\u70b9\u4fdd\u5b88\u4f30\u8ba1\u4e86\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int main() {\n    int counter = 0;\n\n    std::thread t1([&] {\n        for (int i = 0; i < 10000; i++) {\n            counter += 1;\n        }\n    });\n\n    std::thread t2([&] {\n        for (int i = 0; i < 10000; i++) {\n            counter += 1;\n        }\n    });\n\n    t1.join();\n    t2.join();\n\n    std::cout << counter << std::endl;\n\n    return 0;\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u95ee\u9898\u662f\uff0c\u5982\u679c\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fd0\u884c\uff0c\u987a\u5e8f\u662f\u4e0d\u786e\u5b9a\u7684:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"t1: \u8bfb\u53d6 counter \u53d8\u91cf\uff0c\u5230 rax \u5bc4\u5b58\u5668"}),"\n",(0,t.jsx)(e.li,{children:"t2: \u8bfb\u53d6 counter \u53d8\u91cf\uff0c\u5230 rax \u5bc4\u5b58\u5668"}),"\n",(0,t.jsx)(e.li,{children:"t1: rax \u5bc4\u5b58\u5668\u7684\u503c\u52a0\u4e0a 1"}),"\n",(0,t.jsx)(e.li,{children:"t2: rax \u5bc4\u5b58\u5668\u7684\u503c\u52a0\u4e0a 1"}),"\n",(0,t.jsx)(e.li,{children:"t1: \u628a rax \u5199\u5165\u5230 counter \u53d8\u91cf"}),"\n",(0,t.jsx)(e.li,{children:"t2: \u628a rax \u5199\u5165\u5230 counter \u53d8\u91cf"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u5982\u679c\u662f\u8fd9\u79cd\u987a\u5e8f\uff0c\u6700\u540e t1 \u7684\u5199\u5165\u5c31\u88ab t2 \u8986\u76d6\u4e86\uff0c\u4ece\u800c counter \u53ea\u589e\u52a0\u4e86 1\uff0c\u800c\u6ca1\u6709\u50cf\u9884\u671f\u7684\u90a3\u6837\u589e\u52a0 2\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u66f4\u4e0d\u7528\u8bf4\u73b0\u4ee3 CPU \u8fd8\u6709\u9ad8\u901f\u7f13\u5b58\uff0c\u4e71\u5e8f\u6267\u884c\uff0c\u6307\u4ee4\u7ea7\u5e76\u884c\u7b49\u4f18\u5316\u7b56\u7565\uff0c\u4f60\u6839\u672c\u4e0d\u77e5\u9053\u6bcf\u6761\u6307\u4ee4\u5b9e\u9645\u7684\u5148\u540e\u987a\u5e8f\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"572-\u66b4\u529b\u89e3\u51b3-\u7528-mutex-\u4e0a\u9501",children:"5.7.2 \u66b4\u529b\u89e3\u51b3: \u7528 mutex \u4e0a\u9501"}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u6837\u7684\u786e\u53ef\u4ee5\u9632\u6b62\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u4fee\u6539",(0,t.jsx)(e.code,{children:"counter"}),"\u53d8\u91cf\uff0c\u4ece\u800c\u4e0d\u4f1a\u51b2\u7a81\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u95ee\u9898: mutex \u592a\u8fc7\u91cd\u91cf\u7ea7\uff0c\u4ed6\u4f1a\u8ba9\u7ebf\u7a0b\u88ab\u6302\u8d77\uff0c\u4ece\u800c\u9700\u8981\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\uff0c\u8fdb\u5165\u5185\u6838\u5c42\uff0c\u8c03\u5ea6\u5230\u5176\u4ed6\u7ebf\u7a0b\u6267\u884c\uff0c\u6709\u5f88\u5927\u7684\u5f00\u9500\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u53ef\u6211\u4eec\u53ea\u662f\u60f3\u8981\u4fee\u6539\u4e00\u4e2a\u5c0f\u5c0f\u7684 int \u53d8\u91cf\u800c\u5df2\uff0c\u7528\u6602\u8d35\u7684 mutex \u4e25\u91cd\u5f71\u54cd\u4e86\u6548\u7387\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::mutex mtx;\nint counter = 0;\n\nstd::thread t1([&] {\n    for (int i = 0; i < 10000; i++) {\n        mtx.lock();\n        counter += 1;\n        mtx.unlock();\n    }\n});\n\nstd::thread t2([&] {\n    for (int i = 0; i < 10000; i++) {\n        mtx.lock();\n        counter += 1;\n        mtx.unlock();\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"573-\u5efa\u8bae\u7528-atomic-\u6709\u4e13\u95e8\u7684\u786c\u4ef6\u6307\u4ee4\u52a0\u6301",children:"5.7.3 \u5efa\u8bae\u7528 atomic: \u6709\u4e13\u95e8\u7684\u786c\u4ef6\u6307\u4ee4\u52a0\u6301"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-\u6c47\u7f16",children:"lock xadd %eax, (%rdx)\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u56e0\u6b64\u53ef\u4ee5\u7528\u66f4\u8f7b\u91cf\u7ea7\u7684",(0,t.jsx)(e.code,{children:"atomic"}),"\uff0c\u5bf9\u4ed6\u7684",(0,t.jsx)(e.code,{children:"+="}),"\u7b49\u64cd\u4f5c\uff0c\u4f1a\u88ab\u7f16\u8bd1\u5668\u8f6c\u6362\u6210\u4e13\u95e8\u7684\u6307\u4ee4\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"CPU \u8bc6\u522b\u5230\u8be5\u6307\u4ee4\u65f6\uff0c\u4f1a\u9501\u4f4f\u5185\u5b58\u603b\u7ebf\uff0c\u653e\u5f03\u4e71\u5e8f\u6267\u884c\u7b49\u4f18\u5316\u7b56\u7565\uff08\u5c06\u8be5\u6307\u4ee4\u89c6\u4e3a\u4e00\u4e2a\u540c\u6b65\u70b9\uff0c\u5f3a\u5236\u540c\u6b65\u6389\u4e4b\u524d\u6240\u6709\u7684\u5185\u5b58\u64cd\u4f5c\uff09\uff0c\u4ece\u800c\u5411\u4f60\u4fdd\u8bc1\u8be5\u64cd\u4f5c\u662f\u539f\u5b50 (atomic) \u7684\uff08\u53d6\u5176\u4e0d\u53ef\u5206\u5272\u4e4b\u610f\uff09\uff0c\u4e0d\u4f1a\u52a0\u6cd5\u52a0\u5230\u4e00\u534a\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u63d2\u4e00\u811a\u8fdb\u6765\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u5bf9\u4e8e\u7a0b\u5e8f\u5458\uff0c\u53ea\u9700\u628a int \u6539\u6210",(0,t.jsx)(e.code,{children:"atomic<int>"}),"\u5373\u53ef\uff0c\u4e5f\u4e0d\u5fc5\u50cf mutex \u90a3\u6837\u9700\u8981\u624b\u52a8\u4e0a\u9501\u89e3\u9501\uff0c\u56e0\u6b64\u7528\u8d77\u6765\u4e5f\u66f4\u76f4\u89c2\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"#include <atomic> // \u8fd9\u4e2a\u662f\u5934\u6587\u4ef6\n\nstd::atomic<int> counter = 0;\n\nstd::thread t1([&] {\n    for (int i = 0; i < 10000; i++) {\n        counter += 1;\n    }\n});\n\nstd::thread t2([&] {\n    for (int i = 0; i < 10000; i++) {\n        counter += 1;\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"574-\u6ce8\u610f-\u8bf7\u7528-\u4e0d\u8981\u8ba9--\u548c--\u5206\u5f00",children:"5.7.4 \u6ce8\u610f: \u8bf7\u7528 +=\uff0c\u4e0d\u8981\u8ba9 + \u548c = \u5206\u5f00"}),"\n",(0,t.jsx)(e.p,{children:"\u4e0d\u8fc7\u8981\u6ce8\u610f\u4e86\uff0c\u8fd9\u79cd\u5199\u6cd5:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"counter = counter + 1; // \u9519\uff0c\u4e0d\u80fd\u4fdd\u8bc1\u539f\u5b50\u6027\ncounter += 1;          // OK\uff0c\u80fd\u4fdd\u8bc1\u539f\u5b50\u6027\ncounter++;             // OK\uff0c\u80fd\u4fdd\u8bc1\u539f\u5b50\u6027\n"})}),"\n",(0,t.jsx)(e.h3,{id:"575-fetch_add-\u548c--\u7b49\u4ef7",children:"5.7.5 fetch_add: \u548c += \u7b49\u4ef7"}),"\n",(0,t.jsx)(e.p,{children:"\u9664\u4e86\u7528\u65b9\u4fbf\u7684\u8fd0\u7b97\u7b26\u91cd\u8f7d\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u76f8\u5e94\u7684\u51fd\u6570\u540d\uff0c\u6bd4\u5982:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"fetch_add \u5bf9\u5e94\u4e8e +="}),"\n",(0,t.jsx)(e.li,{children:"store \u5bf9\u5e94\u4e8e ="}),"\n",(0,t.jsx)(e.li,{children:"load \u7528\u4e8e\u8bfb\u53d6\u5176\u4e2d\u7684 int \u503c"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::atomic<int> counter;\ncounter.store(0);\n\nstd::thread t1([&] {\n    for (int i = 0; i < 10000; i++) {\n        counter.fetch_add(1);\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"576-fetch_add-\u4f1a\u8fd4\u56de\u5176\u65e7\u503c",children:"5.7.6 fetch_add: \u4f1a\u8fd4\u56de\u5176\u65e7\u503c"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"int old = atm.fetch_add(val)\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u9664\u4e86\u4f1a\u5bfc\u81f4 atm \u7684\u503c\u589e\u52a0 val \u5916\uff0c\u8fd8\u4f1a\u8fd4\u56de atm \u589e\u52a0\u524d\u7684\u503c\uff0c\u5b58\u50a8\u5230 old\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u4e2a\u7279\u70b9\u4f7f\u5f97\u4ed6\u53ef\u4ee5\u7528\u4e8e\u5e76\u884c\u5730\u5f80\u4e00\u4e2a\u5217\u8868\u91cc\u8ffd\u52a0\u6570\u636e: \u8ffd\u52a0\u5199\u5165\u7684\u7d22\u5f15\u5c31\u662f",(0,t.jsx)(e.code,{children:"fetch_add"}),"\u8fd4\u56de\u7684\u65e7\u503c\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5f53\u7136\u8fd9\u91cc\u4e5f\u53ef\u4ee5",(0,t.jsx)(e.code,{children:"counter++"}),"\uff0c\u4e0d\u8fc7\u8981\u8ffd\u52a0\u591a\u4e2a\u7684\u8bdd\u8fd8\u662f\u5f97\u7528\u5230",(0,t.jsx)(e.code,{children:"counter.fetch_add(n)"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"std::atomic<int> counter;\ncounter.store(0);\n\nstd::vector<int> data(20000);\n\nstd::thread t1([&] {\n    for (int i = 0; i < 10000; i++) {\n        int index = counter.fetch_add(1);\n        data[index] = i;\n    }\n});\n"})}),"\n",(0,t.jsx)(e.h3,{id:"577-exchange-\u8bfb\u53d6\u7684\u540c\u65f6\u5199\u5165",children:"5.7.7 exchange: \u8bfb\u53d6\u7684\u540c\u65f6\u5199\u5165"}),"\n",(0,t.jsxs)(e.p,{children:["exchange(val) \u4f1a\u628a val \u5199\u5165\u539f\u5b50\u53d8\u91cf\uff0c\u540c\u65f6",(0,t.jsx)(e.strong,{children:"\u8fd4\u56de\u5176\u65e7\u7684\u503c"}),"\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    std::atomic<int> counter;\n\n    counter.store(0);\n\n    int old = counter.exchange(3);\n    std::cout << "old=" << old << std::endl;  // 0\n\n    int now = counter.load();\n    std::cout << "cnt=" << now << std::endl;  // 3\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"578-compare_exchange_strong-\u8bfb\u53d6\u6bd4\u8f83\u662f\u5426\u76f8\u7b49\u76f8\u7b49\u5219\u5199\u5165",children:"5.7.8 compare_exchange_strong: \u8bfb\u53d6\uff0c\u6bd4\u8f83\u662f\u5426\u76f8\u7b49\uff0c\u76f8\u7b49\u5219\u5199\u5165"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"compare_exchange_strong(old, val)"}),"\u4f1a",(0,t.jsxs)(e.strong,{children:["\u8bfb\u53d6\u539f\u5b50\u53d8\u91cf\u7684\u503c\uff0c\u6bd4\u8f83\u4ed6\u662f\u5426\u548c",(0,t.jsx)(e.code,{children:"old"}),"\u76f8\u7b49"]}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u4e0d\u76f8\u7b49\uff0c\u5219\u628a",(0,t.jsx)(e.strong,{children:"\u539f\u5b50\u53d8\u91cf"}),"\u7684\u503c\u5199\u5165",(0,t.jsx)(e.code,{children:"old"}),"\u3002"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u76f8\u7b49\uff0c\u5219\u628a",(0,t.jsx)(e.code,{children:"val"}),"\u5199\u5165",(0,t.jsx)(e.strong,{children:"\u539f\u5b50\u53d8\u91cf"}),"\u3002"]}),"\n",(0,t.jsxs)(e.li,{children:["\u8fd4\u56de\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"bool"}),"\u503c\uff0c\u8868\u793a",(0,t.jsx)(e.strong,{children:"\u662f\u5426\u76f8\u7b49"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u6ce8\u610f",(0,t.jsx)(e.code,{children:"old"}),"\u8fd9\u91cc\u4f20\u7684\u5176\u5b9e\u662f\u4e00\u4e2a",(0,t.jsx)(e.strong,{children:"\u5f15\u7528"}),"\uff0c\u56e0\u6b64",(0,t.jsx)(e.code,{children:"compare_exchange_strong"}),"\u53ef\u4fee\u6539\u4ed6\u7684\u503c\u3002",(0,t.jsx)(e.del,{children:"(\u8fd8\u633a\u7ed5\u7684...)"})]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'int main() {\n    boolalpha(std::cout);\n    std::atomic<int> counter;\n\n    counter.store(2);\n\n    int old = 1;\n    bool equal = counter.compare_exchange_strong(old, 3);\n    std::cout << "equal=" << equal << std::endl;  // false\n    std::cout << "old=" << old << std::endl;  // 2\n\n    int now = counter.load();\n    std::cout << "cnt=" << now << std::endl;  // 2\n\n    old = 2;\n    equal = counter.compare_exchange_strong(old, 3);\n    std::cout << "equal=" << equal << std::endl;  // true\n    std::cout << "old=" << old << std::endl;  // 2\n\n    now = counter.load();\n    std::cout << "cnt=" << now << std::endl;  // 3\n\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"579-\u65b9\u4fbf\u7406\u89e3\u7684\u4f2a\u4ee3\u7801",children:"5.7.9 \u65b9\u4fbf\u7406\u89e3\u7684\u4f2a\u4ee3\u7801"}),"\n",(0,t.jsx)(e.p,{children:"\u4e3a\u4e86\u65b9\u4fbf\u7406\u89e3\uff0c\u53ef\u4ee5\u5047\u60f3 atomic \u91cc\u9762\u662f\u8fd9\u6837\u5b9e\u73b0\u7684:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:"template <class T>\nstruct atomic {\n    std::mutex mtx;\n    int cnt;\n\n    int store(int val) {\n        std::lock_guard _(mtx);\n        cnt = val;\n    }\n\n    int load() const {\n        std::lock_guard _(mtx);\n        return cnt;\n    }\n\n    int fetch_add(int val) {\n        std::lock_guard _(mtx);\n        int old = cnt;\n        cnt += val;\n        return old;\n    }\n\n    int exchange(int val) {\n        std::lock_guard _(mtx);\n        int old = cnt;\n        cnt = val;\n        return old;\n    }\n\n    bool compare_exchange_strong(int &old, int val) {\n        std::lock_guard _(mtx);\n        if (cnt == old) {\n            cnt = val;\n            return true;\n        } else {\n            old = cnt;\n            return false;\n        }\n    }\n};\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u5230\u5176\u4e2d",(0,t.jsx)(e.code,{children:"compare_exchange_strong"}),"\u7684\u903b\u8f91\u6700\u4e3a\u590d\u6742\uff0c\u4e00\u822c\u7b80\u79f0 CAS (compare-and-swap)\uff0c\u4ed6\u662f\u5e76\u884c\u7f16\u7a0b\u6700\u5e38\u7528\u7684\u539f\u5b50\u64cd\u4f5c\u4e4b\u4e00\u3002\u5b9e\u9645\u4e0a\u4efb\u4f55 atomic \u64cd\u4f5c\uff0c\u5305\u62ec",(0,t.jsx)(e.code,{children:"fetch_add"}),"\uff0c\u90fd\u53ef\u4ee5\u57fa\u4e8e CAS \u6765\u5b9e\u73b0: \u8fd9\u5c31\u662f Taichi \u5b9e\u73b0\u6d6e\u70b9\u6570",(0,t.jsx)(e.code,{children:"atomic_add"}),"\u7684\u65b9\u6cd5\u3002"]}),"\n",(0,t.jsx)(e.h2,{id:"58-\u56de\u5bb6\u4f5c\u4e1a",children:"5.8 \u56de\u5bb6\u4f5c\u4e1a"}),"\n",(0,t.jsx)(e.h3,{id:"\u4f5c\u4e1a\u8981\u6c42",children:"\u4f5c\u4e1a\u8981\u6c42"}),"\n",(0,t.jsx)(e.p,{children:"\u4fee\u6539 main.cpp\uff0c\u4fee\u590d\u5e76\u6539\u8fdb\u5176\u4e2d\u7684 HTTP \u670d\u52a1\u5668\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u628a ",(0,t.jsx)(e.code,{children:"login"}),", ",(0,t.jsx)(e.code,{children:"register"})," \u7b49\u51fd\u6570\u53d8\u6210\u591a\u7ebf\u7a0b\u5b89\u5168\u7684 - 10 \u5206"]}),"\n",(0,t.jsxs)(e.li,{children:["\u628a ",(0,t.jsx)(e.code,{children:"login"})," \u7684\u767b\u5f55\u8ba1\u65f6\u5668\u6539\u6210\u57fa\u4e8e chrono \u7684 - 5 \u5206"]}),"\n",(0,t.jsxs)(e.li,{children:["\u80fd\u5229\u7528 ",(0,t.jsx)(e.code,{children:"shared_mutex"})," \u533a\u5206\u8bfb\u548c\u5199 - 10 \u5206"]}),"\n",(0,t.jsxs)(e.li,{children:["\u7528 ",(0,t.jsx)(e.code,{children:"lock_guard"})," \u7cfb\u5217\u7b26\u5408 RAII \u601d\u60f3 - 5 \u5206"]}),"\n",(0,t.jsx)(e.li,{children:"\u8ba9 ThreadPool::create \u521b\u5efa\u7684\u7ebf\u7a0b\u4fdd\u6301\u540e\u53f0\u8fd0\u884c\u4e0d\u8981\u9000\u51fa - 15 \u5206"}),"\n",(0,t.jsx)(e.li,{children:"\u7b49\u5f85 tpool \u4e2d\u6240\u6709\u7ebf\u7a0b\u90fd\u7ed3\u675f\u540e\u518d\u9000\u51fa - 5 \u5206"}),"\n"]}),"\n",(0,t.jsxs)(e.p,{children:["\u5e76\u901a\u8fc7 ",(0,t.jsx)(e.code,{children:"main()"})," \u51fd\u6570\u4e2d\u7684\u57fa\u672c\u6d4b\u8bd5\u3002"]}),"\n",(0,t.jsx)(e.h3,{id:"\u5173\u4e8e\u5185\u5377",children:"\u5173\u4e8e\u5185\u5377"}),"\n",(0,t.jsxs)(e.p,{children:["\u5982\u679c\u4f60\u628a map \u6539\u6210\u4e86\u81ea\u5df1\u5b9e\u73b0\u7684\u57fa\u4e8e hash \u7684\uff0c\u751a\u81f3\u662f\u7528\u4e86 CAS \u7684\u3002\n\u53ea\u8981\u662f\u5728 ",(0,t.jsx)(e.strong,{children:"\u6ee1\u8db3\u4f5c\u4e1a\u8981\u6c42\u4e14\u4e0d\u51fa\u9519"})," \u7684\u57fa\u7840\u4e0a\uff0c\u8fd9\u662f\u4ef6\u597d\u4e8b\uff01\n\u8001\u5e08\u4f1a\u914c\u60c5\u52a0\u5206\uff0c\u89c6\u4e3a\u201c\u72ec\u7279\u7684\u521b\u65b0\u70b9\u201d\uff0c\u4f46\u6700\u591a\u4e0d\u8d85\u8fc7 20 \u5206\u3002"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'// \u5c0f\u5f6d\u8001\u5e08\u4f5c\u4e1a05\uff1a\u5047\u88c5\u662f\u591a\u7ebf\u7a0b HTTP \u670d\u52a1\u5668 - \u5bcc\u8fde\u7f51\u5927\u5382\u9762\u8bd5\u5b98\u89c9\u5f97\u5f88\u8d5e\n#include <functional>\n#include <iostream>\n#include <sstream>\n#include <cstdlib>\n#include <string>\n#include <thread>\n#include <map>\n\n\nstruct User {\n    std::string password;\n    std::string school;\n    std::string phone;\n};\n\nstd::map<std::string, User> users;\nstd::map<std::string, long> has_login;  // \u6362\u6210 std::chrono::seconds \u4e4b\u7c7b\u7684\n\n// \u4f5c\u4e1a\u8981\u6c421\uff1a\u628a\u8fd9\u4e9b\u51fd\u6570\u53d8\u6210\u591a\u7ebf\u7a0b\u5b89\u5168\u7684\n// \u63d0\u793a\uff1a\u80fd\u6b63\u786e\u5229\u7528 shared_mutex \u52a0\u5206\uff0c\u7528 lock_guard \u7cfb\u5217\u52a0\u5206\nstd::string do_register(std::string username, std::string password, std::string school, std::string phone) {\n    User user = {password, school, phone};\n    if (users.emplace(username, user).second)\n        return "\u6ce8\u518c\u6210\u529f";\n    else\n        return "\u7528\u6237\u540d\u5df2\u88ab\u6ce8\u518c";\n}\n\nstd::string do_login(std::string username, std::string password) {\n    // \u4f5c\u4e1a\u8981\u6c422\uff1a\u628a\u8fd9\u4e2a\u767b\u5f55\u8ba1\u65f6\u5668\u6539\u6210\u57fa\u4e8e chrono \u7684\n    long now = time(NULL);   // C \u8bed\u8a00\u5f53\u524d\u65f6\u95f4\n    if (has_login.find(username) != has_login.end()) {\n        int sec = now - has_login.at(username);  // C \u8bed\u8a00\u7b97\u65f6\u95f4\u5dee\n        return std::to_string(sec) + "\u79d2\u5185\u767b\u5f55\u8fc7";\n    }\n    has_login[username] = now;\n\n    if (users.find(username) == users.end())\n        return "\u7528\u6237\u540d\u9519\u8bef";\n    if (users.at(username).password != password)\n        return "\u5bc6\u7801\u9519\u8bef";\n    return "\u767b\u5f55\u6210\u529f";\n}\n\nstd::string do_queryuser(std::string username) {\n    auto &user = users.at(username);\n    std::stringstream ss;\n    ss << "\u7528\u6237\u540d: " << username << std::endl;\n    ss << "\u5b66\u6821:" << user.school << std::endl;\n    ss << "\u7535\u8bdd: " << user.phone << std::endl;\n    return ss.str();\n}\n\n\nstruct ThreadPool {\n    void create(std::function<void()> start) {\n        // \u4f5c\u4e1a\u8981\u6c423\uff1a\u5982\u4f55\u8ba9\u8fd9\u4e2a\u7ebf\u7a0b\u4fdd\u6301\u5728\u540e\u53f0\u6267\u884c\u4e0d\u8981\u9000\u51fa\uff1f\n        // \u63d0\u793a\uff1a\u6539\u6210 async \u548c future \u4e14\u7528\u6cd5\u6b63\u786e\u4e5f\u53ef\u4ee5\u52a0\u5206\n        std::thread thr(start);\n    }\n};\n\nThreadPool tpool;\n\n\nnamespace test {  // \u6d4b\u8bd5\u7528\u4f8b\uff1f\u51fa\u6c34\u7528\u529b\uff01\nstd::string username[] = {"\u5f20\u5fc3\u6b23", "\u738b\u946b\u78ca", "\u5f6d\u4e8e\u658c", "\u80e1\u539f\u540d"};\nstd::string password[] = {"hellojob", "anti-job42", "cihou233", "reCihou_!"};\nstd::string school[] = {"\u4e5d\u767e\u516b\u5341\u4e94\u5927\u978b", "\u6d59\u6c5f\u5927\u978b", "\u5251\u6865\u5927\u978b", "\u9ebb\u7ef3\u7406\u5de5\u978b\u9662"};\nstd::string phone[] = {"110", "119", "120", "12315"};\n}\n\nint main() {\n    for (int i = 0; i < 262144; i++) {\n        tpool.create([&] {\n            std::cout << do_register(test::username[rand() % 4], test::password[rand() % 4], test::school[rand() % 4], test::phone[rand() % 4]) << std::endl;\n        });\n        tpool.create([&] {\n            std::cout << do_login(test::username[rand() % 4], test::password[rand() % 4]) << std::endl;\n        });\n        tpool.create([&] {\n            std::cout << do_queryuser(test::username[rand() % 4]) << std::endl;\n        });\n    }\n\n    // \u4f5c\u4e1a\u8981\u6c424\uff1a\u7b49\u5f85 tpool \u4e2d\u6240\u6709\u7ebf\u7a0b\u90fd\u7ed3\u675f\u540e\u518d\u9000\u51fa\n    return 0;\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u6211\u7684\u4f5c\u4e1a:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-C++",children:'// \u5c0f\u5f6d\u8001\u5e08\u4f5c\u4e1a05\uff1a\u5047\u88c5\u662f\u591a\u7ebf\u7a0b HTTP \u670d\u52a1\u5668 - \u5bcc\u8fde\u7f51\u5927\u5382\u9762\u8bd5\u5b98\u89c9\u5f97\u5f88\u8d5e\n#include <functional>\n#include <iostream>\n#include <sstream>\n#include <cstdlib>\n#include <string>\n#include <thread>\n#include <map>\n#include <shared_mutex>\n#include <mutex>\n\nstruct User {\n    std::string password;\n    std::string school;\n    std::string phone;\n};\n\n// \u7ebf\u7a0b\u5b89\u5168\u7684 Map\ntemplate<class K, class V>\nclass MTMap {\n    std::map<K, V> m_map;\n    mutable std::shared_mutex m_s_mtx;\npublic:\n    MTMap() : m_map(), m_s_mtx()\n    {}\n\n    template<typename... Args>\n    auto emplace(Args&&... args) {\n        std::unique_lock _(m_s_mtx);\n        return m_map.emplace(std::forward<Args>(args)...);\n    }\n\n    // std::size_t count(const K& key) const {\n    //     m_s_mtx.lock_shared();\n    //     size_t res = m_map.count(key);\n    //     m_s_mtx.unlock_shared();\n    //     return res;\n    // }\n\n    // const V& at(const K& key) const {\n    //     m_s_mtx.lock_shared();\n    //     const V& res = m_map.at(key);\n    //     m_s_mtx.unlock_shared();\n    //     return res;\n    // }\n    std::size_t count(const K& key) const {\n        std::shared_lock _(m_s_mtx);\n        return m_map.count(key);\n    }\n\n    decltype(auto) /*const V&*/ at(const K& key) const {\n        std::shared_lock _(m_s_mtx);\n        return m_map.at(key);\n    }\n\n    // V& operator[] (const K& key) {\n    //     m_s_mtx.lock_shared();\n    //     V& res = m_map[key];\n    //     m_s_mtx.unlock_shared();\n    //     return res;\n    // }\n    // \u63d2\u5165 [Key, Val], \u5982\u679c\u5df2\u7ecf\u5b58\u5728\u5219\u8986\u76d6\n    void insert (const K& key, const V& val) {\n        std::unique_lock _(m_s_mtx);\n        m_map[key] = val;\n    }\n};\n\nMTMap<std::string, User> users;\nMTMap<std::string, std::chrono::steady_clock::time_point> has_login;  // \u6362\u6210 std::chrono::seconds \u4e4b\u7c7b\u7684\n\n// \u4f5c\u4e1a\u8981\u6c421\uff1a\u628a\u8fd9\u4e9b\u51fd\u6570\u53d8\u6210\u591a\u7ebf\u7a0b\u5b89\u5168\u7684\n// \u63d0\u793a\uff1a\u80fd\u6b63\u786e\u5229\u7528 shared_mutex \u52a0\u5206\uff0c\u7528 lock_guard \u7cfb\u5217\u52a0\u5206\nstd::string do_register(\n        const std::string& username,\n        const std::string& password,\n        const std::string& school,\n        const std::string& phone) {\n    User user = {password, school, phone};\n    if (users.emplace(username, user).second)\n        return "\u6ce8\u518c\u6210\u529f";\n    else\n        return "\u7528\u6237\u540d\u5df2\u88ab\u6ce8\u518c";\n}\n\nstd::string do_login(const std::string& username, const std::string& password) {\n    // \u4f5c\u4e1a\u8981\u6c422\uff1a\u628a\u8fd9\u4e2a\u767b\u5f55\u8ba1\u65f6\u5668\u6539\u6210\u57fa\u4e8e chrono \u7684\n    auto now = std::chrono::steady_clock::now();  // \u5f53\u524d\u65f6\u95f4\n    if (has_login.count(username)) {\n        auto sec = now - has_login.at(username);  // \u7b97\u65f6\u95f4\u5dee\n        // has_login[username] = now;\n        has_login.insert(username, now);\n        return std::to_string(std::chrono::duration_cast<std::chrono::duration<double>>(sec).count()) + "\u79d2\u5185\u767b\u5f55\u8fc7";\n    }\n\n    // \u6709BUG\u5427? \u8fd9\u4e2a\u51fd\u6570\n    if (!users.count(username))\n        return "\u7528\u6237\u540d\u9519\u8bef";\n    if (users.at(username).password != password)\n        return "\u5bc6\u7801\u9519\u8bef";\n    return "\u767b\u5f55\u6210\u529f";\n}\n\nstd::string do_queryuser(const std::string& username) {\n    if (!users.count(username))\n        return "\u6ca1\u4eba";\n    auto &user = users.at(username);\n    std::stringstream ss;\n    ss << "\u7528\u6237\u540d: " << username << std::endl;\n    ss << "\u5b66\u6821:" << user.school << std::endl;\n    ss << "\u7535\u8bdd: " << user.phone << std::endl;\n    return ss.str();\n}\n\nstruct ThreadPool { // \u6700\u597d\u662f\u5199\u4e00\u4e2a\u7ebf\u7a0b\u6c60, \u8fd9\u91cc\u5077\u61d2~ | \u7ebf\u7a0b\u592a\u591a\u4e86, \u4e0d\u80fd\u603b\u662f\u521b\u5efa\nprivate:\n    std::vector<std::thread> m_thread_arr;\npublic:\n    ThreadPool() : m_thread_arr()\n    {\n        std::cout << "Start\\n";\n    }\n\n    void create(std::function<void()> start) {\n        // \u4f5c\u4e1a\u8981\u6c423\uff1a\u5982\u4f55\u8ba9\u8fd9\u4e2a\u7ebf\u7a0b\u4fdd\u6301\u5728\u540e\u53f0\u6267\u884c\u4e0d\u8981\u9000\u51fa\uff1f\n        // \u63d0\u793a\uff1a\u6539\u6210 async \u548c future \u4e14\u7528\u6cd5\u6b63\u786e\u4e5f\u53ef\u4ee5\u52a0\u5206\n        m_thread_arr.emplace_back(std::thread(start));\n//        std::jthread thr(start);\n    }\n\n    ~ThreadPool() {\n        std::cout << "Ending...\\n";\n        for (auto&& it : m_thread_arr)\n            it.join();\n        std::cout << "End\\n";\n    }\n};\n\nThreadPool tpool;\n\nnamespace test {  // \u6d4b\u8bd5\u7528\u4f8b\uff1f\u51fa\u6c34\u7528\u529b\uff01\n    std::string username[] = {"\u5f20\u5fc3\u6b23", "\u738b\u946b\u78ca", "\u5f6d\u4e8e\u658c", "\u80e1\u539f\u540d"};\n    std::string password[] = {"hellojob", "anti-job42", "cihou233", "reCihou_!"};\n    std::string school[] = {"\u4e5d\u767e\u516b\u5341\u4e94\u5927\u978b", "\u6d59\u6c5f\u5927\u978b", "\u5251\u6865\u5927\u978b", "\u9ebb\u7ef3\u7406\u5de5\u978b\u9662"};\n    std::string phone[] = {"110", "119", "120", "12315"};\n}\n\nint main() {\n    for (int i = 0; i < 262144; i++) {\n        tpool.create([&] {\n            std::cout << do_register(test::username[rand() % 4], test::password[rand() % 4], test::school[rand() % 4], test::phone[rand() % 4]) << std::endl;\n        });\n        tpool.create([&] {\n            std::cout << do_login(test::username[rand() % 4], test::password[rand() % 4]) << std::endl;\n        });\n        tpool.create([&] {\n            std::cout << do_queryuser(test::username[rand() % 4]) << std::endl;\n        });\n    }\n\n    // \u4f5c\u4e1a\u8981\u6c424\uff1a\u7b49\u5f85 tpool \u4e2d\u6240\u6709\u7ebf\u7a0b\u90fd\u7ed3\u675f\u540e\u518d\u9000\u51fa\n\n    return 0;\n}\n'})})]})}function h(n={}){const{wrapper:e}={...(0,c.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(a,{...n})}):a(n)}},99301:(n,e,d)=>{d.d(e,{A:()=>s});const s=d.p+"assets/images/Clip_2024-07-12_19-33-50-cad6d4fd0a8908e8be5f68761b0cae4f.png"}}]);