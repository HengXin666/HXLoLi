"use strict";(self.webpackChunkhx_loli=self.webpackChunkhx_loli||[]).push([[25395],{19489:(n,e,i)=>{i.d(e,{A:()=>s});const s=i.p+"assets/images/image_03-cc6807976c206efb84786b3e53d34cc2.png"},28453:(n,e,i)=>{i.d(e,{R:()=>t,x:()=>c});var s=i(96540);const l={},r=s.createContext(l);function t(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),s.createElement(r.Provider,{value:e},n.children)}},77985:(n,e,i)=>{i.d(e,{A:()=>s});const s=i.p+"assets/images/image_04-9c552f223eabe4cd22d528b6a36452ab.png"},84252:(n,e,i)=>{i.d(e,{A:()=>s});const s=i.p+"assets/images/image_01-81529fee1b15bbee33d0a740307103ff.png"},84887:(n,e,i)=>{i.d(e,{A:()=>s});const s=i.p+"assets/images/image_02-54786f7473ed8e2370364f18bc341643.png"},85888:n=>{n.exports=JSON.parse('{"permalink":"/HXLoLi/blog/2025/06/24/01-Linux\u5e38\u89c1Hook\u65b9\u6cd5","editUrl":"https://github.com/HengXin666/HXLoLi/edit/main/blog/2025/06/24/01-Linux\u5e38\u89c1Hook\u65b9\u6cd5.md","source":"@site/blog/2025/06/24/01-Linux\u5e38\u89c1Hook\u65b9\u6cd5.md","title":"Linux\u5e38\u89c1Hook\u65b9\u6cd5","description":"\u8fd9\u4e2a\u662f\u4e0a\u73ed\u8981\u6c42\u7684, \u4e0d\u80fd\u4f7f\u7528 AI, \u81ea\u5df1\u901a\u8fc7\u641c\u7d22, \u628a\u8fd9\u4e2a\u89e3\u51b3\u65b9\u6848\u641e\u51fa\u6765, \u5e76\u4e14\u8bf4\u660e\u4e3a\u4ec0\u4e48\u9009\u62e9\u8fd9\u4e2a\u65b9\u6848, \u4e0d\u9009\u62e9\u5176\u4ed6\u65b9\u6848.","date":"2025-06-24T22:28:44.000Z","tags":[{"inline":false,"label":"C++","permalink":"/HXLoLi/blog/tags/C++","description":"C++\u5c0f\u77e5\u8bc6"}],"readingTime":33.57,"hasTruncateMarker":true,"authors":[{"name":"Heng_Xin","title":"\u3053\u3053\u304b\u3089\u5148\u306f\u4e00\u65b9\u901a\u884c\u3060!","url":"https://github.com/HengXin666","email":"282000500@qq.com","socials":{"github":"https://github.com/HengXin666","bilibili":"https://space.bilibili.com/478917126"},"imageURL":"https://avatars.githubusercontent.com/u/103022267","key":"Heng_Xin","page":null}],"frontMatter":{"authors":"Heng_Xin","title":"Linux\u5e38\u89c1Hook\u65b9\u6cd5","date":"2025-06-24T22:28:44.000Z","tags":["C++"]},"unlisted":false,"lastUpdatedAt":1751210140000,"lastUpdatedBy":"Heng_Xin_666","prevItem":{"title":"\u3010C++\u3011\u534f\u7a0b\u4e0eLambda\u5c0f\u7ec6\u8282","permalink":"/HXLoLi/blog/2025/06/29/01-\u534f\u7a0b\u5c0f\u7ec6\u8282"},"nextItem":{"title":"\u4e0a\u73ed\u7b2c\u4e00\u8bfe","permalink":"/HXLoLi/blog/2025/06/23/01-\u4e0a\u73ed\u7b2c\u4e00\u8bfe"}}')},92908:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>s,toc:()=>o});var s=i(85888),l=i(74848),r=i(28453);const t={authors:"Heng_Xin",title:"Linux\u5e38\u89c1Hook\u65b9\u6cd5",date:new Date("2025-06-24T22:28:44.000Z"),tags:["C++"]},c=void 0,d={authorsImageUrls:[void 0]},o=[{value:"\u6587\u4ef6\u76d1\u63a7\u670d\u52a1",id:"\u6587\u4ef6\u76d1\u63a7\u670d\u52a1",level:2},{value:"\u4e00\u3001\u9700\u6c42",id:"\u4e00\u9700\u6c42",level:3},{value:"1.1 \u6587\u4ef6\u6e05\u5355",id:"11-\u6587\u4ef6\u6e05\u5355",level:4},{value:"1.2 \u6307\u5b9a\u8fdb\u7a0b",id:"12-\u6307\u5b9a\u8fdb\u7a0b",level:4},{value:"1.3 \u53ef\u62e6\u622a\u8bfb\u5199\u7cfb\u7edf\u8c03\u7528",id:"13-\u53ef\u62e6\u622a\u8bfb\u5199\u7cfb\u7edf\u8c03\u7528",level:4},{value:"1.4 \u65e5\u5fd7\u7cfb\u7edf",id:"14-\u65e5\u5fd7\u7cfb\u7edf",level:4},{value:"X\u3001\u6280\u672f\u5b9e\u73b0\u7684\u67e5\u8be2",id:"x\u6280\u672f\u5b9e\u73b0\u7684\u67e5\u8be2",level:3},{value:"x.1 \u67e5\u627e\u5173\u952e\u5b57\u53ca\u5176\u6587\u7ae0",id:"x1-\u67e5\u627e\u5173\u952e\u5b57\u53ca\u5176\u6587\u7ae0",level:4},{value:"\u4e8c\u3001\u6280\u672f\u7b14\u8bb0",id:"\u4e8c\u6280\u672f\u7b14\u8bb0",level:3},{value:"2.1 Linux\u4e2d\u5e38\u89c1\u7684\u8fc7\u6ee4\u62e6\u622a\u6280\u672f",id:"21-linux\u4e2d\u5e38\u89c1\u7684\u8fc7\u6ee4\u62e6\u622a\u6280\u672f",level:4},{value:"2.1.1 \u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a",id:"211-\u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a",level:5},{value:"2.1.2 \u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a",id:"212-\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a",level:4},{value:"2.1.3 \u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf",id:"213-\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf",level:4},{value:"2.1.4 inline hook",id:"214-inline-hook",level:4},{value:"2.1.5 LSM (\u5185\u6838\u5b89\u5168\u6a21\u5757)",id:"215-lsm-\u5185\u6838\u5b89\u5168\u6a21\u5757",level:4},{value:"2.1.6 ebpf",id:"216-ebpf",level:4},{value:"2.1.7 \u603b\u7ed3",id:"217-\u603b\u7ed3",level:4},{value:"2.2 LSM hook\u70b9\u8bf4\u660e",id:"22-lsm-hook\u70b9\u8bf4\u660e",level:3},{value:"2.2.1 LSM super_block hooks",id:"221-lsm-super_block-hooks",level:4},{value:"2.2.2 LSM hooks",id:"222-lsm-hooks",level:4},{value:"2.3 LSM \u4e0e BPF",id:"23-lsm-\u4e0e-bpf",level:3},{value:"2.3.1 \u7cfb\u7edf\u8ba4\u8bc6 LSM",id:"231-\u7cfb\u7edf\u8ba4\u8bc6-lsm",level:4},{value:"2.3.2 LSM BPF",id:"232-lsm-bpf",level:4},{value:"\u4e09\u3001\u51b3\u7b56",id:"\u4e09\u51b3\u7b56",level:3},{value:"3.1 Hook \u6280\u672f\u9009\u578b: LSM",id:"31-hook-\u6280\u672f\u9009\u578b-lsm",level:4},{value:"3.2 \u5176\u4ed6\u7ec6\u8282",id:"32-\u5176\u4ed6\u7ec6\u8282",level:4},{value:"3.2.1 \u5982\u4f55\u83b7\u53d6 \u88abhook\u7684\u64cd\u4f5c\u7684\u6267\u884c \u8fdb\u7a0bpid",id:"321-\u5982\u4f55\u83b7\u53d6-\u88abhook\u7684\u64cd\u4f5c\u7684\u6267\u884c-\u8fdb\u7a0bpid",level:5},{value:"3.2.2 \u83b7\u53d6\u8fdb\u7a0b\u7684\u7edd\u5bf9\u542f\u52a8\u8def\u5f84",id:"322-\u83b7\u53d6\u8fdb\u7a0b\u7684\u7edd\u5bf9\u542f\u52a8\u8def\u5f84",level:4}];function h(n){const e={a:"a",blockquote:"blockquote",code:"code",div:"div",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.p,{children:"\u8fd9\u4e2a\u662f\u4e0a\u73ed\u8981\u6c42\u7684, \u4e0d\u80fd\u4f7f\u7528 AI, \u81ea\u5df1\u901a\u8fc7\u641c\u7d22, \u628a\u8fd9\u4e2a\u89e3\u51b3\u65b9\u6848\u641e\u51fa\u6765, \u5e76\u4e14\u8bf4\u660e\u4e3a\u4ec0\u4e48\u9009\u62e9\u8fd9\u4e2a\u65b9\u6848, \u4e0d\u9009\u62e9\u5176\u4ed6\u65b9\u6848."}),"\n",(0,l.jsx)(e.p,{children:"\u4eca\u5929\u5df2\u7ecf\u809d\u5b8c\u4e86, \u4e0a\u5934\u633a\u6ee1\u610f\u7684, \u7136\u540e\u8ba9\u6211\u628a\u4ed6\u4eec\u5199\u51fa\u6765\u4e86 =-=, Linux\u7f16\u5199\u5185\u6838\u6a21\u5757qwq..."}),"\n",(0,l.jsx)(e.h2,{id:"\u6587\u4ef6\u76d1\u63a7\u670d\u52a1",children:"\u6587\u4ef6\u76d1\u63a7\u670d\u52a1"}),"\n",(0,l.jsx)(e.h3,{id:"\u4e00\u9700\u6c42",children:"\u4e00\u3001\u9700\u6c42"}),"\n",(0,l.jsx)(e.h4,{id:"11-\u6587\u4ef6\u6e05\u5355",children:"1.1 \u6587\u4ef6\u6e05\u5355"}),"\n",(0,l.jsxs)(e.p,{children:["\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u6587\u4ef6, \u52a0\u5165",(0,l.jsx)(e.code,{children:"\u6587\u4ef6\u6e05\u5355"}),"; \u7a0b\u5e8f\u4f1a\u8bb0\u5f55\u9009\u62e9\u7684\u6587\u4ef6\u7684 ",(0,l.jsx)(e.strong,{children:"\u7edd\u5bf9\u8def\u5f84"}),", \u4ee5\u786e\u4fdd\u65e0\u6b67\u4e49."]}),"\n",(0,l.jsx)(e.h4,{id:"12-\u6307\u5b9a\u8fdb\u7a0b",children:"1.2 \u6307\u5b9a\u8fdb\u7a0b"}),"\n",(0,l.jsxs)(e.p,{children:["\u7528\u6237\u53ef\u4ee5\u6307\u5b9a\u8fdb\u7a0b, \u52a0\u5165",(0,l.jsx)(e.code,{children:"\u767d\u540d\u5355"}),"; \u7a0b\u5e8f\u4f1a\u8bb0\u5f55\u9009\u62e9\u7684\u8fdb\u7a0b\u7684 ",(0,l.jsx)(e.strong,{children:"\u542f\u52a8\u8def\u5f84"})," \u7684 ",(0,l.jsx)(e.strong,{children:"\u7edd\u5bf9\u8def\u5f84"})," \u4f5c\u4e3a\u552f\u4e00\u8fdb\u7a0b\u6807\u8bc6."]}),"\n",(0,l.jsx)(e.h4,{id:"13-\u53ef\u62e6\u622a\u8bfb\u5199\u7cfb\u7edf\u8c03\u7528",children:"1.3 \u53ef\u62e6\u622a\u8bfb\u5199\u7cfb\u7edf\u8c03\u7528"}),"\n",(0,l.jsxs)(e.p,{children:["\u5bf9 ",(0,l.jsx)(e.code,{children:"\u6587\u4ef6\u6e05\u5355"})," \u5185\u7684\u6587\u4ef6\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u65f6, \u9700\u8981\u62e6\u622a ",(0,l.jsx)(e.strong,{children:"\u975e"})," \u767d\u540d\u5355 \u7684\u8fdb\u7a0b."]}),"\n",(0,l.jsx)(e.h4,{id:"14-\u65e5\u5fd7\u7cfb\u7edf",children:"1.4 \u65e5\u5fd7\u7cfb\u7edf"}),"\n",(0,l.jsx)(e.p,{children:"\u65e5\u5fd7\u8bb0\u5f55:"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"[\u89e6\u53d1\u65f6\u95f4] [\u89e6\u53d1\u8fdb\u7a0b(\u5168\u8def\u5f84)] [\u8be5\u8fdb\u7a0b\u64cd\u4f5c\u5bf9\u8c61(\u6587\u4ef6)] [\u8be5\u8fdb\u7a0b\u64cd\u4f5c\u5185\u5bb9] [\u672c\u7a0b\u5e8f\u5904\u7406\u7ed3\u679c]"}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"x\u6280\u672f\u5b9e\u73b0\u7684\u67e5\u8be2",children:"X\u3001\u6280\u672f\u5b9e\u73b0\u7684\u67e5\u8be2"}),"\n",(0,l.jsx)(e.h4,{id:"x1-\u67e5\u627e\u5173\u952e\u5b57\u53ca\u5176\u6587\u7ae0",children:"x.1 \u67e5\u627e\u5173\u952e\u5b57\u53ca\u5176\u6587\u7ae0"}),"\n",(0,l.jsx)(e.p,{children:"\u7cfb\u7edf\u8bfb\u5199\u8c03\u7528\u62e6\u622a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/weiqifa0/article/details/122571798",children:"\u624b\u628a\u624b\u6559\u4f60\uff5c\u62e6\u622a\u7cfb\u7edf\u8c03\u7528"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"linux\u62e6\u622a\u8bfb\u5199\u8c03\u7528"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://juejin.cn/post/7215825282040676412",children:"Linux\u7cfb\u7edf\u4e0b\u767d\u540d\u5355\u5916\u8fdb\u7a0b\u963b\u65ad\u5b9e\u73b0\u539f\u7406"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/549849135",children:"\u76d8\u70b9Linux\u4e2d\u5e38\u89c1\u7684\u8fc7\u6ee4\u62e6\u622a\u6280\u672f"})," (\u5b9e\u9645\u4e0a\u8fd9\u7bc7\u5c31\u662f\u7efc\u8ff0, \u7684\u8bf4)\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"inline hook\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"LSM(Linux Security Modules)"}),"\n",(0,l.jsx)(e.li,{children:"eBPF Hook\u62e6\u622a"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://blog.csdn.net/qq_66359721/article/details/147139241",children:"Linux\u73af\u5883\u4e0b\u7684\u62e6\u622a\u6280\u672f"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u6709\u4fdd\u62a4\u6587\u4ef6\u4e0e\u7f51\u7edc\u8fc7\u6ee4demo"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u7cfb\u7edf\u8c03\u7528\u52ab\u6301\u83b7\u53d6\u6587\u4ef6\u7edd\u5bf9\u8def\u5f84"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"http://edsionte.com/techblog/archives/4406",children:"Linux\u5185\u6838\u4e2d\u901a\u8fc7\u6587\u4ef6\u63cf\u8ff0\u7b26\u83b7\u53d6\u7edd\u5bf9\u8def\u5f84"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"Linux\u7cfb\u7edf\u8c03\u7528\u52ab\u6301"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://www.freesion.com/article/1205184276/",children:"Linux\u6f0f\u6d1e\u6316\u6398:06---\u7cfb\u7edf\u8c03\u7528\u52ab\u6301\u4e4b\uff08\u901a\u8fc7/boot/System.map\u76ee\u5f55\u83b7\u53d6sys_call_table\u7cfb\u7edf\u8c03\u7528\u8868\uff09"})}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://www.cnblogs.com/LittleHann/p/4127096.html",children:"sys_call_table"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u9700\u8981\u533a\u520632\u548c64\u4f4d\u7cfb\u7edf; \u5e76\u4e14\u7cfb\u7edf\u6bcf\u6b21\u91cd\u542f\u5176 sys_call_table \u7684\u5185\u5b58\u5730\u5740\u90fd\u4f1a\u53d8\u6211\u4eec\u9700\u8981\u83b7\u53d6\u5230\u4ed6\u4eec\u7684\u5730\u5740; \u5e76\u4e14\u8bb0\u5f97\u590d\u539f, \u5982\u679c\u4e0d\u590d\u539f\u7cfb\u7edf\u4f1a\u5d29\u6389, \u4f60\u7684\u7a0b\u5e8f\u7ed3\u675f\u540e, \u5c31\u662f\u91ce\u6307\u9488\u4e86"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u53d1\u73b0\u6bd4\u8f83\u96be\u5bf9\u4ed8, \u5148\u7565\u8fc7"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"inline hook"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.cnblogs.com/luconsole/p/14813573.html",children:"inline hook \u539f\u7406&\u6559\u7a0b"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://eunomia.dev/zh/blogs/inline-hook/",children:"\u4e94\u5206\u949f\u5e26\u4f60\u624b\u6413\u4e00\u4e2a\u7b80\u6613\u7684 inline hook \u5b9e\u73b0\u63a7\u5236\u6d41\u52ab\u6301"})," & ",(0,l.jsx)(e.a,{href:"https://github.com/eunomia-bpf/inline-hook-demo",children:"https://github.com/eunomia-bpf/inline-hook-demo"})]}),"\n"]}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u9700\u8981\u8003\u8651\u7ebf\u7a0b\u5b89\u5168; \u8de8\u5e73\u53f0(arm/x86)\u6307\u4ee4\u96c6\u7684\u5dee\u5f02"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5185\u6838\u5b89\u5168\u6a21\u5757 \u7f16\u5199"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/420194002",children:"\u5982\u4f55\u7f16\u5199\u4e00\u4e2aLinux\u5185\u6838\u6a21\u5757\uff0c\u8fd9\u6b21\u624b\u628a\u624b\u6559\u4f60"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5185\u6838\u5b89\u5168\u6a21\u5757 \u7f16\u5199\u62e6\u622a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://rivers.chaitin.cn/blog/cqj64sh0lnedo7thptp0",children:"\u52a8\u624b\u5199\u4e00\u4e2a\u57fa\u4e8eLinux\u5185\u6838\u7684\u7f51\u7edc\u6570\u636e\u5305\u62e6\u622a\u6269\u5c55"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5185\u6838\u5b89\u5168\u6a21\u5757 \u53ef\u79fb\u690d\u6027"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://hjk.life/posts/linux-kernel-portability/",children:"Linux\u5185\u6838\u5b66\u4e60\u7b14\u8bb0\u4e4b\u53ef\u79fb\u690d\u6027"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"Linux Security Modules \u53ef\u79fb\u690d\u6027"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/10981876370",children:"Linux \u5185\u6838\u7684\u53ef\u88c1\u526a\u6027\u4e0e\u53ef\u79fb\u690d\u6027\u5e95\u5c42\u539f\u7406\u8be6\u89e3"})}),"\n"]}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u611f\u89c9\u53ef\u4ee5\u63d2\u5165\u7684\u70b9\u6bd4\u8f83\u53d7\u7ea6\u675f?? \u518d\u627e\u627e\u770b; \u611f\u89c9\u548c eBPF \u7684\u533a\u522b\u5c31\u662f\u662f\u5426\u53ef\u4ee5hook\u7528\u6237\u6001? \u518d\u627e\u627e\u770b"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"LSM\u6a21\u5757 \u53ef\u4f5c\u7528\u51fd\u6570"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/weixin_45030965/article/details/133749748",children:"Linux \u5b89\u5168 - LSM hook\u70b9"})}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.a,{href:"https://just4coding.com/2023/12/01/lsm-hook/",children:"LSM\u6a21\u5757\u52a8\u6001Hook\u5b9e\u73b0"})," (CentOS7/8\u7684\u793a\u4f8b)"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"LSM\u6a21\u5757 hook\u70b9"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.neko.ooo/lsm-mod/",children:"LSM \u5b89\u5168\u6a21\u5757\u5f00\u53d1 \u2014\u2014 \u6587\u4ef6\u6253\u5f00 2FA "})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"eBPF Hook \u62e6\u622a\u8bfb\u5199"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.eet-china.com/mp/a357540.html",children:"\u6536\u85cf\uff01\u4f7f\u7528eBPF\u6280\u672f\u5ba1\u8ba1\u548c\u62e6\u622a\u6587\u4ef6\u8bfb\u5199\u64cd\u4f5c"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"LSM\u6a21\u5757 \u4e0e eBPF hook \u5bf9\u6bd4"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/681005652",children:"BPF LSM \u5b8c\u5168\u5b9e\u8df5\uff08\u5efa\u8bae\u6536\u85cf\uff09"})}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"lsm hook \u8bfb\u5199"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/farsight_2098/article/details/130875915",children:"Linux\u5185\u6838\u5b89\u5168\u6a21\u5757\uff08Linux Security Module\uff0cLSM\uff09\u4f8b\u5b50"})}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8c\u6280\u672f\u7b14\u8bb0",children:"\u4e8c\u3001\u6280\u672f\u7b14\u8bb0"}),"\n",(0,l.jsx)(e.h4,{id:"21-linux\u4e2d\u5e38\u89c1\u7684\u8fc7\u6ee4\u62e6\u622a\u6280\u672f",children:"2.1 Linux\u4e2d\u5e38\u89c1\u7684\u8fc7\u6ee4\u62e6\u622a\u6280\u672f"}),"\n",(0,l.jsx)(e.h5,{id:"211-\u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a",children:"2.1.1 \u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a"}),"\n",(0,l.jsxs)(e.p,{children:["Linux\u4e0a\u7684\u52a8\u6001\u5e93\u52ab\u6301\u4e3b\u8981\u662f\u57fa\u4e8e ",(0,l.jsx)(e.code,{children:"LD_PRELOAD"})," \u73af\u5883\u53d8\u91cf\uff0c\u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u6539\u53d8\u52a8\u6001\u5e93\u7684\u52a0\u8f7d\u987a\u5e8f\uff0c\u8ba9\u7528\u6237\u6709\u9009\u62e9\u7684\u8f7d\u5165\u4e0d\u540c\u52a8\u6001\u5e93\u4e2d\u7684\u76f8\u540c\u51fd\u6570\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"\u4f46\u662f\u4f7f\u7528\u4e0d\u5f53\u5c31\u4f1a\u5f15\u8d77\u4e25\u91cd\u7684\u5b89\u5168\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5b83\u5728\u4e3b\u7a0b\u5e8f\u548c\u52a8\u6001\u8fde\u63a5\u5e93\u4e2d\u52a0\u8f7d\u522b\u7684\u52a8\u6001\u51fd\u6570\uff0c\u8fd9\u5c31\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u673a\u4f1a\uff0c\u5411\u522b\u4eba\u7684\u7a0b\u5e8f\u6ce8\u5165\u6076\u610f\u7684\u4ee3\u7801\u3002"}),"\n",(0,l.jsxs)(e.div,{className:"markdown-alert markdown-alert-tip",children:["\n",(0,l.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,l.jsx)(e.span,{className:"octicon octicon-tip",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-light-bulb mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Tip"]}),"\n",(0,l.jsxs)(e.p,{children:["\u8fd9\u662f\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u52ab\u6301 \uff0c\u4f46\u662f\u5982\u679c\u52ab\u6301\u4e86\u7c7b\u4f3c\u4e8e ",(0,l.jsx)(e.code,{children:"geteuid/getuid/getgid"}),"\uff0c\u8ba9\u5176\u8fd4\u56de",(0,l.jsx)(e.code,{children:"0"}),"\uff0c\u5c31\u76f8\u5f53\u4e8e\u66b4\u9732\u4e86root\u6743\u9650\u3002\u6240\u4ee5\u4e3a\u4e86\u5b89\u5168\u8d77\u89c1\uff0c\u4e00\u822c\u5c06 ",(0,l.jsx)(e.code,{children:"LD_PRELOAD"})," \u73af\u5883\u53d8\u91cf\u7981\u7528\u6389\u3002"]}),"\n"]}),"\n",(0,l.jsx)(e.h4,{id:"212-\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a",children:"2.1.2 \u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a"}),"\n",(0,l.jsxs)(e.p,{children:["Linux\u5185\u6838\u4e2d\u6240\u6709\u7684\u7cfb\u7edf\u8c03\u7528\u90fd\u662f\u653e\u5728\u4e00\u4e2a\u53eb\u505a ",(0,l.jsx)(e.code,{children:"sys_call_table"})," \u7684\u5185\u6838\u6570\u7ec4\u4e2d\uff0c\u6570\u7ec4\u7684\u503c\u5c31\u8868\u793a\u8fd9\u4e2a\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u7a0b\u5e8f\u7684\u5165\u53e3\u5730\u5740\u3002"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.img,{alt:"\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a\u8fc7\u7a0b ##w500##",src:i(84252).A+"",width:"625",height:"421"})}),"\n",(0,l.jsxs)(e.p,{children:["\u5f53\u7528\u6237\u6001\u53d1\u8d77\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u4f1a\u901a\u8fc780\u8f6f\u4e2d\u65ad\u8fdb\u5165\u5230 ",(0,l.jsx)(e.code,{children:"syscall hander"}),"\uff0c\u8fdb\u800c\u8fdb\u5165\u5168\u5c40\u7684\u7cfb\u7edf\u8c03\u7528\u8868 ",(0,l.jsx)(e.code,{children:"sys_call_table"})," \u53bb\u67e5\u627e\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u90a3\u4e48\u5982\u679c\u6211\u4eec\u5c06\u8fd9\u4e2a\u6570\u7ec4\u4e2d\u7684\u5730\u5740\u6539\u6210\u6211\u4eec\u81ea\u5df1\u7684\u7a0b\u5e8f\u5730\u5740\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u52ab\u6301\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"\u4f46\u662f\u5185\u6838\u4e3a\u4e86\u5b89\u5168\uff0c\u5bf9\u8fd9\u79cd\u64cd\u4f5c\u505a\u4e86\u4e00\u4e9b\u9650\u5236:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"sys_call_table"})," \u7684\u7b26\u53f7\u6ca1\u6709\u5bfc\u51fa, \u4e0d\u80fd\u76f4\u63a5\u83b7\u53d6."]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"sys_call_table"})," \u6240\u5728\u7684\u5185\u5b58\u9875\u662f\u53ea\u8bfb\u5c5e\u6027\u7684, \u65e0\u6cd5\u76f4\u63a5\u8fdb\u884c\u4fee\u6539."]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u89e3\u51b3\u65b9\u6cd5 (\u4e0d\u552f\u4e00):"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u83b7\u53d6 ",(0,l.jsx)(e.code,{children:"sys_call_table"})," \u7684\u5730\u5740: ",(0,l.jsx)(e.code,{children:"grep sys_call_table /boot/System.map-uname -r"})]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u63a7\u5236\u9875\u8868\u53ea\u8bfb\u5c5e\u6027\u662f\u7531",(0,l.jsx)(e.code,{children:"CR0"}),"\u5bc4\u5b58\u5668\u7684",(0,l.jsx)(e.code,{children:"WP\u4f4d"}),"\u63a7\u5236\u7684\uff0c\u53ea\u8981\u5c06\u8fd9\u4e2a\u4f4d ",(0,l.jsx)(e.strong,{children:"\u6e05\u96f6"})," \u5c31\u53ef\u4ee5\u5bf9\u53ea\u8bfb\u9875\u8868\u8fdb\u884c\u4fee\u6539\u3002"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5b9e\u4f8b\u4ee3\u7801\u5728 ",(0,l.jsx)(e.a,{href:"https://zhuanlan.zhihu.com/p/549849135",children:"https://zhuanlan.zhihu.com/p/549849135"})]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"/* make the page writable */\nint make_rw(unsigned long address) {\n    unsigned int level;\n    pte_t *pte = lookup_address(address, &level); // \u67e5\u627e\u865a\u62df\u5730\u5740\u6240\u5728\u7684\u9875\u8868\u5730\u5740\n    pte->pte |= _PAGE_RW; // \u8bbe\u7f6e\u9875\u8868\u8bfb\u5199\u5c5e\u6027\n    return 0;\n}\n \n/* make the page write protected */\nint make_ro(unsigned long address) {\n    unsigned int level;\n    pte_t *pte = lookup_address(address, &level);\n    pte->pte &= ~_PAGE_RW; // \u8bbe\u7f6e\u53ea\u8bfb\u5c5e\u6027\n    return 0;\n}\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'// \u5f00\u59cb\u66ff\u6362\u7cfb\u7edf\u8c03\u7528\nstatic int syscall_init_module(void) {\n    orig_getdents = sys_call_table[__NR_getdents];\n    make_rw((unsigned long)sys_call_table); // \u4fee\u6539\u9875\u5c5e\u6027\n    sys_call_table[__NR_getdents] = (unsigned long *)hacked_getdents; // \u8bbe\u7f6e\u65b0\u7684\u7cfb\u7edf\u8c03\u7528\u5730\u5740\n    make_ro((unsigned long)sys_call_table);\n    return 0;\n}\n\n// \u6062\u590d\u539f\u72b6\nstatic void syscall_cleanup_module(void) {\n    printk(KERN_ALERT "Module syscall unloaded.\\n");\n    make_rw((unsigned long)sys_call_table);\n    sys_call_table[__NR_getdents] = (unsigned long *)orig_getdents;\n    make_ro((unsigned long)sys_call_table);\n}\n'})}),"\n",(0,l.jsx)(e.h4,{id:"213-\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf",children:"2.1.3 \u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf"}),"\n",(0,l.jsxs)(e.p,{children:["Linux\u901a\u8fc7",(0,l.jsx)(e.code,{children:"vfs\u865a\u62df\u6587\u4ef6\u7cfb\u7edf"}),"\u6765\u7edf\u4e00\u62bd\u8c61\u5177\u4f53\u7684\u78c1\u76d8\u6587\u4ef6\u7cfb\u7edf\uff0c\u4ece\u4e0a\u5230\u4e0b\u7684IO\u6808\u5f62\u6210\u4e86\u4e00\u4e2a\u5806\u6808\u5f0f\u3002"]}),"\n",(0,l.jsx)(e.p,{children:"\u901a\u8fc7\u5bf9\u5185\u6838\u6e90\u7801\u7684\u5206\u6790\uff0c\u4ee5\u4e00\u6b21\u8bfb\u64cd\u4f5c\u4e3a\u4f8b\uff0c\u4ece\u4e0a\u5230\u4e0b\u6240\u6267\u884c\u7684\u6d41\u7a0b\u5982\u4e0b:"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.img,{alt:"\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\u8fc7\u7a0b ##w500##",src:i(84887).A+"",width:"631",height:"612"})}),"\n",(0,l.jsx)(e.p,{children:"\u5185\u6838\u4e2d\u91c7\u7528\u4e86\u5f88\u591ac\u8bed\u8a00\u5f62\u5f0f\u7684\u9762\u5411\u5bf9\u8c61\uff0c\u4e5f\u5c31\u662f\u51fd\u6570\u6307\u9488\u7684\u5f62\u5f0f\uff0c\u4f8b\u5982read\u662fvfs\u63d0\u4f9b\u7528\u6237\u7684\u63a5\u53e3\uff0c\u5177\u4f53\u5e95\u4e0b\u8c03\u7528\u7684\u662fext2\u7684read\u64cd\u4f5c\u3002\u6211\u4eec\u53ea\u8981\u5b9e\u73b0VFS\u63d0\u4f9b\u7684\u5404\u79cd\u63a5\u53e3\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\u3002L"}),"\n",(0,l.jsx)(e.p,{children:"\u5b9e\u73b0\u4e86\u4e00\u4e2a\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\uff0c\u76f8\u5f53\u4e8e\u6240\u6709\u7684\u8bfb\u5199\u64cd\u4f5c\u90fd\u4f1a\u8fdb\u5165\u5230\u6211\u4eec\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ef\u4ee5\u62ff\u5230\u6240\u6709\u7684\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u505a\u4e00\u4e9b\u62e6\u622a\u8fc7\u6ee4\u3002"}),"\n",(0,l.jsx)(e.h4,{id:"214-inline-hook",children:"2.1.4 inline hook"}),"\n",(0,l.jsx)(e.p,{children:"\u6211\u4eec\u77e5\u9053\u5185\u6838\u4e2d\u7684\u51fd\u6570\u4e0d\u53ef\u80fd\u628a\u6240\u6709\u529f\u80fd\u90fd\u5728\u8fd9\u4e2a\u51fd\u6570\u4e2d\u5168\u90e8\u5b9e\u73b0\uff0c\u5b83\u5fc5\u5b9a\u8981\u8c03\u7528\u5b83\u7684\u4e0b\u5c42\u51fd\u6570\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u5982\u679c\u8fd9\u4e2a\u4e0b\u5c42\u51fd\u6570\u53ef\u4ee5\u5f97\u5230\u6211\u4eec\u60f3\u8981\u7684\u8fc7\u6ee4\u4fe1\u606f\u5185\u5bb9\uff0c\u5c31\u53ef\u4ee5\u628a\u4e0b\u5c42\u51fd\u6570\u5728\u4e0a\u5c42\u51fd\u6570\u4e2d\u7684offset\u66ff\u6362\u6210\u65b0\u7684\u51fd\u6570\u7684offset\uff0c\u8fd9\u6837\u4e0a\u5c42\u51fd\u6570\u8c03\u7528\u4e0b\u5c42\u51fd\u6570\u65f6\uff0c\u5c31\u4f1a\u8df3\u5230\u65b0\u7684\u51fd\u6570\u4e2d\uff0c\u5728\u65b0\u7684\u51fd\u6570\u4e2d\u505a\u8fc7\u6ee4\u548c\u52ab\u6301\u5185\u5bb9\u7684\u5de5\u4f5c\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u6240\u4ee5\u4ece\u539f\u7406\u4e0a\u6765\u8bf4\uff0cinline hook\u53ef\u4ee5\u60f3hook\u54ea\u91cc\u5c31hook\u54ea\u91cc\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u4f46\u662f\u6709\u4e24\u4e2a\u95ee\u9898:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u5982\u4f55\u5b9a\u4f4dhook\u70b9."}),"\n",(0,l.jsx)(e.li,{children:"\u5982\u4f55\u6ce8\u5165hook\u51fd\u6570\u5165\u53e3."}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u7b2c\u4e00\u4e2a\u9700\u8981\u4f60\u770b\u8fc7\u5bf9\u5e94\u7684\u5185\u6838\u6e90\u7801"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\u7b2c\u4e8c\u4e2a\u6709\u4e24\u79cd\u65b9\u6cd5:\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u63a5\u8fdb\u884c\u4e8c\u8fdb\u5236\u66ff\u6362\uff0c\u5c06call\u6307\u4ee4\u7684\u64cd\u4f5c\u6570\u66ff\u6362\u4e3ahook\u51fd\u6570\u7684\u5730\u5740"}),"\n",(0,l.jsxs)(e.li,{children:["Linux\u5185\u6838\u63d0\u4f9b\u7684kprobes\u673a\u5236\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u5176\u539f\u7406\u662f\u5728hook\u70b9\u6ce8\u5165int 3(x86)\u7684\u673a\u5668\u7801\uff0c\u8ba9cpu\u8fd0\u884c\u5230\u8fd9\u91cc\u7684\u65f6\u5019\u4f1a\u89e6\u53d1sig_trap\u4fe1\u53f7\uff0c\u7136\u540e\u5c06\u7528\u6237\u81ea\u5b9a\u4e49\u7684hook\u51fd\u6570\u6ce8\u5165\u5230sig_trap\u7684\u56de\u8c03\u51fd\u6570\u4e2d\uff0c\u8fbe\u5230\u89e6\u53d1hook\u51fd\u6570\u7684\u76ee\u7684\u3002\u8fd9\u4e2a\u5176\u5b9e\u4e5f\u662f\u8c03\u8bd5\u5668\u7684\u539f\u7406\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h4,{id:"215-lsm-\u5185\u6838\u5b89\u5168\u6a21\u5757",children:"2.1.5 LSM (\u5185\u6838\u5b89\u5168\u6a21\u5757)"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.img,{alt:"\u5185\u6838\u5b89\u5168\u6a21\u5757 ##w500##",src:i(19489).A+"",width:"639",height:"624"})}),"\n",(0,l.jsx)(e.p,{children:"LSM\u5728\u5185\u6838\u4e2d\u505a\u4e86\u4ee5\u4e0b\u5de5\u4f5c:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u5728\u7279\u5b9a\u7684\u5185\u6838\u6570\u636e\u7ed3\u6784\u4e2d\u52a0\u5165\u5b89\u5168\u57df\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u5728\u5185\u6838\u6e90\u4ee3\u7801\u4e2d\u4e0d\u540c\u7684\u5173\u952e\u70b9\u63d2\u5165\u5bf9\u5b89\u5168\u94a9\u5b50\u51fd\u6570\u7684\u8c03\u7528\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u52a0\u5165\u4e00\u4e2a\u901a\u7528\u7684\u5b89\u5168\u7cfb\u7edf\u8c03\u7528\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u63d0\u4f9b\u4e86\u51fd\u6570\u5141\u8bb8\u5185\u6838\u6a21\u5757\u6ce8\u518c\u4e3a\u5b89\u5168\u6a21\u5757\u6216\u8005\u6ce8\u9500\u3002"}),"\n",(0,l.jsx)(e.li,{children:"\u5c06capabilities\u903b\u8f91\u7684\u5927\u90e8\u5206\u79fb\u690d\u4e3a\u4e00\u4e2a\u53ef\u9009\u7684\u5b89\u5168\u6a21\u5757,\u5177\u6709\u53ef\u6269\u5c55\u6027\u3002"}),"\n"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5b9e\u4f8b: ",(0,l.jsx)(e.a,{href:"https://rivers.chaitin.cn/blog/cqj64sh0lnedo7thptp0",children:"https://rivers.chaitin.cn/blog/cqj64sh0lnedo7thptp0"})]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'#include <linux/module.h> // included for all kernel modules\n#include <linux/kernel.h> // included for KERN_INFO\n#include <linux/init.h>   // included for __init and __exit macros\n#include <linux/netfilter.h>\n#include <linux/netfilter_ipv4.h>\n#include <linux/netdevice.h>\n#include <linux/vmalloc.h>\n\nMODULE_LICENSE("GPL");\nMODULE_DESCRIPTION("A Simple Hello Packet Module");\n\nenum {\n    NF_IP_PRE_ROUTING,\n    NF_IP_LOCAL_IN,\n    NF_IP_FORWARD,\n    NF_IP_LOCAL_OUT,\n    NF_IP_POST_ROUTING,\n    NF_IP_NUMHOOKS\n};\n\nstatic struct nf_hook_ops in_nfho;  // net filter hook option struct\nstatic struct nf_hook_ops out_nfho; // net filter hook option struct\n\nstatic void dump_addr(unsigned char *iphdr) {\n    int i;\n    for (i = 0; i < 4; i++) {\n        printk("%d.", *(iphdr + 12 + i));\n    }\n    printk(" -> ");\n    for (i = 0; i < 4; i++) {\n        printk("%d.", *(iphdr + 16 + i));\n    }\n    printk("\\n");\n}\n\nunsigned int my_hook(void *priv, struct sk_buff *skb, const struct nf_hook_state *state) {\n    printk("Hello packet! ");\n    // printk("from %s to %s\\n", in->name, out->name);\n    unsigned char *iphdr = skb_network_header(skb);\n    if (iphdr)\n    {\n        dump_addr(iphdr);\n    }\n    return NF_ACCEPT;\n    // return NF_DROP;//\u4f1a\u5bfc\u81f4\u4e0a\u4e0d\u4e86\u7f51\n}\n\nstatic int __init init_func(void) {\n    // NF_IP_PRE_ROUTING hook\n    in_nfho.hook = my_hook;\n    in_nfho.hooknum = NF_IP_LOCAL_IN;\n    in_nfho.pf = PF_INET;\n    in_nfho.priority = NF_IP_PRI_FIRST;\n\n    nf_register_net_hook(&init_net, &in_nfho);\n\n    // NF_IP_LOCAL_OUT hook\n    out_nfho.hook = my_hook;\n    out_nfho.hooknum = NF_IP_LOCAL_OUT;\n    out_nfho.pf = PF_INET;\n    out_nfho.priority = NF_IP_PRI_FIRST;\n\n    nf_register_net_hook(&init_net, &out_nfho);\n    return 0;\n}\n\nstatic void __exit exit_func(void) {\n    nf_unregister_net_hook(&init_net, &in_nfho);\n    nf_unregister_net_hook(&init_net, &out_nfho);\n    printk(KERN_INFO "Cleaning up Hello_Packet module.\\n");\n}\n\nmodule_init(init_func);\nmodule_exit(exit_func);\n'})}),"\n",(0,l.jsx)(e.h4,{id:"216-ebpf",children:"2.1.6 ebpf"}),"\n",(0,l.jsx)(e.p,{children:"eBPF \u662f\u4e00\u4e2a\u5728\u5185\u6838\u4e2d\u8fd0\u884c\u7684\u865a\u62df\u673a\uff0c\u5b83\u53ef\u4ee5\u53bb\u8fd0\u884c\u7528\u6237\u3002\u5728\u7528\u6237\u6001\u5b9e\u73b0\u7684\u8fd9\u79cd eBPF \u7684\u4ee3\u7801\uff0c\u5728\u5185\u6838\u4ee5\u672c\u5730\u4ee3\u7801\u7684\u5f62\u5f0f\u548c\u901f\u5ea6\u53bb\u6267\u884c\uff0c\u5b83\u53ef\u4ee5\u8ddf\u5185\u6838\u7684 Trace \u7cfb\u7edf\u76f8\u7ed3\u5408\uff0c\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u5728\u7ebf\u6269\u5c55\u5185\u6838\u529f\u80fd\u7684\u6280\u672f\u3002"}),"\n",(0,l.jsx)(e.p,{children:"eBPF\u7684hook\u70b9\u529f\u80fd\u5305\u62ec\u4ee5\u4e0b\u51e0\u90e8\u5206:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ef\u4ee5\u5728Storage\u3001Network\u7b49\u4e0e\u5185\u6838\u4ea4\u4e92\u4e4b\u95f4\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"\u4e5f\u53ef\u4ee5\u5728\u5185\u6838\u4e2d\u7684\u529f\u80fd\u6a21\u5757\u4ea4\u4e92\u4e4b\u95f4\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"\u53c8\u53ef\u4ee5\u5728\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u4ea4\u4e92\u4e4b\u95f4\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"\u66f4\u53ef\u4ee5\u5728\u7528\u6237\u6001\u8fdb\u7a0b\u7a7a\u95f4\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.h4,{id:"217-\u603b\u7ed3",children:"2.1.7 \u603b\u7ed3"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u52a8\u6001\u5e93\u52ab\u6301\u4e0d\u592a\u5b8c\u5168\uff0c\u52ab\u6301\u7684\u4fe1\u606f\u6709\u53ef\u80fd\u6ee1\u8db3\u4e0d\u4e86\u6211\u4eec\u7684\u9700\u6c42\uff0c\u8fd8\u6709\u53ef\u80fd\u522b\u4eba\u5728\u4f60\u4e4b\u524d\u52ab\u6301\u4e86\uff0c\u4e00\u65e6\u7981\u7528 ",(0,l.jsx)(e.code,{children:"LD_PRELOAD"})," \u5c31\u5931\u6548\u4e86\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u7cfb\u7edf\u8c03\u7528\u52ab\u6301\uff0c\u52ab\u6301\u7684\u4fe1\u606f\u6709\u53ef\u80fd\u6ee1\u8db3\u4e0d\u4e86\u6211\u4eec\u7684\u9700\u6c42\uff0c\u4f8b\u5982\u4e0d\u80fd\u83b7\u53d6 ",(0,l.jsx)(e.code,{children:"struct file"})," \u7ed3\u6784\u4f53\uff0c\u4e0d\u80fd\u83b7\u53d6\u6587\u4ef6\u7684",(0,l.jsx)(e.code,{children:"\u7edd\u5bf9\u8def\u5f84"}),"\u7b49\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f9d\u8d56\u4e8eMount,\u53ef\u80fd\u9700\u8981\u91cd\u542f\u7cfb\u7edf\u3002"}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"inline hook\uff0c\u7075\u6d3b\u6027\u9ad8\uff0c\u968f\u610fHook\uff0c\u5373\u65f6\u751f\u6548\u65e0\u9700\u91cd\u542f\uff0c\u4f46\u662f\u5728\u4e0d\u540c\u5185\u6838\u7248\u672c\u4e4b\u95f4\u901a\u7528\u6027\u5dee\uff0c\u4e00\u65e6\u67d0\u4e9b\u51fd\u6570\u53d1\u751f\u4e86\u53d8\u5316\uff0cHook\u5931\u6548\u3002"}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"LSM\uff0c\u5728\u65e9\u671f\u7684\u5185\u6838\u4e2d\uff0c\u53ea\u80fd\u5141\u8bb8\u4e00\u4e2aLSM\u5185\u6838\u6a21\u5757\u52a0\u8f7d\uff0c\u4f8b\u5982\u52a0\u8f7d\u4e86SELinux\uff0c\u5c31\u4e0d\u80fd\u52a0\u8f7d\u5176\u4ed6\u7684LSM\u6a21\u5757\uff0c\u5728\u6700\u65b0\u7684\u5185\u6838\u7248\u672c\u4e2d\u4e0d\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\u3002"}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"eBPF Hook,\u53ef\u4ee5\u7528\u6237\u6001\u7f16\u7a0b\u63a7\u5236\uff0c\u7075\u6d3b\u6027\u9ad8\uff0c\u5373\u65f6\u751f\u6548\u65e0\u9700\u91cd\u542f\uff0c\u4f46\u4f9d\u8d56\u5185\u6838\u7684\u7248\u672c\uff0c\u901a\u7528\u6027\u5dee\uff0c\u4e00\u65e6\u67d0\u4e9b\u51fd\u6570\u53d1\u751f\u4e86\u53d8\u5316\uff0cHook\u5931\u6548\u3002"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"22-lsm-hook\u70b9\u8bf4\u660e",children:"2.2 LSM hook\u70b9\u8bf4\u660e"}),"\n",(0,l.jsx)(e.p,{children:"\u5728VFS\uff08\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\uff09\u5c42\u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e09\u4e2a\u4e3b\u8981\u5bf9\u8c61\uff0c\u5b83\u4eec\u5c01\u88c5\u4e86\u4f4e\u7ea7\u6587\u4ef6\u7cfb\u7edf\u5f00\u53d1\u6240\u4f7f\u7528\u7684\u63a5\u53e3:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"super_block\uff08\u8d85\u7ea7\u5757\uff09\u5bf9\u8c61\nfile\uff08\u6587\u4ef6\uff09\u5bf9\u8c61\ninode\uff08\u7d22\u5f15\u8282\u70b9\uff09\u5bf9\u8c61\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u5305\u542b\u4e00\u7ec4\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5b9a\u4e49\u4e86VFS\u4e0e\u5b9e\u9645\u6587\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u7684\u63a5\u53e3\u3002LSM\uff08Linux\u5b89\u5168\u6a21\u5757\uff09\u5229\u7528\u8fd9\u4e9b\u63a5\u53e3\u6765\u4ecb\u5165\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u3002"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"LSM\u4f7f\u7528\u5185\u6838\u5bf9\u8c61\u4e2d\u5b9a\u4e49\u7684\u4e0d\u900f\u660e\u5b89\u5168\u6307\u9488; \u901a\u8fc7\u5728\u8fd9\u4e9b\u7ed3\u6784\u4f53\u4e2d\u6dfb\u52a0\u5b89\u5168\u6307\u9488\uff0cLSM\u53ef\u4ee5\u76d1\u89c6\u548c\u63a7\u5236\u4e0e\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u64cd\u4f5c\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u8fd9\u6837\uff0cLSM\u53ef\u4ee5\u5728\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u8fc7\u7a0b\u4e2d\u4ecb\u5165\uff0c\u6267\u884c\u5b89\u5168\u7b56\u7565\u68c0\u67e5\u3001\u6743\u9650\u63a7\u5236\u7b49\u64cd\u4f5c\uff0c\u4ee5\u589e\u5f3a\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.h4,{id:"221-lsm-super_block-hooks",children:"2.2.1 LSM super_block hooks"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"struct super_block {\n\t......\n#ifdef CONFIG_SECURITY\n\tvoid *s_security;\n#endif\n\t.....\n}\n"})}),"\n",(0,l.jsxs)(e.p,{children:["\u5f53\u6587\u4ef6\u7cfb\u7edf\u5728\u5185\u6838\u4e2d\u8868\u793a\u65f6, ",(0,l.jsx)(e.code,{children:"super_block"})," \u7ed3\u6784\u4f53\u662f\u4ee3\u8868\u8be5\u6587\u4ef6\u7cfb\u7edf\u7684\u5185\u6838\u5bf9\u8c61\u3002"]}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.code,{children:"super_block"})," \u7ed3\u6784\u4f53\u5728\u6302\u8f7d\u548c\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u4ee5\u53ca\u83b7\u53d6\u6587\u4ef6\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\u65f6\u88ab\u4f7f\u7528\u3002"]}),"\n",(0,l.jsxs)(e.p,{children:["LSM\uff08Linux\u5b89\u5168\u6a21\u5757\uff09\u63d0\u4f9b\u4e86\u4e00\u7ec4\u94a9\u5b50\u51fd\u6570\uff0c\u7528\u4e8e\u4ecb\u5165\u5bf9 ",(0,l.jsx)(e.code,{children:"super_block"})," \u7684\u5404\u79cd\u64cd\u4f5c\u3002"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u5728\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u65f6\uff0c\u5185\u6838\u9996\u5148\u901a\u8fc7\u8c03\u7528 ",(0,l.jsx)(e.code,{children:"sb_mount()"})," \u94a9\u5b50\u51fd\u6570\u6765\u9a8c\u8bc1\u6302\u8f7d\u8bf7\u6c42\u7684\u6709\u6548\u6027\u3002LSM\u53ef\u4ee5\u4f7f\u7528\u8be5\u94a9\u5b50\u51fd\u6570\u6267\u884c\u989d\u5916\u7684\u5b89\u5168\u68c0\u67e5\uff0c\u4f8b\u5982\u9a8c\u8bc1\u6302\u8f7d\u4efb\u52a1\u7684\u6743\u9650\u6216\u786e\u4fdd\u6302\u8f7d\u9009\u9879\u7684\u6709\u6548\u6027\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:["\u5728\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u65f6\uff0c\u4f1a\u8c03\u7528 ",(0,l.jsx)(e.code,{children:"sb_umount()"})," \u94a9\u5b50\u51fd\u6570\u6765\u68c0\u67e5\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u6240\u9700\u7684\u6743\u9650\u3002LSM\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u94a9\u5b50\u51fd\u6570\u6765\u6267\u884c\u8bbf\u95ee\u63a7\u5236\uff0c\u786e\u4fdd\u53ea\u6709\u6388\u6743\u7684\u4efb\u52a1\u80fd\u591f\u6267\u884c\u5378\u8f7d\u64cd\u4f5c\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.code,{children:"sb_remount()"})," \u94a9\u5b50\u51fd\u6570\u5728\u4fee\u6539\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u9009\u9879\u65f6\u88ab\u8c03\u7528\u3002LSM\u53ef\u4ee5\u5229\u7528\u8be5\u94a9\u5b50\u51fd\u6570\u9a8c\u8bc1\u8bf7\u6c42\u7684\u6302\u8f7d\u9009\u9879\u7684\u6709\u6548\u6027\u548c\u5b89\u5168\u6027\u3002"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5f53\u4efb\u52a1\u5c1d\u8bd5\u83b7\u53d6\u6587\u4ef6\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\uff08\u5982\u78c1\u76d8\u4f7f\u7528\u60c5\u51b5\u6216\u53ef\u7528\u7a7a\u95f4\uff09\u65f6\uff0c\u4f1a\u8c03\u7528 ",(0,l.jsx)(e.code,{children:"sb_statfs()"})," \u94a9\u5b50\u51fd\u6570\u3002LSM\u53ef\u4ee5\u4f7f\u7528\u8be5\u94a9\u5b50\u51fd\u6570\u6267\u884c\u6743\u9650\u68c0\u67e5\uff0c\u786e\u4fdd\u53ea\u6709\u6388\u6743\u7684\u4efb\u52a1\u80fd\u591f\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\u3002"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"union security_list_options {\n\t// ......\n\tint (*sb_remount)(struct super_block *sb, void *mnt_opts);\n\tint (*sb_statfs)(struct dentry *dentry);\n\tint (*sb_mount)(const char *dev_name, const struct path *path,\n\t\t\tconst char *type, unsigned long flags, void *data);\n\tint (*sb_umount)(struct vfsmount *mnt, int flags);\n\t// ......\n}\n"})}),"\n",(0,l.jsx)(e.h4,{id:"222-lsm-hooks",children:"2.2.2 LSM hooks"}),"\n",(0,l.jsx)(e.p,{children:"\u540c\u7406\u8fd8\u6709\u4ee5\u4e0bhook:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-md",children:"\u4e00\u3001LSM file system hooks\n    1.1 LSM super_block hooks\n    1.2 LSM file hooks\n    1.3 LSM inode hooks\n\u4e8c\u3001LSM Task hooks\n    > \u5f53\u4efb\u52a1\u5728\u5185\u6838\u4e2d\u8868\u793a\u4e3a\u53ef\u8c03\u5ea6\u4efb\u52a1\u65f6\uff0ctask_struct \u7ed3\u6784\u4f53\u662f\u4ee3\u8868\u8be5\u4efb\u52a1\u7684\u5185\u6838\u5bf9\u8c61\u3002\n    > task_struct \u7ed3\u6784\u4f53\u5305\u542b\u4e86\u4efb\u52a1\u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5982\u7528\u6237/\u7ec4 ID\u3001\u8d44\u6e90\u9650\u5236\u4ee5\u53ca\u8c03\u5ea6\u7b56\u7565\u548c\u4f18\u5148\u7ea7\u7b49\u3002\n\u4e09\u3001LSM IPC hooks\n    > \u5f53\u4efb\u52a1\u9700\u8981\u8bbf\u95ee\u5185\u6838\u4e2d\u7684 SysV IPC \u673a\u5236\u65f6\uff0c\u5185\u6838\u63d0\u4f9b\u4e86\u6807\u51c6\u7684 SysV IPC \u673a\u5236\uff0c\u5305\u62ec\u5171\u4eab\u5185\u5b58\u3001\u4fe1\u53f7\u91cf\u548c\u6d88\u606f\u961f\u5217\u7b49\u3002\u8fd9\u4e9b\u673a\u5236\u5141\u8bb8\u8fdb\u7a0b\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\u548c\u5171\u4eab\u6570\u636e\u3002\n\u56db\u3001LSM Network hooks\n    > \u7f51\u7edc\u662fLinux\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u65b9\u9762\uff0c\u5c24\u5176\u662f\u5728\u4fdd\u62a4\u7cfb\u7edf\u514d\u53d7\u7f51\u7edc\u653b\u51fb\u65b9\u9762\uff0cLSM\u4e3a\u5185\u6838\u7684\u8fd9\u4e2a\u9886\u57df\u63d0\u4f9b\u4e86\u6269\u5c55\u7684\u5b89\u5168\u6027\u3002\u5e94\u7528\u5c42\u5bf9\u7f51\u7edc\u7684\u8bbf\u95ee\u662f\u901a\u8fc7\u4e00\u7cfb\u5217\u4e0e\u5957\u63a5\u5b57\u76f8\u5173\u7684\u94a9\u5b50\u51fd\u6570\u8fdb\u884c\u4ecb\u5165\u7684\u3002\n\u4e94\u3001LSM Module & System hooks\n"})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/farsight_2098/article/details/130875915",children:"https://blog.csdn.net/farsight_2098/article/details/130875915"})}),"\n",(0,l.jsx)(e.p,{children:"\u4ee3\u7801\u5b9e\u4f8b:"}),"\n",(0,l.jsx)(e.p,{children:"\u4e0b\u9762\u662f\u4e00\u4e2a\u57fa\u4e8e\u8fdb\u7a0b\u540d\u548c\u6587\u4ef6\u540d\u5b9e\u73b0\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7279\u5b9a\u6587\u4ef6\u7684LSM\u793a\u4f8b\u4ee3\u7801"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u8fd9\u4e2a\u793a\u4f8b\u7684\u529f\u80fd\u662f\uff0c\u53ea\u5141\u8bb8\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7279\u5b9a\u7684\u6587\u4ef6\u3002\u5f53\u8fdb\u7a0b\u4e0d\u5728\u5141\u8bb8\u8bbf\u95ee\u5217\u8868\u6216\u8005\u8bbf\u95ee\u7684\u6587\u4ef6\u4e0e\u88ab\u4fdd\u62a4\u8def\u5f84\u4e0d\u5339\u914d\u65f6\uff0c\u4f1a\u8fd4\u56de-EACCES\u9519\u8bef\uff0c\u8868\u793a\u62d2\u7edd\u8bbf\u95ee\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'#include <linux/lsm_hooks.h>\n#include <linux/path.h>\n#include <linux/dcache.h>\n#include <linux/namei.h>\n \n// \u5b9a\u4e49\u5141\u8bb8\u8bbf\u95ee\u6587\u4ef6\u7684\u8fdb\u7a0b\u540d\u79f0\nstatic char *allowed_process_name = "my_app";\n// \u5b9a\u4e49\u9700\u8981\u4fdd\u62a4\u7684\u6587\u4ef6\u8def\u5f84\nstatic char *file_path = "path/to/protected/file";\n \n// \u5728inode\u5bf9\u8c61\u8bbf\u95ee\u7684\u94a9\u5b50\u70b9\u4e0a\u5b9e\u73b0\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\nstatic int example_inode_permission(struct inode *inode, int mask) {\n    // \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u7ec4ID\u548c\u8fdb\u7a0bID\n    pid_t current_pid = task_tgid_vnr(current);\n    // \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u540d\u79f0\n    char * current_process_name = (char*)get_task_comm(current);\n \n    // \u5224\u65ad\u8fdb\u7a0b\u540d\u79f0\u548c\u8fdb\u7a0b\u7ec4\u662f\u5426\u5339\u914d\n    if (strcmp(current_process_name, allowed_process_name) || current_pid != pid_nr(get_task_pid(current, PIDTYPE_PID))) {\n        // \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u540d\u79f0\u548c\u8fdb\u7a0b\u7ec4\u548c\u8981\u6c42\u4e0d\u5339\u914d\uff0c\u5219\u62d2\u7edd\u8bbf\u95ee\n        return -EACCES;\n    }\n \n    // \u5224\u65ad\u8bbf\u95ee\u7684\u6587\u4ef6\u8def\u5f84\u662f\u5426\u4e0e\u88ab\u4fdd\u62a4\u8def\u5f84\u5339\u914d\n    struct path file;\n    int err = kern_path(file_path, LOOKUP_FOLLOW, &file);\n    if (err) {\n        printk(KERN_INFO "%!(NOVERB)s not found.\\n", file_path);\n        return -EACCES;\n    }\n    if (file.dentry != inode->i_dentry) {\n        return -EACCES;\n    }\n \n    // \u5141\u8bb8\u8fdb\u7a0b\u8bbf\u95ee\u6587\u4ef6\n    return 0;\n}\n \n// \u5b9a\u4e49\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\u5217\u8868\nstatic struct security_hook_list example_hooks[] = {\n    LSM_HOOK_INIT(inode_permission, example_inode_permission),\n};\n \n// \u5b89\u5168\u6a21\u5757\u521d\u59cb\u5316\u51fd\u6570\nstatic __init int example_init(void) {\n    printk(KERN_INFO "example LSM initialized\\n");\n \n    // \u6ce8\u518c\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\n    security_add_hooks(example_hooks, ARRAY_SIZE(example_hooks));\n \n    return 0;\n}\n \n// \u5b89\u5168\u6a21\u5757\u6ce8\u9500\u51fd\u6570\nstatic __exit void example_exit(void) {\n    printk(KERN_INFO "example LSM exited\\n");\n\n    // \u5220\u9664\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\n    security_delete_hooks(example_hooks, ARRAY_SIZE(example_hooks));\n}\n \n// \u6a21\u5757\u521d\u59cb\u5316\u548c\u6ce8\u9500\u51fd\u6570\nsecurity_initcall(example_init);\nmodule_exit(example_exit);\n \nMODULE_LICENSE("GPL");\nMODULE_DESCRIPTION("LSM\u793a\u4f8b\uff1a\u4ec5\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7279\u5b9a\u6587\u4ef6");\n'})}),"\n",(0,l.jsx)(e.p,{children:"\u4e0b\u9762\u662f\u4e00\u4e2a\u57fa\u4e8e\u7279\u5b9a\u8fdb\u7a0b\u540d\u5b9e\u73b0\u53ea\u6709\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u4f7f\u7528\u7f51\u7edc\u7684LSM\u793a\u4f8b\u4ee3\u7801:"}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsx)(e.p,{children:"\u793a\u4f8b\u7684\u529f\u80fd\u662f\uff0c\u53ea\u5141\u8bb8\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u4f7f\u7528\u7f51\u7edc\u3002\u5982\u679c\u8fdb\u7a0b\u4e0d\u5728\u5141\u8bb8\u4f7f\u7528\u7f51\u7edc\u7684\u5217\u8868\u4e2d\uff0c\u4f1a\u8fd4\u56de-EACCES\u9519\u8bef\uff0c\u8868\u793a\u62d2\u7edd\u4f7f\u7528\u7f51\u7edc\u3002\u6b64\u793a\u4f8b\u91cd\u70b9\u6d4b\u8bd5\u5957\u63a5\u5b57\u548c\u8fde\u63a5\u5230\u8fdc\u7a0b\u4e3b\u673a\u7684\u884c\u4e3a\uff0c\u4f46\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u5176\u4ed6\u9002\u5f53\u7684\u94a9\u5b50\u6765\u6269\u5c55\u5176\u529f\u80fd\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'#include <linux/lsm_hooks.h>\n#include <linux/net.h>\n#include <linux/sched.h>\n \n// \u5b9a\u4e49\u5141\u8bb8\u4f7f\u7528\u7f51\u7edc\u7684\u8fdb\u7a0b\u540d\u79f0\nstatic char *allowed_process_name = "my_network_app";\n \n// \u5728socket\u5bf9\u8c61\u8bbf\u95ee\u7684\u94a9\u5b50\u70b9\u4e0a\u5b9e\u73b0\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\nstatic int example_socket_socket_create(int family, int type, int protocol, int kern) {\n    // \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u540d\u79f0\n    char * current_process_name = (char*)get_task_comm(current);\n \n    // \u5224\u65ad\u5f53\u524d\u8fdb\u7a0b\u540d\u79f0\u662f\u5426\u5339\u914d\u5141\u8bb8\u4f7f\u7528\u7f51\u7edc\u7684\u8fdb\u7a0b\u540d\u79f0\n    if (strcmp(current_process_name, allowed_process_name)) {\n        return -EACCES;\n    }\n \n    return 0;\n}\n \n// \u5728bind\uff08\u7ed1\u5b9a\u5957\u63a5\u5b57\uff09\u94a9\u5b50\u70b9\u4e0a\u5b9e\u73b0\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\nstatic int example_socket_socket_bind(struct socket *sock, struct sockaddr *address, int addrlen) {\n    // \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u540d\u79f0\n    char * current_process_name = (char*)get_task_comm(current);\n \n    // \u5224\u65ad\u5f53\u524d\u8fdb\u7a0b\u540d\u79f0\u662f\u5426\u5339\u914d\u5141\u8bb8\u4f7f\u7528\u7f51\u7edc\u7684\u8fdb\u7a0b\u540d\u79f0\n    if (strcmp(current_process_name, allowed_process_name)) {\n        return -EACCES;\n    }\n \n    return 0;\n}\n \n// \u5728connect\uff08\u8fde\u63a5\u5230\u8fdc\u7a0b\u4e3b\u673a\uff09\u94a9\u5b50\u70b9\u4e0a\u5b9e\u73b0\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\nstatic int example_socket_socket_connect(struct socket *sock, struct sockaddr *address, int addrlen, int flags) {\n    // \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u540d\u79f0\n    char * current_process_name = (char*)get_task_comm(current);\n \n    // \u5224\u65ad\u5f53\u524d\u8fdb\u7a0b\u540d\u79f0\u662f\u5426\u5339\u914d\u5141\u8bb8\u4f7f\u7528\u7f51\u7edc\u7684\u8fdb\u7a0b\u540d\u79f0\n    if (strcmp(current_process_name, allowed_process_name)) {\n        return -EACCES;\n    }\n \n    return 0;\n}\n \n// \u5b9a\u4e49\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\u5217\u8868\nstatic struct security_hook_list example_hooks[] = {\n    LSM_HOOK_INIT(socket_socket_create, example_socket_socket_create),\n    LSM_HOOK_INIT(socket_bind, example_socket_socket_bind),\n    LSM_HOOK_INIT(socket_connect, example_socket_socket_connect),\n};\n \n// \u5b89\u5168\u6a21\u5757\u521d\u59cb\u5316\u51fd\u6570\nstatic __init int example_init(void) {\n    printk(KERN_INFO "example LSM initialized\\n");\n \n    // \u6ce8\u518c\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\n    security_add_hooks(example_hooks, ARRAY_SIZE(example_hooks));\n \n    return 0;\n}\n \n// \u5b89\u5168\u6a21\u5757\u6ce8\u9500\u51fd\u6570\nstatic __exit void example_exit(void) {\n    printk(KERN_INFO "example LSM exited\\n");\n \n    // \u5220\u9664\u81ea\u5b9a\u4e49\u94a9\u5b50\u51fd\u6570\n    security_delete_hooks(example_hooks, ARRAY_SIZE(example_hooks));\n}\n \n// \u6a21\u5757\u521d\u59cb\u5316\u548c\u6ce8\u9500\u51fd\u6570\nsecurity_initcall(example_init);\nmodule_exit(example_exit);\n \nMODULE_LICENSE("GPL");\nMODULE_DESCRIPTION("LSM\u793a\u4f8b\uff1a\u4ec5\u7279\u5b9a\u8fdb\u7a0b\u53ef\u4ee5\u4f7f\u7528\u7f51\u7edc");\n'})}),"\n",(0,l.jsx)(e.h3,{id:"23-lsm-\u4e0e-bpf",children:"2.3 LSM \u4e0e BPF"}),"\n",(0,l.jsx)(e.h4,{id:"231-\u7cfb\u7edf\u8ba4\u8bc6-lsm",children:"2.3.1 \u7cfb\u7edf\u8ba4\u8bc6 LSM"}),"\n",(0,l.jsx)(e.p,{children:"LSM\uff08Linux Security Module\uff09 \u4e2d\u6587\u7ffb\u8bd1\u4e3a\u5185\u6838\u5b89\u5168\u6a21\u5757\uff0c\u5c3d\u7ba1\u4ece\u540d\u5b57\u4e0a\u662f\u5b89\u5168\u6a21\u5757\uff0c\u4f46 LSM \u5176\u5b9e\u662f\u4e00\u4e2a\u5728\u5185\u6838\u5404\u4e2a\u5b89\u5168\u6a21\u5757\u7684\u57fa\u7840\u4e0a\u63d0\u51fa\uff08\u62bd\u8c61\u51fa\uff09\u7684\u8f7b\u91cf\u7ea7\u5b89\u5168\u8bbf\u95ee\u63a7\u5236\u6846\u67b6\u3002\u8be5\u6846\u67b6\u53ea\u662f\u63d0\u4f9b\u4e00\u4e2a\u652f\u6301\u5b89\u5168\u6a21\u5757\u7684\u63a5\u53e3\uff0c\u672c\u8eab\u4e0d\u80fd\u589e\u5f3a\u7cfb\u7edf\u5b89\u5168\u6027\uff0c\u5177\u4f53\u7684\u5de5\u4f5c\u4ea4\u7ed9\u5404\u5b89\u5168\u6a21\u5757\u6765\u505a\u3002"}),"\n",(0,l.jsxs)(e.p,{children:["LSM \u5728\u5185\u6838\u4e2d\u4f53\u73b0\u4e3a\u4e00\u7ec4\u5b89\u5168\u76f8\u5173\u7684\u51fd\u6570\uff0c\u662f\u63d0\u4f9b\u5b9e\u65bd\u5f3a\u5236\u8bbf\u95ee\u63a7\u5236\uff08MAC\uff09\u6a21\u5757\u7684\u5fc5\u8981\u7ec4\u4ef6\uff0c\u53ef\u5b9e\u73b0\u7b56\u7565\u4e0e\u5185\u6838\u6e90\u4ee3\u7801\u89e3\u8026\u3002\u5b89\u5168\u51fd\u6570\u5728\u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8def\u5f84\u4e2d\u4f1a\u88ab\u8c03\u7528\uff0c\u5bf9\u7528\u6237\u6001\u8fdb\u7a0b\u8bbf\u95ee\u5185\u6838\u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u5f3a\u5236\u8bbf\u95ee\u63a7\u5236\uff0c\u53d7\u4fdd\u62a4\u7684\u5bf9\u8c61\u7c7b\u578b\u5305\u62ec\u6587\u4ef6\u3001\u76ee\u5f55\u3001\u4efb\u52a1\u5bf9\u8c61\u3001\u51ed\u636e\u7b49\u3002\u4ece\u7248\u672c 5.4 \u5f00\u59cb\uff0c\u8be5\u6846\u67b6\u76ee\u524d\u5305\u62ec\u6574\u4e2a\u5185\u6838\u7684 224 \u4e2a\u6302\u94a9\u70b9\u3001\u4e00\u4e2a\u7528\u4e8e\u6ce8\u518c\u8981\u5728\u8fd9\u4e9b\u6302\u94a9\u70b9\u8c03\u7528\u7684\u51fd\u6570\u7684 API\uff0c\u4ee5\u53ca\u4e00\u4e2a\u7528\u4e8e\u4fdd\u7559\u4e0e\u53d7\u4fdd\u62a4\u5185\u6838\u5bf9\u8c61\u5173\u8054\u7684\u5185\u5b58\u4ee5\u4f9b LSM \u4f7f\u7528\u7684 API\u3002\u5982\u679c\u8981\u60f3\u8981\u8fdb\u4e00\u6b65\u4e86\u89e3\u53ef\u53c2\u8003\u5185\u6838\u6587\u6863 ",(0,l.jsx)(e.a,{href:"https://www.kernel.org/doc/html/latest/admin-guide/LSM/index.html",children:"LSM \u90e8\u5206"})," \u5185\u5bb9\u3002"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.img,{alt:"LSM_AND_BPF ##w500##",src:i(77985).A+"",width:"614",height:"592"})}),"\n",(0,l.jsx)(e.p,{children:"LSM \u80cc\u540e\u7684\u6838\u5fc3\u6982\u5ff5\u662f LSM \u94a9\u5b50\u3002LSM \u94a9\u5b50\u66b4\u9732\u5728\u5185\u6838\u7684\u5173\u952e\u4f4d\u7f6e\uff0c\u53ef\u901a\u8fc7\u6302\u94a9\u8fdb\u884c\u7ba1\u5236\u7684\u64cd\u4f5c\u793a\u4f8b\u5305\u62ec:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c"}),"\n",(0,l.jsx)(e.li,{children:"\u6253\u5f00\u3001\u521b\u5efa\u3001\u79fb\u52a8\u548c\u5220\u9664\u6587\u4ef6"}),"\n",(0,l.jsx)(e.li,{children:"\u6302\u8f7d\u548c\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf"}),"\n",(0,l.jsx)(e.li,{children:"task/process operations \u4efb\u52a1 / \u8fdb\u7a0b\u64cd\u4f5c"}),"\n",(0,l.jsx)(e.li,{children:"\u5206\u914d\u548c\u91ca\u653e\u4efb\u52a1\uff0c\u66f4\u6539\u4efb\u52a1\u7684\u7528\u6237\u548c\u7ec4\u6807\u8bc6"}),"\n",(0,l.jsx)(e.li,{children:"\u5957\u63a5\u5b57\u64cd\u4f5c"}),"\n",(0,l.jsx)(e.li,{children:"\u521b\u5efa\u548c\u7ed1\u5b9a\u5957\u63a5\u5b57"}),"\n",(0,l.jsx)(e.li,{children:"\u63a5\u6536\u548c\u53d1\u9001\u6d88\u606f"}),"\n"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5176\u88ab\u5b9a\u4e49\u5728 ",(0,l.jsx)(e.a,{href:"https://elixir.bootlin.com/linux/v6.2/source/include/linux/lsm_hook_defs.h",children:"lsm_hook_defs.h"})," \u4e2d:"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"/*\n * The macro LSM_HOOK is used to define the data structures required by\n * the LSM framework using the pattern:\n *\n *\tLSM_HOOK(<return_type>, <default_value>, <hook_name>, args...)\n *\n * struct security_hook_heads {\n *   #define LSM_HOOK(RET, DEFAULT, NAME, ...) struct hlist_head NAME;\n *   #include <linux/lsm_hook_defs.h>\n *   #undef LSM_HOOK\n * };\n */\nLSM_HOOK(int, 0, binder_set_context_mgr, const struct cred *mgr)\nLSM_HOOK(int, 0, binder_transaction, const struct cred *from,\n\t const struct cred *to)\nLSM_HOOK(int, 0, binder_transfer_binder, const struct cred *from,\n\t const struct cred *to)\nLSM_HOOK(int, 0, binder_transfer_file, const struct cred *from,\n\t const struct cred *to, struct file *file)\nLSM_HOOK(int, 0, ptrace_access_check, struct task_struct *child,\n\t unsigned int mode)\nLSM_HOOK(int, 0, ptrace_traceme, struct task_struct *parent)\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u683c\u5f0f\u4e3a:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"LSM_HOOK(<return_type>, <default_value>, <hook_name>, args...)\n"})}),"\n",(0,l.jsxs)(e.p,{children:["LSM \u63d0\u4f9b\u7684\u5927\u591a\u6570\u94a9\u5b50\u90fd\u9700\u8981\u8fd4\u56de\u4e00\u4e2a\u6574\u6570\u503c\uff08\u4e5f\u6709\u90e8\u5206\u8fd4\u56de ",(0,l.jsx)(e.code,{children:"void"}),", \u8868\u793a\u5ffd\u7565\u8fd0\u884c\u7ed3\u679c\uff09\uff0c\u8fd4\u56de\u503c\u4e2d\u7684\u503c\u4e00\u822c\u5b9a\u4e49\u5982\u4e0b:"]}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"0 \u7b49\u540c\u4e8e\u6388\u6743\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"ENOMEM \u65e0\u53ef\u7528\u5185\u5b58\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"EACCESS\uff0c\u5b89\u5168\u7b56\u7565\u62d2\u7edd\u8bbf\u95ee\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"EPERM\uff0c\u6267\u884c\u6b64\u64cd\u4f5c\u9700\u8981\u6743\u9650\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.h4,{id:"232-lsm-bpf",children:"2.3.2 LSM BPF"}),"\n",(0,l.jsx)(e.p,{children:"\u5728 LSM BPF \u51fa\u73b0\u4e4b\u524d\uff0c\u80fd\u591f\u5b9e\u73b0\u5b9e\u65bd\u5b89\u5168\u7b56\u7565\u76ee\u6807\u7684\u65b9\u5f0f\u6709\u4e24\u79cd\u9009\u62e9\uff1a\u914d\u7f6e\u73b0\u6709\u7684 LSM \u6a21\u5757\uff08\u5982 AppArmor\u3001SELinux\uff09\uff0c\u6216\u7f16\u5199\u81ea\u5b9a\u4e49\u5185\u6838\u6a21\u5757\u3002LSM BPF \u5219\u63d0\u4f9b\u4e86\u7b2c\u4e09\u79cd\u5b9e\u73b0\u7684\u65b9\u6848 \uff0c\u7075\u6d3b\u4e14\u5b89\u5168\uff0c\u5177\u6709\u53ef\u7f16\u7a0b\u6027\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u4f7f\u7528 LSM BPF\uff0c\u5f00\u53d1\u4eba\u5458\u80fd\u591f\u5728\u65e0\u9700\u914d\u7f6e\u6216\u52a0\u8f7d\u5185\u6838\u6a21\u5757\u7684\u60c5\u51b5\u4e0b\u7f16\u5199\u7cbe\u7ec6\u7b56\u7565\u3002LSM BPF \u7a0b\u5e8f\u4f1a\u5728\u52a0\u8f7d\u65f6\u8fdb\u884c\u9a8c\u8bc1\uff0c\u7136\u540e\u5728\u8c03\u7528\u8def\u5f84\u4e2d\u5230\u8fbe LSM hook \u65f6\u6267\u884c\u3002\u8fd9\u4e9b BPF \u7a0b\u5e8f\u5141\u8bb8\u7279\u6743\u7528\u6237\u5bf9 LSM \u94a9\u5b50\u8fdb\u884c\u8fd0\u884c\u65f6\u68c0\u6d4b\uff0c\u4ee5\u4f7f\u7528 eBPF \u5b9e\u73b0\u7cfb\u7edf\u8303\u56f4\u7684 MAC\uff08\u5f3a\u5236\u8bbf\u95ee\u63a7\u5236\uff09\u548c\u5ba1\u8ba1\u7b56\u7565\u3002"}),"\n",(0,l.jsx)(e.p,{children:"\u622a\u6b62\u5230\u5185\u6838 6.2.0 \u7248\u672c\uff0c BPF \u81ea\u8eab\u5b89\u5168\u76f8\u5173\u7684 LSM hook \u51fd\u6570\u6709 7 \u4e2a \uff0c\u901a\u8fc7\u7f16\u8bd1\u6761\u4ef6\u5b8f CONFIG_BPF_SYSCALL \u63a7\u5236\uff0c\u4e3b\u8981\u8bbe\u6d89\u53ca bpf \u7cfb\u7edf\u8c03\u7528\u3001BPF \u7a0b\u5e8f\u548c BPF map \u76f8\u5173\u64cd\u4f5c:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"#ifdef CONFIG_BPF_SYSCALL\nLSM_HOOK(int, 0, bpf, int cmd, union bpf_attr *attr, unsigned int size)\nLSM_HOOK(int, 0, bpf_map, struct bpf_map *map, fmode_t fmode)\nLSM_HOOK(int, 0, bpf_prog, struct bpf_prog *prog)\nLSM_HOOK(int, 0, bpf_map_alloc_security, struct bpf_map *map)\nLSM_HOOK(void, LSM_RET_VOID, bpf_map_free_security, struct bpf_map *map)\nLSM_HOOK(int, 0, bpf_prog_alloc_security, struct bpf_prog_aux *aux)\nLSM_HOOK(void, LSM_RET_VOID, bpf_prog_free_security, struct bpf_prog_aux *aux)\n#endif /* CONFIG_BPF_SYSCALL */\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u5728\u7ee7\u7eed\u5e76\u5c1d\u8bd5\u7f16\u5199 LSM BPF \u7a0b\u5e8f\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\uff1a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5185\u6838\u7248\u672c\u81f3\u5c11\u4e3a 5.7\uff1b"}),"\n",(0,l.jsx)(e.li,{children:"LSM BPF \u5df2\u542f\u7528\u3002"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"LSM BPF \u7684\u542f\u7528\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u8fdb\u884c\u9a8c\u8bc1\uff0c\u6b63\u786e\u7684\u8f93\u51fa\u5e94\u5305\u542b bpf:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"cat /sys/kernel/security/lsm\ncapability,lockdown,landlock,yama,apparmor,bpf\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u5982\u679c\u6ca1\u6709\uff0c\u5219\u5fc5\u987b\u901a\u8fc7\u5c06 LSM BPF \u6dfb\u52a0\u5230\u5185\u6838\u914d\u7f6e\u53c2\u6570\u4e2d\u6765\u624b\u52a8\u542f\u7528\u5b83\u3002 ..."}),"\n",(0,l.jsx)(e.h3,{id:"\u4e09\u51b3\u7b56",children:"\u4e09\u3001\u51b3\u7b56"}),"\n",(0,l.jsx)(e.h4,{id:"31-hook-\u6280\u672f\u9009\u578b-lsm",children:"3.1 Hook \u6280\u672f\u9009\u578b: LSM"}),"\n",(0,l.jsx)(e.p,{children:"\u6211\u4eec\u8ba4\u8bc6\u4e86 \u5e38\u89c1\u7684 Linux \u7684\u62e6\u622a\u6280\u672f:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"inline hook\u62e6\u622a"}),"\n",(0,l.jsx)(e.li,{children:"LSM(Linux Security Modules)"}),"\n",(0,l.jsx)(e.li,{children:"eBPF Hook\u62e6\u622a"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5148\u8bf4\u7ed3\u8bba, \u9009\u62e9 [5]LSM(Linux Security Modules) \u4f5c\u4e3a Hook \u6280\u672f"}),"\n",(0,l.jsx)(e.p,{children:"\u597d\u5904: \u8fd9\u4e2a\u662f\u7cfb\u7edf\u5185\u6838\u63d0\u4f9b\u7684API, \u76f8\u5bf9\u4e8e\u6211\u4eec\u81ea\u5df1\u5bf9\u975e\u516c\u5f00\u7684\u51fd\u6570\u8fdb\u884chook, \u663e\u7136\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u63d0\u4f9b\u7684API\u4f1a\u66f4\u52a0\u7a33\u5b9a"}),"\n",(0,l.jsxs)(e.div,{className:"markdown-alert markdown-alert-note",children:["\n",(0,l.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,l.jsx)(e.span,{className:"octicon octicon-note",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-info mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Note"]}),"\n",(0,l.jsxs)(e.p,{children:["\u6700\u65b0\u7684\u53d8\u5316, \u53ef\u4ee5\u76f4\u63a5\u770b Linux \u7684git\u5f00\u53d1\u65e5\u5fd7: ",(0,l.jsx)(e.a,{href:"https://github.com/torvalds/linux/commits/master/include/linux/lsm_hook_defs.h",children:"https://github.com/torvalds/linux/commits/master/include/linux/lsm_hook_defs.h"})]}),"\n",(0,l.jsxs)(e.p,{children:["\u5386\u53f2\u7248\u672capi\u53d8\u5316\u5bf9\u6bd4, \u53ef\u4ee5\u53c2\u8003: ",(0,l.jsx)(e.a,{href:"https://depsurf.github.io/index/lsm.html",children:"https://depsurf.github.io/index/lsm.html"})]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u800c\u4e14\u5b83\u5df2\u7ecf\u6ee1\u8db3\u6211\u9700\u8981\u7684\u529f\u80fd:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u53ef\u4ee5 hook \u6587\u4ef6\u3001\u7f51\u7edc\u7684\u8bfb\u5199\u64cd\u4f5c"}),"\n",(0,l.jsx)(e.li,{children:"api \u6bd4\u8f83\u5bb9\u6613\u9002\u914d"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u7136\u540e\u662f\u4e3a\u4ec0\u4e48\u4e0d\u9009\u62e9\u5176\u4ed6\u7684:"}),"\n",(0,l.jsxs)(e.p,{children:["\u5bf9\u4e8e[1]\u7528\u6237\u6001\u52a8\u6001\u5e93\u62e6\u622a, \u5b83\u975e\u5e38\u7684\u4e0d\u7a33\u5b9a; \u5982\u679c ",(0,l.jsx)(e.code,{children:"LD_PRELOAD"})," \u73af\u5883\u53d8\u91cf\u88ab\u7981\u7528\u5c31\u65e0\u6548\u4e86; pass"]}),"\n",(0,l.jsxs)(e.p,{children:["\u5bf9\u4e8e[2]\u5185\u6838\u6001\u7cfb\u7edf\u8c03\u7528\u62e6\u622a, \u9700\u8981\u627e\u5230\u5185\u6838\u8fd0\u884c\u65f6\u7684 ",(0,l.jsx)(e.code,{children:"sys_call_table"})," \u51fd\u6570\u6307\u9488\u6570\u7ec4, \u7136\u540e\u60f3\u529e\u6cd5\u4fee\u6539\u6211\u4eec\u9700\u8981\u7684\u90a3\u4e2a\u51fd\u6570\u7684\u51fd\u6570\u6307\u9488; \u5e76\u4e14\u9700\u8981\u5904\u7406 x86/arm\u3001 64/32 \u4e0a\u7684\u4e00\u4e9b\u5dee\u5f02\u95ee\u9898; \u800c\u4e14\u52ab\u6301\u7684\u4fe1\u606f\u91cf\u592a\u5c11\u4e86, \u4e0d\u80fd\u83b7\u53d6 ",(0,l.jsx)(e.code,{children:"struct file"})," \u7ed3\u6784\u4f53\uff0c\u4e0d\u80fd\u83b7\u53d6\u6587\u4ef6\u7684",(0,l.jsx)(e.code,{children:"\u7edd\u5bf9\u8def\u5f84"}),"\u7b49; \u5b8c\u5168\u4e0d\u6ee1\u8db3\u6211\u4eec\u4e4b\u524d\u7684\u9700\u6c42. pass"]}),"\n",(0,l.jsx)(e.p,{children:"\u5bf9\u4e8e[3]\u5806\u6808\u5f0f\u6587\u4ef6\u7cfb\u7edf\u62e6\u622a, \u4e2a\u4eba\u8ba4\u4e3a\u8fd9\u4e2a\u592a\u590d\u6742\u4e86, \u770b\u522b\u4eba\u5b9e\u73b0\u7684\u7b80\u6613demo\u90fd\u662f1300\u884c\u7684; \u800c\u4e14\u4f9d\u8d56\u4e8eMount, \u53ef\u80fd\u9700\u8981\u91cd\u542f\u7cfb\u7edf\u624d\u80fd\u751f\u6548; \u6240\u6709pass\u6389, \u56e0\u4e3a\u6709\u66f4\u597d\u7684\u9009\u62e9"}),"\n",(0,l.jsx)(e.p,{children:"\u5bf9\u4e8e[4]inline hook\u62e6\u622a, \u5b83\u867d\u7136\u4f3c\u4e4e\u662f\u4e07\u80fd\u7684, \u4f46\u662f\u6709\u4e24\u4e2a\u96be\u70b9:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u627ehook\u70b9, \u4e00\u822c\u662f\u9700\u8981\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u6709\u4e00\u5b9a\u4e86\u89e3\u7684, \u624d\u53ef\u4ee5\u627e\u5230hook\u70b9 (\u77e5\u9053\u8c03\u7528\u94fe\u8def, \u77e5\u9053\u5e94\u8be5hook\u8c01), \u53c8\u56e0\u4e3a\u5b83hook\u7684\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u90e8\u7684\u79c1\u6709\u51fd\u6570, \u6240\u4ee5\u53ef\u80fd\u4f1a\u56e0\u4e3a\u7cfb\u7edf\u66f4\u65b0\u3001\u4e0d\u540c\u53d1\u884c\u7248\u7684\u5dee\u5f02, \u5bfc\u81f4\u63a5\u53e3\u5bf9\u4e0d\u4e0a, \u6bd4\u8f83\u96be\u9002\u914d\u5404\u4e2a\u53d1\u884c\u7248;"}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u6ce8\u5165hook\u51fd\u6570\u7684\u5165\u53e3, \u89e3\u51b3\u65b9\u6848\u90fd\u662f\u6bd4\u8f83\u96be\u9002\u914d\u5404\u4e2a\u53d1\u884c\u7248\u7684;"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\u5bf9\u4e8e[6]eBPF Hook\u62e6\u622a, \u5b83\u5f88\u5f3a\u5927, \u4f46\u662f\u53ef\u80fd\u8fc7\u4e8e\u65b0\u4e86, \u8981\u6c42\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838 \u9700\u8981 5.7 \u4ee5\u4e0a\u7684\u7248\u672c; \u800c\u4e14\u5c31\u7b97\u662f\u652f\u6301, \u4e5f\u4e0d\u4e00\u5b9a\u662f\u9ed8\u8ba4\u5f00\u542f\u7684, \u9700\u8981\u81ea\u5df1\u8bbe\u7f6e\u5f00\u542f;  \u5c31\u6bd4\u5982:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"kylin@tq:~/hx$ lsb_release -a\nNo LSB modules are available.\nDistributor ID:\tKylin\nDescription:\tKylin V10 SP1\nRelease:\tv10\nCodename:\tkylin\n\nkylin@tq:~/hx$ uname -a\nLinux tq 5.10.0-8-generic #33~v10pro-KYLINOS SMP Wed Mar 22 07:21:49 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u4ee5\u53ca\u6559\u7a0b\u4f7f\u7528\u7684 \u4e4c\u73ed\u56fe-22.04 \u4e5f\u662f\u9ed8\u8ba4\u4e0d\u5f00\u542f\u7684; \u53ef\u89c1\u652f\u6301\u6bd4\u8f83\u9ebb\u70e6, \u65e5\u540e\u53ef\u4ee5\u4f5c\u4e3a\u53ef\u9009\u7ec4\u4ef6\u52a0\u4e0a, \u4f46\u662f\u521d\u6b65\u5f00\u53d1\u5c31\u5148 pass"}),"\n",(0,l.jsx)(e.h4,{id:"32-\u5176\u4ed6\u7ec6\u8282",children:"3.2 \u5176\u4ed6\u7ec6\u8282"}),"\n",(0,l.jsx)(e.h5,{id:"321-\u5982\u4f55\u83b7\u53d6-\u88abhook\u7684\u64cd\u4f5c\u7684\u6267\u884c-\u8fdb\u7a0bpid",children:"3.2.1 \u5982\u4f55\u83b7\u53d6 \u88abhook\u7684\u64cd\u4f5c\u7684\u6267\u884c \u8fdb\u7a0bpid"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/farsight_2098/article/details/130875915",children:"https://blog.csdn.net/farsight_2098/article/details/130875915"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"// \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u7ec4ID\u548c\u8fdb\u7a0bID\npid_t current_pid = task_tgid_vnr(current);\n// \u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u540d\u79f0\nchar * current_process_name = (char*)get_task_comm(current);\n"})}),"\n",(0,l.jsx)(e.p,{children:"\u6216\u8005\u662f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:'// Linux LSM(Linux Security Modules) Hook Technology\n// https://www.cnblogs.com/LittleHann/p/4134939.html\nint execve_lsm_hook(struct linux_binprm* bprm) {\n    struct cred* currentCred;\n\n    if (bprm->filename) {\n        printk("file: %s\\n", bprm->filename);\n        //printk("file argument: %s\\n",bprm->p);\n    } else {\n        printk("file exec\\n");\n    } \n    \n    currentCred = current->cred;    \n    printk(KERN_INFO "uid = %d\\n", currentCred->uid);\n    printk(KERN_INFO "gid = %d\\n", currentCred->gid);\n    printk(KERN_INFO "suid = %d\\n", currentCred->suid);\n    printk(KERN_INFO "sgid = %d\\n", currentCred->sgid);\n    printk(KERN_INFO "euid = %d\\n", currentCred->euid);\n    printk(KERN_INFO "egid = %d\\n", currentCred->egid);  \n\n    printk("comm: %s\\n", current->comm);\n    return 0;\n} \n'})}),"\n",(0,l.jsx)(e.h4,{id:"322-\u83b7\u53d6\u8fdb\u7a0b\u7684\u7edd\u5bf9\u542f\u52a8\u8def\u5f84",children:"3.2.2 \u83b7\u53d6\u8fdb\u7a0b\u7684\u7edd\u5bf9\u542f\u52a8\u8def\u5f84"}),"\n",(0,l.jsxs)(e.div,{className:"markdown-alert markdown-alert-note",children:["\n",(0,l.jsxs)(e.p,{className:"markdown-alert-title",children:[(0,l.jsx)(e.span,{className:"octicon octicon-note",style:{"--oct-icon":"url(\"data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-info mr-2' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true'%3E%3Cpath d='M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'%3E%3C/path%3E%3C/svg%3E\")"}}),"Note"]}),"\n",(0,l.jsx)(e.p,{children:"\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7684, \u83b7\u53d6\u5176inode, \u4ee5\u9632\u6b62\u7a0b\u5e8f\u91cd\u547d\u540d\u4e86\u5e26\u6765\u7684\u95ee\u9898?"}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://blog.51cto.com/u_15803983/9231946",children:"[linux c/c++] \u901a\u8fc7\u8bfb\u53d6 /proc \u8def\u5f84\u83b7\u53d6\u6307\u5b9a\u8fdb\u7a0b\u540d\u7684\u4fe1\u606f"})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.a,{href:"https://blog.csdn.net/qq_22613757/article/details/88828424",children:"Linux C\u8bed\u8a00 \u83b7\u53d6\u53ef\u6267\u884c\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84\u3001\u8fdb\u7a0b\u8fd0\u884c\u76ee\u5f55\u3010cwd\u3011"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-cpp",children:"#include <stdio.h>\n#include <unistd.h>\nchar * get_exe_path( char * buf, int count) {\n    int i;\n    int rslt = readlink(\"/proc/self/cwd\", buf, count - 1);\n    if (rslt < 0 || (rslt >= count - 1)) {\n        return NULL;\n    }\n    buf[rslt] = '\\0';\n    for (i = rslt; i >= 0; i--) {\n        printf(\"buf[%d] %c\\n\", i, buf[i]);\n        if (buf[i] == '/') {\n            buf[i + 1] = '\\0';\n            break;\n        }\n    }\n    return buf;\n}\n\nint main(int argc, char ** argv) {\n    char path[1024];\n    printf(\"%s\\n\", get_exe_path(path, 1024));\n    return 0;\n}\n"})})]})}function a(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(h,{...n})}):h(n)}}}]);